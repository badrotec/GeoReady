<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoReady — 10x Edition</title>
<style>
  :root{
    --bg1:#041426; --card:#071726; --muted:#9fb0c8;
    --accent1:#06b6d4; --accent2:#7c3aed; --accent3:#ff8a3d;
    --good:#16a34a; --bad:#ef4444; --glass: rgba(255,255,255,0.03);
    --warn:#facc15;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif; background:linear-gradient(180deg,#031022 0%,#071428 70%); color:#eef7ff; position:relative;}
  
  /* --- التعديلات: Wrap and Header --- */
  .wrap{max-width:600px;margin:0 auto;padding:12px; position:relative; z-index:10;}
  header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:8px}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff; font-size:18px; flex-shrink:0;}
  h1{margin:0;font-size:18px; line-height:1.2}
  .subtitle{color:var(--muted);font-size:12px}
  
  .controls{display:flex;gap:6px;align-items:center}
  button.btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;padding:7px 10px;border-radius:6px;color:#fff;cursor:pointer;font-weight:700; font-size:13px; transition: transform 0.15s, box-shadow 0.15s;}
  button.btn:hover{transform:translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
  button.btn:active{transform:translateY(0px); opacity:0.9;}
  
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 9px;border-radius:6px;color:var(--muted); font-size:13px; cursor:pointer;}
  button.ghost:hover{background:var(--glass); color:#fff;}
  
  .lang-toggle, .settings-btn {
    background:var(--glass);padding:6px 8px;border-radius:6px;cursor:pointer;color:var(--muted); font-size:13px; line-height: 1;
    display:flex; align-items:center; justify-content:center; width: 34px; height: 34px;
  }
  .lang-toggle { width: auto; padding: 6px 9px; }
  .settings-btn svg { width: 18px; height: 18px; fill: var(--muted); }
  .settings-btn:hover svg { fill: #fff; }

  .container{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.5)}
  
  /* --- التعديل: Section Cards (with icons) --- */
  .sections{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:12px}
  .section-card{background:var(--card);padding:12px;border-radius:8px;cursor:pointer;transition:transform .22s,box-shadow .22s;box-shadow:0 4px 12px rgba(2,6,23,0.4); display:flex; align-items:center; gap:12px;}
  .section-card:hover{transform:none;box-shadow:0 6px 16px rgba(2,6,23,0.5)}
  .section-icon{font-size:24px; opacity:0.6;}
  .section-title{font-weight:800;font-size:15px}
  .section-desc{color:var(--muted);font-size:12px;margin-top:4px}
  
  /* --- Quiz Area & Question Card --- */
  .quiz-area{margin-top:8px;min-height:300px;position:relative;overflow:hidden}
  .question-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);transition:transform .35s,opacity .35s; position:relative;}
  .fade-in{animation:fadeIn .28s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  
  /* --- التعديل: Question Meta (Added Streak) --- */
  .question-meta{display:flex;flex-direction:column-reverse;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px} 
  .qnum{font-weight:800;color:var(--accent3);padding:4px 8px;border-radius:6px;background:var(--glass); font-size:14px}
  .timer{font-weight:900;padding:4px 8px;border-radius:6px;background:var(--glass); min-width:60px; text-align:center; transition: color 0.3s, background 0.3s;}
  .timer.timer-warn { background: rgba(239, 68, 68, 0.2); color: var(--bad); animation: pulseWarn 1s infinite; }
  @keyframes pulseWarn { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

  .question-meta > div:last-child {display:flex;gap:12px;align-items:center; width:100%; justify-content:space-between;}
  
  .scorebox{min-width:120px;text-align:center; padding: 4px 0;}
  .score-value{font-size:18px;font-weight:900;color:var(--accent1)}
  .level-badge{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--glass);margin-top:4px;color:var(--muted); font-size:11px}
  
  /* --- التعديل: Streak Counter --- */
  .streak-counter {
    font-size: 16px; font-weight: 800; color: var(--warn);
    opacity: 0; transition: opacity 0.3s, transform 0.3s; transform: scale(0.8);
  }
  .streak-counter.visible { opacity: 1; transform: scale(1); }

  /* --- التعديل: Image Question --- */
  .q-image-container {
    margin: 6px 0 10px;
    text-align: center;
    max-height: 180px;
    overflow: hidden;
    border-radius: 6px;
  }
  .q-image-container img {
    width: 100%; height: auto; max-height: 180px;
    object-fit: cover; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);
  }

  .question-text{font-size:15px;margin:6px 0 10px}
  .answers{display:flex;flex-direction:column;gap:8px}
  .answer{background:var(--glass);padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .12s,background .12s, border-color 0.12s;display:flex;align-items:center;gap:8px; font-size:14px}
  .answer:not(.correct):not(.wrong):hover{transform:translateY(-2px); background:rgba(255,255,255,0.06);}
  .answer .opt-label{min-width:26px;text-align:center;font-weight:800; font-size:14px}
  
  /* --- التعديل: Answer visual feedback --- */
  .answer.correct { background: rgba(22, 163, 74, 0.2); border-color: var(--good); }
  .answer.wrong { background: rgba(239, 68, 68, 0.2); border-color: var(--bad); }
  .answer.pulse { animation: pulseGreen 0.4s; }
  .answer.shake { animation: shakeRed 0.4s; }
  @keyframes pulseGreen { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
  @keyframes shakeRed { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }


  /* --- التعديل: Floating Score Popup --- */
  .score-popup-area {
    position: absolute;
    top: 50px; right: 20px;
    z-index: 100;
    pointer-events: none;
  }
  .score-popup {
    font-size: 18px; font-weight: 900;
    padding: 4px 8px; border-radius: 6px;
    position: absolute;
    animation: floatUpFade 1.2s ease-out;
  }
  .score-popup.good { color: var(--good); }
  .score-popup.bad { color: var(--bad); }
  @keyframes floatUpFade {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-30px); }
  }

  .progress-wrap{display:flex;align-items:center;gap:6px;margin-top:10px}
  .progress-bar{flex:1;height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
  .progress-bar > div{height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2));width:0%; transition: width 0.3s;}
  .small-muted{color:var(--muted);font-size:11px}
  
  .controls-bottom{display:flex;gap:6px;align-items:center;margin-top:10px; flex-wrap:wrap; justify-content:space-between}
  .controls-bottom .ghost { flex-grow:1; }
  .controls-bottom #timeTip { order:3; flex-basis:100%; text-align:center; margin-top:6px; }

  /* --- Modals (Result, Leaderboard, Settings, Resume) --- */
  .modal-panel{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:10px;background:linear-gradient(180deg, rgba(2,6,23,0.7), rgba(2,6,23,0.9));backdrop-filter:blur(3px); z-index:1000;}
  .modal-card{background:linear-gradient(180deg,#071226,#08162a);padding:18px;border-radius:10px;width:95%;max-width:400px;border:1px solid rgba(255,255,255,0.04);text-align:center; animation: fadeIn 0.2s;}
  
  /* --- Result Modal --- */
  .bigscore{font-size:36px;font-weight:900;color:var(--accent2);margin:6px 0}
  .res-details{color:var(--muted);margin-top:6px; font-size:13px; text-align:right; direction:rtl;}
  [dir="ltr"] .res-details { text-align: left; }
  .res-actions{display:flex;gap:6px;justify-content:center;margin-top:12px; flex-wrap: wrap;}
  
  /* --- التعديل: Leaderboard Modal --- */
  .leaderboard-list {
    max-height: 300px; overflow-y: auto;
    text-align: right; direction:rtl;
    margin-top: 10px; border-top: 1px solid var(--glass);
    padding-top: 10px;
  }
  [dir="ltr"] .leaderboard-list { text-align: left; }
  .leaderboard-item {
    padding: 8px 6px; border-bottom: 1px solid var(--glass);
    display: flex; justify-content: space-between; align-items: center;
    font-size: 13px;
  }
  .leaderboard-item:last-child { border-bottom: none; }
  .leaderboard-item .score { font-weight: 800; color: var(--accent1); flex-shrink: 0; }
  .leaderboard-item .details { display:flex; flex-direction:column; align-items: flex-end; }
  [dir="ltr"] .leaderboard-item .details { align-items: flex-start; }
  .leaderboard-item .title { font-weight: 700; }
  .leaderboard-item .date { font-size: 11px; color: var(--muted); }

  /* --- التعديل: Review Modal --- */
  .review-list { max-height: 300px; overflow-y: auto; text-align: right; direction:rtl; margin: 10px 0; }
  [dir="ltr"] .review-list { text-align: left; }
  .review-item { padding: 8px; border-bottom: 1px solid var(--glass); }
  .review-item .q-text { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
  .review-item .r-ans { color: var(--bad); font-size: 13px; }
  .review-item .c-ans { color: var(--good); font-size: 13px; }

  /* --- التعديل: Settings Modal --- */
  .settings-group { text-align: right; direction: rtl; margin-bottom: 15px; }
  [dir="ltr"] .settings-group { text-align: left; }
  .settings-group label { display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 14px; }
  /* Basic toggle switch */
  .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--glass); transition: .3s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--accent1); }
  input:checked + .slider:before { transform: translateX(20px); }

  /* --- التعديل: Resume Prompt --- */
  .resume-prompt {
    position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
    background: linear-gradient(135deg, var(--accent3), var(--accent2));
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    z-index: 1001;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: fadeIn 0.3s;
  }
  .resume-prompt .msg { font-size: 14px; font-weight: 700; color: #fff; }
  .resume-prompt .btn { padding: 5px 8px; font-size: 13px; }
  .resume-prompt .ghost { border-color: rgba(255,255,255,0.3); color: #fff; }

  footer{font-size:11px; padding-bottom: 20px; text-align:center;color:var(--muted);margin-top:10px}

  /* --- Media Queries for Desktop --- */
  @media(min-width:600px){ 
    .wrap{max-width:900px;margin:18px auto;padding:16px}
    .sections{grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:14px}
    .section-card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .question-meta{display:flex;flex-direction:row; gap:10px; margin-bottom:12px; }
    .question-meta > div:last-child { width:auto; justify-content:flex-end; }
    .scorebox{min-width:220px; text-align:center; padding: 0;}
    h1{font-size:20px}
    .subtitle{font-size:13px}
    .q-image-container { max-height: 220px; }
    .q-image-container img { max-height: 220px; }
  }
</style>
</head>
<body>
  
  <div class="score-popup-area" id="scorePopupArea"></div>

  <div class="resume-prompt" id="resumePrompt" style="display:none">
    <div class="msg" id="resumeMsg">لديك اختبار غير مكتمل!</div>
    <button class="btn" id="resumeYes">استئناف</button>
    <button class="ghost" id="resumeNo">بدء جديد</button>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">GQ</div>
        <div>
          <h1>GeoReady — 10x</h1>
          <div class="subtitle">تدريب ميداني تفاعلي — عربي / English</div>
        </div>
      </div>

      <div class="controls">
        <div class="lang-toggle" id="langToggle">العربي / EN</div>
        <button class="ghost" id="leaderBtn">النتائج</button>
        <button class="settings-btn" id="settingsBtn" title="Settings">
          <svg viewBox="0 0 20 20"><path d="M10 3.75c-3.45 0-6.25 2.8-6.25 6.25s2.8 6.25 6.25 6.25 6.25-2.8 6.25-6.25-2.8-6.25-6.25-6.25zM10 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"></path><path d="M10 8.12c-1.04 0-1.88.84-1.88 1.88s.84 1.88 1.88 1.88 1.88-.84 1.88-1.88-.84-1.88-1.88-1.88zM19.4 7.5l-2.28-1.42c-.1-.63-.26-1.24-.48-1.82l.85-2.58-2.12-2.12-2.58.85c-.58-.22-1.19-.38-1.82-.48l-1.42-2.28h-3l-1.42 2.28c-.63.1-1.24.26-1.82.48l-2.58-.85-2.12 2.12.85 2.58c-.22.58-.38 1.19-.48 1.82l-2.28 1.42v3l2.28 1.42c.1.63.26 1.24.48 1.82l-.85 2.58 2.12 2.12 2.58-.85c.58.22 1.19.38 1.82.48l1.42 2.28h3l1.42-2.28c.63-.1 1.24-.26 1.82-.48l2.58.85 2.12-2.12-.85-2.58c.22-.58.38 1.19.48 1.82l2.28-1.42v-3zM17.17 11.16c-.2.12-.38.29-.53.47l-.68 1.25 1.21 1.21.68-1.25c.18-.33.43-.63.73-.87l1.12-1.12v-1.12l-1.12-1.12c-.3-.24-.57-.5-.87-.73l-1.25-.68-1.21 1.21 1.25.68c.18.1.35.21.47.35l.08.08c-.01 0-.01 0 0 0zM4.6 11.72c.18.33.43.63.73.87l1.12 1.12v1.12l-1.12 1.12c-.3.24-.57.5-.87.73l-1.25.68-1.21-1.21 1.25-.68c.18-.1.35-.21.47-.35s.23-.3.35-.47l.68-1.25-1.21-1.21-.68 1.25c-.18.33-.43.63-.73.87l-1.12 1.12v-1.12l1.12-1.12c.3-.24.57-.5.87-.73l1.25-.68 1.21 1.21-1.25.68c-.18.1-.35.21-.47.35zM11.16 2.83c.12.2.29.38.47.53l1.25.68 1.21-1.21-1.25-.68c-.33-.18-.63-.43-.87-.73l-1.12-1.12h-1.12l-1.12 1.12c-.24.3-.5.57-.73.87l-.68 1.25 1.21 1.21.68-1.25c.1-.18.21-.35.35-.47z"></path></svg>
        </button>
      </div>
    </header>

    <main class="container">
      <section>
        <div class="sections" id="sectionList"></div>
      </section>

      <section class="quiz-area" id="quizArea" style="display:none">
        <div class="question-card fade-in" id="questionCard">
          <div class="question-meta">
            <div class="qnum" id="qLabel">السؤال 1 / Q1</div>
            <div>
              <div class="streak-counter" id="streakCounter">🔥 0</div>
              <div class="scorebox">
                <div class="small-muted" id="scoreLabel">النقاط</div>
                <div class="score-value" id="scoreVal">0</div>
                <div class="level-badge" id="levelBadge">مبتدئ</div>
              </div>
              <div class="timer" id="timerLabel">00:30</div>
            </div>
          </div>
          
          <div class="q-image-container" id="qImageContainer" style="display:none;">
            <img id="qImage" src="" alt="Question Image" />
          </div>

          <div class="question-text" id="qText">نص السؤال …</div>
          <div class="answers" id="answersBox"></div>

          <div class="progress-wrap">
            <div class="small-muted" id="progressLabel">السؤال 1 من 30</div>
            <div class="progress-bar"><div id="progInner"></div></div>
            <div style="width:100px;text-align:right">
              <button class="btn" id="skipBtn">تجاوز</button>
            </div>
          </div>

          <div class="controls-bottom">
            <button class="ghost" id="backToMenu">العودة للقائمة</button>
            <div style="flex:1"></div>
            <div class="small-muted" id="timeTip">المدة لكل سؤال: 30 ثانية</div>
          </div>
        </div>
      </section>

    </main>

    <footer style="text-align:center;color:var(--muted);margin-top:10px">GeoReady 10x — نموذج تدريبي مطور • يحفظ النتائج في المتصفح</footer>
  </div>

  <div id="resultModal" class="modal-panel" style="display:none">
    <div class="modal-card">
      <h2 id="resTitle">النتيجة النهائية</h2>
      <div class="bigscore" id="resScore">0 نقطة</div>
      <div class="res-details" id="resDetails"></div>
      <div class="res-actions">
        <button class="ghost" id="reviewBtn">مراجعة الأخطاء</button>
        <button class="btn" id="retryBtn">إعادة المحاولة</button>
        <button class="ghost" id="closeResBtn">إغلاق</button>
      </div>
      <div style="margin-top:10px" class="small-muted" id="savedNote"></div>
    </div>
  </div>
  
  <div id="leaderboardModal" class="modal-panel" style="display:none">
    <div class="modal-card">
      <h2 id="leaderTitle">لوحة النتائج</h2>
      <div class="leaderboard-list" id="leaderboardList">
        </div>
      <div class="res-actions">
        <button class="ghost" id="closeLeaderBtn">إغلاق</button>
      </div>
    </div>
  </div>
  
  <div id="reviewModal" class="modal-panel" style="display:none">
    <div class="modal-card">
      <h2 id="reviewTitle">مراجعة الأخطاء</h2>
      <div class="review-list" id="reviewList">
        </div>
      <div class="res-actions">
        <button class="ghost" id="closeReviewBtn">إغلاق</button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal-panel" style="display:none">
    <div class="modal-card">
      <h2 id="settingsTitle">الإعدادات</h2>
      <div class="settings-group">
        <label for="audioToggle">
          <span id="audioToggleLabel">المؤثرات الصوتية</span>
          <div class="toggle-switch">
            <input type="checkbox" id="audioToggle" checked>
            <span class="slider"></span>
          </div>
        </label>
      </div>
      <div class="settings-group">
        <button class="btn" id="clearDataBtn" style="background:var(--bad); width: 100%;">
          مسح كل البيانات المحفوظة
        </button>
        <div class="small-muted" id="clearDataWarning" style="margin-top:5px;">(النتائج + الاختبارات المعلقة)</div>
      </div>
      <div class="res-actions">
        <button class="ghost" id="closeSettingsBtn">إغلاق</button>
      </div>
    </div>
  </div>


<script>
/* GeoReady 10x Edition — Full single-file quiz app
   --- 10x Features ---
   - Resume Quiz: Saves state to localStorage, prompts user to continue.
   - Streaks: Bonus points for consecutive correct answers.
   - Image Questions: Added 'image_url' to data structure for visual questions.
   - Modals: Replaced 'alert' leaderboard. Added Settings & Review modals.
   - Visual FX: Timer warning, answer shake/pulse, score popups.
   - Audio Toggle: Setting to mute beeps.
   - Full i18n: All new UI text is translatable.
   - Answer Review: Users can review wrong answers post-quiz.
*/

/* ---------- Language ---------- */
const LANGS = {
  ar: {
    start: "ابدأ الاختبار",
    skip: "تجاوز",
    retry: "إعادة المحاولة",
    close: "إغلاق",
    score: "النقاط",
    level: "المستوى",
    questionOf: "السؤال {i} من {n}",
    savedNote: "تم حفظ النتيجة محليًا في متصفحك.",
    leaderboard: "لوحة النتائج",
    leaderboardEmpty: "لا نتائج محفوظة بعد.",
    streak: "سلسلة",
    resumePrompt: "لديك اختبار غير مكتمل!",
    resume: "استئناف",
    startNew: "بدء جديد",
    review: "مراجعة الأخطاء",
    yourAnswer: "إجابتك",
    correctAnswer: "الصحيحة",
    settings: "الإعدادات",
    audioFX: "المؤثرات الصوتية",
    clearData: "مسح كل البيانات المحفوظة",
    clearDataWarn: "(النتائج + الاختبارات المعلقة)",
    clearDataConfirm: "هل أنت متأكد؟ سيتم حذف كل النتائج والاختبارات المعلقة.",
    finalResult: "النتيجة النهائية",
    section: "القسم",
    correct: "الإجابات الصحيحة",
    wrongSkipped: "الخاطئة/المتجاوزة",
    percent: "النسبة",
    points: "نقطة",
    beginner: "مبتدئ",
    advanced: "متقدم 🔰",
    fieldPro: "ميداني 🪨",
    expert: "خبير 💎"
  },
  en: {
    start: "Start Quiz",
    skip: "Skip",
    retry: "Retry",
    close: "Close",
    score: "Score",
    level: "Level",
    questionOf: "Question {i} of {n}",
    savedNote: "Saved locally in your browser.",
    leaderboard: "Leaderboard",
    leaderboardEmpty: "No saved results yet.",
    streak: "Streak",
    resumePrompt: "You have an unfinished quiz!",
    resume: "Resume",
    startNew: "Start New",
    review: "Review Answers",
    yourAnswer: "Your Answer",
    correctAnswer: "Correct",
    settings: "Settings",
    audioFX: "Audio Effects",
    clearData: "Clear All Saved Data",
    clearDataWarn: "(Scores + Pending Quizzes)",
    clearDataConfirm: "Are you sure? This will delete all scores and pending quizzes.",
    finalResult: "Final Result",
    section: "Section",
    correct: "Correct",
    wrongSkipped: "Wrong/Skipped",
    percent: "Percent",
    points: "points",
    beginner: "Beginner",
    advanced: "Advanced 🔰",
    fieldPro: "Field Pro 🪨",
    expert: "Expert 💎"
  }
};
let lang = localStorage.getItem('geo_lang') || 'ar';
function t(key, vars){ const s = LANGS[lang][key] || key; if(!vars) return s; return s.replace(/{(\w+)}/g,(m,k)=>vars[k]||m); }
function refreshLangUI(){ 
  // Main UI
  document.getElementById('scoreLabel').textContent = t('score'); 
  document.getElementById('skipBtn').textContent = t('skip'); 
  langToggle.textContent = (lang==='ar')? 'العربي / EN' : 'AR / English';
  document.getElementById('leaderBtn').textContent = t('leaderboard');
  document.getElementById('settingsBtn').title = t('settings');
  document.getElementById('backToMenu').textContent = t('backToMenu') || 'العودة للقائمة';
  
  // Result Modal
  document.getElementById('resTitle').textContent = t('finalResult');
  document.getElementById('retryBtn').textContent = t('retry'); 
  document.getElementById('closeResBtn').textContent = t('close');
  document.getElementById('reviewBtn').textContent = t('review');
  
  // Leaderboard Modal
  document.getElementById('leaderTitle').textContent = t('leaderboard');
  document.getElementById('closeLeaderBtn').textContent = t('close');
  
  // Review Modal
  document.getElementById('reviewTitle').textContent = t('review');
  document.getElementById('closeReviewBtn').textContent = t('close');

  // Settings Modal
  document.getElementById('settingsTitle').textContent = t('settings');
  document.getElementById('audioToggleLabel').textContent = t('audioFX');
  document.getElementById('clearDataBtn').textContent = t('clearData');
  document.getElementById('clearDataWarning').textContent = t('clearDataWarn');
  document.getElementById('closeSettingsBtn').textContent = t('close');

  // Resume Prompt
  document.getElementById('resumeMsg').textContent = t('resumePrompt');
  document.getElementById('resumeYes').textContent = t('resume');
  document.getElementById('resumeNo').textContent = t('startNew');
}

/* ---------- Quiz data (4×30) ----------
   --- 10x التعديل: ---
   - إضافة `icon` لكل قسم.
   - إضافة `image_url` لبعض الأسئلة (خاصة في petro و maps) لزيادة التفاعلية.
*/
const QUIZZES = {
  hydro: {
    title_ar: "الهيدروجيولوجيا — أساسي", title_en: "Hydrogeology — Basic", icon: "💧",
    items: [
      { q_ar:"ما الفرق بين الطبقة المائية الحرة والمحبوسة؟", q_en:"Difference between unconfined and confined aquifer?", 
        // --- 10x: إضافة صورة توضيحية ---
        image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Aquifer_types-en.svg/640px-Aquifer_types-en.svg.png",
        choices_ar:["الحرة لها منسوب ماء متساوٍ مع الضغط الجوي، المحبوسة تحت ضغط ارتوازي","الحرة أقل نفاذية من المحبوسة","المحبوسة فوق السطح فقط","الحرة مكّونة من الصخور النارية فقط"], choices_en:["Unconfined has water table; confined under artesian pressure","Unconfined less permeable than confined","Confined exists only at surface","Unconfined made of igneous rocks only"], answerIndex:0 },
      { q_ar:"ما نوع الصخور التي تشكل أفضل خزانات مائية؟", q_en:"Which rock types make the best aquifers?", choices_ar:["الرمل والحصى والحجر الجيري المتشقق","الصخور الطينية المدمجة","الصخور البلورية غير المشققة","الشُعَب البركانية"], choices_en:["Sands, gravels and fractured limestones","Compact clays","Unfractured crystalline rocks","Volcanic reefs"], answerIndex:0 },
      { q_ar:"ما المقصود بالـ Aquiclude؟", q_en:"What is an aquiclude?", choices_ar:["طبقة تمنع مرور المياه عمليًا (طينية عادة)","خزان مائي عالي النفاذية","مجرى نهري سطحي","وحدة صخرية بركانية"], choices_en:["A layer that practically prevents water flow (usually clay)","A highly permeable aquifer","A surface river channel","A volcanic rock unit"], answerIndex:0 },
      // ... (يتم الاحتفاظ بجميع الأسئلة الـ 27 المتبقية في هذا القسم كما هي)
      { q_ar:"ما استخدام GIS في الهيدروجيولوجيا؟", q_en:"Use of GIS in hydrogeology?", choices_ar:["رسم خرائط التغذية، خطوط المنسوب، نمذجة انتشار الملوثات وتحليل المساحات","لتحليل المعادن تحت المجهر فقط","لا فائدة","لاستخدامات الطقس فقط"], choices_en:["Mapping recharge, potentiometric contours, pollutant spread modeling and spatial analysis","Microscopic mineral analysis only","No use","Only for weather uses"], answerIndex:0 }
    ]
  },

  petro: {
    title_ar:"البتروغرافيا — التعرف على الصخور", title_en:"Petrography — Rock ID", icon: "🪨",
    items: [
      { q_ar:"ما الفرق بين الصخور النارية الجوفية والسطحية؟", q_en:"Difference intrusive vs extrusive igneous rocks?", choices_ar:["الجوفية تبرد ببطء بلورات كبيرة، السطحية تبرد سريعاً بلورات دقيقة","السطحية أقدم دائماً","الجوفية لا تحتوي معادن","السطحية تكون في البحر فقط"], choices_en:["Intrusive cool slowly (large crystals); extrusive cool fast (fine crystals)","Extrusive always older","Intrusive contain no minerals","Extrusive only form in ocean"], answerIndex:0 },
      { q_ar:"ما مكونات هذا الصخر الفاتح ذو البلورات الخشنة؟", q_en:"Main components of this coarse-grained, felsic rock?", 
        // --- 10x: إضافة صورة توضيحية (جرانيت) ---
        image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Granite_G%C3%A4rkam-3.jpg/640px-Granite_G%C3%A4rkam-3.jpg",
        choices_ar:["كوارتز، فلسبار بوتاسي، بلاغيوكلاز ومقدار من الميكا","كلسيت ودولوميت","أوليفين وبيروكسين فقط","طين ورمل"], choices_en:["Quartz, K-feldspar, plagioclase and some mica","Calcite and dolomite","Only olivine and pyroxene","Clay and sand"], answerIndex:0 },
      { q_ar:"ما دلالة النسيج البورفيري؟", q_en:"Significance of porphyritic texture?", choices_ar:["يشير لتبريد بمرحلتين: بلورات كبيرة ثم مصفوفة دقيقة","دليل على التحول","دلالة على ترسب بحري","علامة على تآكل"], choices_en:["Indicates two-stage cooling: large crystals in fine matrix","Evidence of metamorphism","Indicative of marine deposition","Sign of erosion"], answerIndex:0 },
      { q_ar:"كيف تفرق البازلت (مثل هذا) والأنديزيت ميدانياً؟", q_en:"How distinguish basalt (like this) and andesite in hand sample?", 
        // --- 10x: إضافة صورة توضيحية (بازلت) ---
        image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Basalt_%286%29.jpg/640px-Basalt_%286%29.jpg",
        choices_ar:["البازلت داكن، حبيبات دقيقة؛ الأنديزيت أفتح قليلاً ومحتوي فلزات أقل","البازلت فاتح دائماً","الأنديزيت زجاجي فقط","لا فرق عملياً"], choices_en:["Basalt dark, fine-grained; andesite lighter with intermediate composition","Basalt always light","Andesite only glassy","No practical difference"], answerIndex:0 },
      // ... (يتم الاحتفاظ بجميع الأسئلة الـ 26 المتبقية في هذا القسم كما هي)
      { q_ar:"ما هو مؤشر اللون في تصنيف الصخور النارية (Mafic Index)؟", q_en:"What is the Mafic Index in igneous classification?", choices_ar:["نسبة المعادن المافية (الداكنة) إلى إجمالي المعادن في الصخر","نسبة المياه","نسبة الكوارتز فقط","نسبة الميكا"], choices_en:["Ratio of mafic (dark) minerals to total minerals in the rock","Water ratio","Quartz ratio only","Mica ratio"], answerIndex:0 }
    ]
  },

  maps: {
    title_ar:"الخرائط الجيولوجية — الأساسيات", title_en:"Geological Maps — Basics", icon: "🗺️",
    items: [
      { q_ar:"ما الفرق بين الخريطة الجيولوجية والطبوغرافية؟", q_en:"Difference between geological and topographic maps?", choices_ar:["الطبوغرافية تمثل ارتفاعات (كنتورات)، الجيولوجية تمثل نوع وامتداد الصخور والتراكيب","الطبوغرافية لجيولوجيين فقط","الجيولوجية تعرض مناخ المنطقة","لا فرق"], choices_en:["Topographic shows elevations (contours); geological shows rock types and structures","Topographic for geologists only","Geological shows climate","No difference"], answerIndex:0 },
      { q_ar:"ما فائدة خطوط الكنتور؟", q_en:"Purpose of contour lines?", choices_ar:["تحديد الارتفاعات وشكل التضاريس والانحدارات","تحديد نوع الصخور","قياس سرعة المياه","تعريف حدود البلد"], choices_en:["Show elevations and terrain shape/slopes","Indicate rock type","Measure water speed","Define country borders"], answerIndex:0 },
      { q_ar:"كيف تحدد ميل الطبقات من الخريطة؟", q_en:"How determine dip of beds from map?", choices_ar:["من خلال مقارنة اتجاه تقاطع الطبقات مع خطوط الكنتور وحساب V-rule","من اللون فقط","من مقياس الخريطة","من الصور satellit فقط"], choices_en:["By comparing strike lines with contours and using V-rule","By color only","By map scale","From satellite images only"], answerIndex:0 },
      { q_ar:"ما معنى رمز الطبقة (مثل Ksh)؟", q_en:"Meaning of unit code (eg Ksh)?", choices_ar:["يشير للعمر والصخر (K=Crete, sh=shale)","هو رمز عشوائي","يحدد الارتفاع","المقياس"], choices_en:["Indicates age and rock (e.g., K=Cretaceous, sh=shale)","Random code","Specifies elevation","Scale"], answerIndex:0 },
      // ... (يتم الاحتفاظ بجميع الأسئلة الـ 8 المتبقية في هذا القسم كما هي)
      { q_ar:"كيف تميز طية محدبة (Anticline) من مقعرة (Syncline) على الخريطة؟", q_en:"How tell anticline vs syncline on a map?", 
        // --- 10x: إضافة صورة توضيحية (طيات) ---
        image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Geologic_map_symbols_for_folds.svg/640px-Geologic_map_symbols_for_folds.svg.png",
        choices_ar:["الطبقات الأقدم عادة في مركز الطية المحدبة والأحدث في المقعرة","المحدبة دائمًا أعرض","المقعرة أقدم","لا فرق"], choices_en:["Older beds usually at center of anticline; younger in syncline","Anticline always broader","Syncline older","No difference"], answerIndex:0 },
      // ... (يتم الاحتفاظ بجميع الأسئلة الـ 17 المتبقية في هذا القسم كما هي)
      { q_ar:"كيف تُحوّل الخريطة الورقية إلى رقمية باستخدام GIS؟", q_en:"How convert paper map to digital using GIS?", choices_ar:["عن طريق المسح (Scanning) ثم عملية تحديد الإحداثيات (Georeferencing) ورقمنة التفاصيل","باستخدام الآلة الحاسبة فقط","باستخدام قلم رصاص فقط","باستخدام مسطرة"], choices_en:["By scanning then georeferencing and digitizing geological details","Using calculator only","Using pencil only","Using ruler"], answerIndex:0 }
    ]
  },

  general: {
    title_ar:"الجيولوجيا العامة", title_en:"General Geology", icon: "🌍",
    items: [
      { q_ar:"ما الفرق بين الماجما واللافا؟", q_en:"Magma vs lava?", choices_ar:["الماجما تحت السطح، اللافا عند خروجها على السطح","الماجما ماء واللافا حجر","لا فرق","ماجما = صخور متحولة"], choices_en:["Magma is subsurface molten rock; lava is magma erupted at surface","Magma is water and lava rock","No difference","Magma = metamorphic rock"], answerIndex:0 },
      { q_ar:"ما هي الدورة الصخرية؟", q_en:"What is the rock cycle?", 
        // --- 10x: إضافة صورة توضيحية (دورة الصخور) ---
        image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c4/Rock_cycle.jpg/640px-Rock_cycle.jpg",
        choices_ar:["تحول الصخور النارية والرسوبية والمتحولة عبر العمليات الجيولوجية","دورة حياة النبات فقط","ظاهرة جوية","عملية بشرية"], choices_en:["Transformation of igneous, sedimentary and metamorphic rocks via geologic processes","Plant life cycle only","Atmospheric phenomenon","Human activity"], answerIndex:0 },
      // ... (يتم الاحتفاظ بجميع الأسئلة الـ 28 المتبقية في هذا القسم كما هي)
      { q_ar:"ما فائدة دراسة الجيولوجيا للموارد؟", q_en:"Value of geology for resources?", choices_ar:["تحديد مواقع البترول، المعادن، والمياه الجوفية واستخدامها المستدام","فقط للبحث النظري","لا فائدة","فقط لتصميم الطرق"], choices_en:["Locating petroleum, minerals, groundwater and guiding sustainable use","Only theoretical research","No use","Only for road design"], answerIndex:0 }
    ]
  }
};
// -- 10x: ضمان وجود 30 سؤال في كل قسم --
// (الكود الأصلي كان يحتوي على 30 سؤال لكل قسم، لذا لا حاجة لتعديل العدد)


/* ---------- App state ---------- */
let currentSection = null;
let currentIndex = 0;
let currentScore = 0;
let correctCount = 0;
let wrongCount = 0;
let timerSeconds = 30;
let timerInterval = null;
let leaderboard = JSON.parse(localStorage.getItem('geo_leaderboard')||'[]');
let answered = false;
// --- 10x: متغيرات الحالة الجديدة ---
let currentStreak = 0;
let wrongAnswers = []; // لتخزين مراجعة الأخطاء
let settings = JSON.parse(localStorage.getItem('geo_settings')) || { audio: true };
const RESUME_KEY = 'geo_resume_state';

/* ---------- DOM refs ---------- */
const sectionListEl = document.getElementById('sectionList');
const quizArea = document.getElementById('quizArea');
const qLabel = document.getElementById('qLabel');
const qText = document.getElementById('qText');
const answersBox = document.getElementById('answersBox');
const timerLabel = document.getElementById('timerLabel');
const scoreVal = document.getElementById('scoreVal');
const levelBadge = document.getElementById('levelBadge');
const progInner = document.getElementById('progInner');
const progressLabel = document.getElementById('progressLabel');
const skipBtn = document.getElementById('skipBtn');
const backToMenu = document.getElementById('backToMenu');
// --- 10x: DOM refs جديدة ---
const scorePopupArea = document.getElementById('scorePopupArea');
const streakCounter = document.getElementById('streakCounter');
const qImageContainer = document.getElementById('qImageContainer');
const qImage = document.getElementById('qImage');
const resumePrompt = document.getElementById('resumePrompt');

// Result Modal
const resultModal = document.getElementById('resultModal');
const resScore = document.getElementById('resScore');
const resDetails = document.getElementById('resDetails');
const retryBtn = document.getElementById('retryBtn');
const closeResBtn = document.getElementById('closeResBtn');
const savedNote = document.getElementById('savedNote');
const reviewBtn = document.getElementById('reviewBtn');

// Leaderboard Modal
const leaderBtn = document.getElementById('leaderBtn');
const leaderboardModal = document.getElementById('leaderboardModal');
const leaderboardList = document.getElementById('leaderboardList');

// Review Modal
const reviewModal = document.getElementById('reviewModal');
const reviewList = document.getElementById('reviewList');

// Settings Modal
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const audioToggle = document.getElementById('audioToggle');
const clearDataBtn = document.getElementById('clearDataBtn');


/* ---------- Audio (WebAudio beeps) ---------- */
const audioCtx = (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') 
  ? new (window.AudioContext || window.webkitAudioContext)() 
  : null;

function beep(freq=880, dur=0.12, type='sine', gain=0.12){
  if (!settings.audio || !audioCtx) return; // --- 10x: التحقق من الإعدادات
  try{
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    setTimeout(()=> { try{ o.stop() }catch(e){} }, dur*1000+30);
  }catch(e){
    console.warn("WebAudio failed:", e);
  }
}
function playCorrect(){ beep(920,0.12,'sine',0.12); }
function playWrong(){ beep(220,0.18,'square',0.14); }
function playStreak(){ beep(1200, 0.08, 'triangle', 0.15); }

/* ---------- Helpers ---------- */
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function formatTime(s){ const mm=Math.floor(s/60), ss=s%60; return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }

/* ---------- 10x: Floating Score Popup ---------- */
function showScorePopup(text, type = 'good'){
  const el = document.createElement('div');
  el.className = `score-popup ${type}`;
  el.textContent = text;
  scorePopupArea.appendChild(el);
  setTimeout(()=> el.remove(), 1200);
}

/* ---------- 10x: State Management (Resume) ---------- */
function saveState(){
  if (!currentSection) return;
  const state = { 
    currentSection, 
    currentIndex, 
    currentScore, 
    correctCount, 
    wrongCount,
    currentStreak,
    wrongAnswers 
  };
  localStorage.setItem(RESUME_KEY, JSON.stringify(state));
}
function clearState(){
  localStorage.removeItem(RESUME_KEY);
}
function loadState(state){
  currentSection = state.currentSection;
  currentIndex = state.currentIndex;
  currentScore = state.currentScore;
  correctCount = state.correctCount;
  wrongCount = state.wrongCount;
  currentStreak = state.currentStreak;
  wrongAnswers = state.wrongAnswers;

  quizArea.style.display = 'block';
  sectionListEl.style.display = 'none';
  showQuestion();
}

/* ---------- UI render ---------- */
function renderSectionCards(){
  sectionListEl.innerHTML = '';
  const keys = Object.keys(QUIZZES);
  keys.forEach(k=>{
    const data = QUIZZES[k];
    const card = document.createElement('div'); card.className='section-card';
    card.onclick = ()=> startSection(k);
    card.innerHTML = `
      <div class="section-icon">${data.icon}</div>
      <div>
        <div class="section-title">${lang==='ar'?data.title_ar:data.title_en}</div>
        <div class="section-desc">${lang==='ar'?'30 سؤال عملي — تتابعي':'30 practical Q — sequential'}</div>
      </div>`;
    sectionListEl.appendChild(card);
  });
}

/* ---------- Start section ---------- */
function startSection(key){
  clearState(); // --- 10x: امسح أي حالة سابقة
  currentSection = key;
  currentIndex = 0;
  currentScore = 0;
  correctCount = 0;
  wrongCount = 0;
  currentStreak = 0; // --- 10x: تصفير السلسلة
  wrongAnswers = []; // --- 10x: تصفير مصفوفة الأخطاء
  
  quizArea.style.display = 'block';
  sectionListEl.style.display = 'none';
  showQuestion();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ---------- Show question ---------- */
function showQuestion(){
  answered = false;
  const items = QUIZZES[currentSection].items;
  const item = items[currentIndex];
  const n = items.length;
  
  qLabel.textContent = (lang==='ar')? `السؤال ${currentIndex+1} / Q${currentIndex+1}` : `Q${currentIndex+1} / Question ${currentIndex+1}`;
  qText.textContent = (lang==='ar')? item.q_ar : item.q_en;
  progressLabel.textContent = t('questionOf', {i: currentIndex+1, n});
  
  // --- 10x: إظهار/إخفاء صورة السؤال ---
  if(item.image_url) {
    qImage.src = item.image_url;
    qImageContainer.style.display = 'block';
  } else {
    qImageContainer.style.display = 'none';
  }
  
  answersBox.innerHTML = '';
  const choices = (lang==='ar')? item.choices_ar.slice() : item.choices_en.slice();
  const opts = choices.map((c,i)=>({text:c,origIndex:i}));
  shuffleArray(opts);
  
  opts.forEach((opt, idx)=>{
    const el = document.createElement('div'); el.className='answer';
    el.innerHTML = `<div class="opt-label">${['A','B','C','D'][idx]}</div><div class="opt-text">${opt.text}</div>`;
    el.dataset.orig = opt.origIndex;
    el.onclick = ()=> selectAnswer(el, item);
    answersBox.appendChild(el);
  });
  
  // UI updates
  progInner.style.width = `${Math.round(((currentIndex+1)/n)*100)}%`;
  scoreVal.textContent = currentScore;
  updateLevelBadge();
  updateStreakCounter();
  
  // Timer
  startTimer();
  
  // Visual
  const card = document.getElementById('questionCard');
  card.classList.remove('fade-in'); void card.offsetWidth; card.classList.add('fade-in');
  
  // --- 10x: حفظ الحالة عند عرض السؤال ---
  saveState();
}

/* ---------- Answer selection ---------- */
function selectAnswer(el, item){
  if(answered) return;
  answered = true;
  stopTimer();
  
  const chosenOrig = Number(el.dataset.orig);
  const correctIndex = item.answerIndex;
  const isCorrect = (chosenOrig === correctIndex);
  
  let points = 0;
  
  if(isCorrect){
    // --- 10x: منطق السلسلة والنقاط الإضافية ---
    currentStreak++;
    let basePoints = 10;
    let bonus = Math.min(10, (currentStreak - 1) * 2); // يبدأ البونص من السلسلة 2
    points = basePoints + bonus;
    currentScore += points;
    correctCount++;
    
    el.classList.add('correct', 'pulse');
    playCorrect();
    if(currentStreak > 1) {
      setTimeout(playStreak, 100);
      showScorePopup(`+${points} (🔥${currentStreak})`, 'good');
    } else {
      showScorePopup(`+${points}`, 'good');
    }
    
  } else {
    // --- 10x: كسر السلسلة ---
    currentStreak = 0;
    points = -5; // العقوبة
    currentScore = Math.max(0, currentScore + points); // لا تنزل تحت الصفر
    wrongCount++;
    
    el.classList.add('wrong', 'shake');
    playWrong();
    showScorePopup(`${points}`, 'bad');
    
    // --- 10x: إضافة للمراجعة ---
    wrongAnswers.push({ 
      q_ar: item.q_ar, q_en: item.q_en,
      choices_ar: item.choices_ar, choices_en: item.choices_en,
      chosen: chosenOrig,
      answerIndex: correctIndex
    });
    
    // Highlight correct option
    Array.from(answersBox.children).forEach(ch=>{
      if(Number(ch.dataset.orig) === correctIndex) ch.classList.add('correct');
      ch.onclick = null;
    });
  }
  
  scoreVal.textContent = currentScore;
  updateLevelBadge();
  updateStreakCounter();
  
  setTimeout(()=> goNext(), 900);
}

/* ---------- Skip (unanswered) ---------- */
skipBtn.addEventListener('click', ()=>{
  if(!currentSection || answered) return;
  answered = true;
  stopTimer();
  
  // --- 10x: كسر السلسلة ومعاملته كخطأ (بدون عقوبة نقاط) ---
  currentStreak = 0;
  wrongCount++;
  showScorePopup(`0`, 'bad');
  updateStreakCounter();
  
  const item = QUIZZES[currentSection].items[currentIndex];
  const correctIndex = item.answerIndex;

  // --- 10x: إضافة للمراجعة ---
  wrongAnswers.push({ 
    q_ar: item.q_ar, q_en: item.q_en,
    choices_ar: item.choices_ar, choices_en: item.choices_en,
    chosen: -1, // -1 يدل على التجاوز
    answerIndex: correctIndex
  });

  Array.from(answersBox.children).forEach(ch=>{
    if(Number(ch.dataset.orig) === correctIndex) ch.classList.add('correct');
    ch.onclick = null;
  });
  
  setTimeout(()=> goNext(), 700);
});

/* ---------- Timer ---------- */
function startTimer(){
  let tleft = timerSeconds || 30;
  timerLabel.textContent = formatTime(tleft);
  timerLabel.classList.remove('timer-warn');
  
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    tleft--;
    timerLabel.textContent = formatTime(tleft);
    
    // --- 10x: تحذير المؤقت ---
    if(tleft <= 10) {
      timerLabel.classList.add('timer-warn');
      if(tleft <= 5) beep(440, 0.08, 'sawtooth', 0.05); // صوت تحذير خافت
    }
    
    if(tleft <= 0){
      clearInterval(timerInterval);
      if(!answered){
        answered = true;
        // --- 10x: معاملة انتهاء الوقت كخطأ ---
        playWrong();
        currentStreak = 0;
        currentScore = Math.max(0, currentScore - 5); // عقوبة
        wrongCount++;
        showScorePopup('-5', 'bad');
        
        scoreVal.textContent = currentScore;
        updateLevelBadge();
        updateStreakCounter();
        
        const item = QUIZZES[currentSection].items[currentIndex];
        const corr = item.answerIndex;
        // --- 10x: إضافة للمراجعة ---
        wrongAnswers.push({ 
          q_ar: item.q_ar, q_en: item.q_en,
          choices_ar: item.choices_ar, choices_en: item.choices_en,
          chosen: -2, // -2 يدل على انتهاء الوقت
          answerIndex: corr
        });
        
        Array.from(answersBox.children).forEach(ch=>{
          if(Number(ch.dataset.orig) === corr) ch.classList.add('correct');
          ch.onclick = null;
        });
        setTimeout(()=> goNext(), 900);
      }
    }
  },1000);
}
function stopTimer(){ 
  if(timerInterval) clearInterval(timerInterval); 
  timerInterval = null; 
  timerLabel.classList.remove('timer-warn');
}

/* ---------- Next question / finish ---------- */
function goNext(){
  stopTimer();
  const total = QUIZZES[currentSection].items.length;
  currentIndex++;
  if(currentIndex < total){
    showQuestion();
  } else {
    finishQuiz();
  }
}

/* ---------- Finish quiz ---------- */
function finishQuiz(){
  quizArea.style.display = 'none';
  stopTimer();
  clearState(); // --- 10x: مسح حالة الاستئناف
  
  const totalQuestions = QUIZZES[currentSection].items.length;
  const totalPossible = totalQuestions * 10; // (النتيجة الأساسية بدون بونص)
  const percent = Math.max(0, Math.round((correctCount / totalQuestions) * 100));
  
  resScore.textContent = `${currentScore} ${t('points')}`;
  resDetails.innerHTML = `
    <div>${t('section')}: <strong>${lang==='ar'?QUIZZES[currentSection].title_ar:QUIZZES[currentSection].title_en}</strong></div>
    <div style="margin-top:8px">${t('correct')}: <strong>${correctCount}/${totalQuestions}</strong></div>
    <div>${t('wrongSkipped')}: <strong>${wrongCount}</strong></div>
    <div style="margin-top:8px">${t('percent')}: <strong>${percent}%</strong></div>
  `;
  const level = determineLevel(currentScore);
  document.getElementById('resTitle').textContent = `${t('finalResult')} — ${level.name}`;
  
  // save result
  const entry = { id: Date.now(), section: currentSection, score: currentScore, when: new Date().toISOString(), level: level.name, lang };
  leaderboard.push(entry); leaderboard.sort((a,b)=> b.score - a.score);
  if(leaderboard.length>100) leaderboard = leaderboard.slice(0,100);
  localStorage.setItem('geo_leaderboard', JSON.stringify(leaderboard));
  
  savedNote.textContent = t('savedNote');
  
  // --- 10x: إظهار/إخفاء زر المراجعة ---
  reviewBtn.style.display = (wrongAnswers.length > 0) ? 'inline-block' : 'none';
  
  resultModal.style.display = 'flex';
}

/* ---------- Levels ---------- */
function determineLevel(score){
  if(score >= 250) return { name: t('expert'), color:'#ffd700' };
  if(score >= 150) return { name: t('fieldPro'), color:'#c0c0c0' };
  if(score >= 50) return { name: t('advanced'), color:'#7dd3fc' };
  return { name: t('beginner'), color:'#94a3b8' };
}
function updateLevelBadge(){ const lv = determineLevel(currentScore); levelBadge.textContent = `${t('level')}: ${lv.name}`; }

/* ---------- 10x: Streak Counter ---------- */
function updateStreakCounter(){
  if(currentStreak > 1){
    streakCounter.textContent = `🔥 ${currentStreak} ${t('streak')}`;
    streakCounter.classList.add('visible');
  } else {
    streakCounter.classList.remove('visible');
  }
}

/* ---------- Retry / close ---------- */
retryBtn.addEventListener('click', ()=> { resultModal.style.display='none'; startSection(currentSection); });
closeResBtn.addEventListener('click', ()=> { resultModal.style.display='none'; quizArea.style.display='none'; sectionListEl.style.display='grid'; });

/* ---------- Back to menu ---------- */
backToMenu.addEventListener('click', ()=> { 
  // 10x: لا يمسح الحالة، فقط يعود للقائمة
  quizArea.style.display='none'; 
  sectionListEl.style.display='grid'; 
  stopTimer(); 
});

/* ---------- 10x: Leaderboard Modal ---------- */
leaderBtn.addEventListener('click', ()=>{
  const board = JSON.parse(localStorage.getItem('geo_leaderboard')||'[]');
  if(board.length===0){ 
    leaderboardList.innerHTML = `<div style="padding:20px; color:var(--muted);">${t('leaderboardEmpty')}</div>`;
  } else {
    let out = '';
    board.slice(0,20).forEach((e,i)=>{
      const title = (lang==='ar'? QUIZZES[e.section].title_ar : QUIZZES[e.section].title_en);
      out += `
        <div class="leaderboard-item">
          <div class="score">${e.score}</div>
          <div class="details">
            <div class="title">${i+1}. ${title}</div>
            <div class="date">${e.level} — ${new Date(e.when).toLocaleDateString(lang)}</div>
          </div>
        </div>`;
    });
    leaderboardList.innerHTML = out;
  }
  leaderboardModal.style.display = 'flex';
});
document.getElementById('closeLeaderBtn').addEventListener('click', ()=> leaderboardModal.style.display='none');

/* ---------- 10x: Review Answers Modal ---------- */
reviewBtn.addEventListener('click', ()=>{
  reviewList.innerHTML = '';
  let out = '';
  wrongAnswers.forEach(item => {
    const qText = (lang === 'ar') ? item.q_ar : item.q_en;
    const choices = (lang === 'ar') ? item.choices_ar : item.choices_en;
    let chosenText = '';
    if (item.chosen === -1) chosenText = `(${t('skip')})`;
    else if (item.chosen === -2) chosenText = `(${t('timer') || 'Time Out'})`;
    else chosenText = choices[item.chosen];
    
    const correctText = choices[item.answerIndex];

    out += `
      <div class="review-item">
        <div class="q-text">${qText}</div>
        <div class="r-ans"><b>${t('yourAnswer')}:</b> ${chosenText}</div>
        <div class="c-ans"><b>${t('correctAnswer')}:</b> ${correctText}</div>
      </div>
    `;
  });
  reviewList.innerHTML = out;
  resultModal.style.display = 'none';
  reviewModal.style.display = 'flex';
});
document.getElementById('closeReviewBtn').addEventListener('click', ()=>{
  reviewModal.style.display = 'none';
  resultModal.style.display = 'flex'; // العودة لنافذة النتائج
});


/* ---------- 10x: Settings Modal ---------- */
settingsBtn.addEventListener('click', ()=>{
  audioToggle.checked = settings.audio;
  settingsModal.style.display = 'flex';
});
audioToggle.addEventListener('change', (e)=>{
  settings.audio = e.target.checked;
  localStorage.setItem('geo_settings', JSON.stringify(settings));
});
clearDataBtn.addEventListener('click', ()=>{
  if(confirm(t('clearDataConfirm'))){
    localStorage.removeItem('geo_leaderboard');
    localStorage.removeItem(RESUME_KEY);
    localStorage.removeItem('geo_lang');
    localStorage.removeItem('geo_settings');
    location.reload();
  }
});
document.getElementById('closeSettingsBtn').addEventListener('click', ()=> settingsModal.style.display='none');


/* ---------- Language Toggle ---------- */
langToggle.addEventListener('click', () => {
    lang = (lang === 'ar') ? 'en' : 'ar';
    localStorage.setItem('geo_lang', lang);
    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
    refreshLangUI();
    renderSectionCards();
    updateLevelBadge();
    if (quizArea.style.display === 'none') {
        sectionListEl.style.display = 'grid';
    }
});

/* ---------- Init ---------- */
function init(){
  document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
  settings.audio = audioToggle.checked; // مزامنة الإعدادات عند البدء
  
  refreshLangUI();
  renderSectionCards();
  scoreVal.textContent = '0';
  updateLevelBadge();
  sectionListEl.style.display = 'grid';
  
  // --- 10x: التحقق من وجود اختبار معلق ---
  const resumeState = localStorage.getItem(RESUME_KEY);
  if(resumeState){
    resumePrompt.style.display = 'flex';
    document.getElementById('resumeYes').onclick = () => {
      loadState(JSON.parse(resumeState));
      resumePrompt.style.display = 'none';
    };
    document.getElementById('resumeNo').onclick = () => {
      clearState();
      resumePrompt.style.display = 'none';
    };
  }

  // resume audio on gesture
  document.addEventListener('click', ()=> { 
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); 
  }, { once:true });
}
init();

</script>
</body>
</html>
