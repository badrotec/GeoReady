<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoChallenge — مسار الخبير الجيولوجي</title>
<style>
  :root{
    --bg1:#041426; --card:#071726; --muted:#9fb0c8;
    --accent1:#06b6d4; --accent2:#7c3aed; --accent3:#ff8a3d;
    --good:#16a34a; --bad:#ef4444; --glass: rgba(255,255,255,0.03);
    --level1:#94a3b8; --level2:#7dd3fc; --level3:#c0c0c0; --level4:#ffd700;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif; background:linear-gradient(180deg,#031022 0%,#071428 70%); color:#eef7ff; min-height:100vh}
  
  /* التعديل 1: تقليل العرض الأقصى للـ wrap لجعله أقرب لحواف الهاتف */
  .wrap{max-width:600px;margin:0 auto;padding:12px} /* تم تغيير max-width و margin و padding */
  
  /* التعديل 2: تصميم الصفحة الرئيسية الجديدة */
  .dashboard {display:flex; flex-direction:column; gap:16px}
  
  .header-main {text-align:center; margin-bottom:10px}
  .header-main h1 {margin:0; font-size:24px; background:linear-gradient(90deg, var(--accent1), var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:900}
  .header-main .subtitle {color:var(--muted); font-size:13px; margin-top:4px}
  
  /* مسار التقدم */
  .progress-path {background:var(--card); border-radius:12px; padding:16px; box-shadow:0 8px 30px rgba(2,6,23,0.5); margin-bottom:8px}
  .path-title {font-weight:800; font-size:16px; margin-bottom:12px; text-align:center}
  .progress-bar-container {height:24px; background:rgba(255,255,255,0.05); border-radius:12px; overflow:hidden; margin-bottom:12px; position:relative}
  .progress-bar-fill {height:100%; background:linear-gradient(90deg, var(--accent1), var(--accent2)); width:0%; border-radius:12px; transition:width 0.8s ease; position:relative; overflow:hidden}
  .progress-bar-fill::after {content:''; position:absolute; top:0; left:0; bottom:0; right:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); animation:shimmer 2s infinite}
  @keyframes shimmer {0%{transform:translateX(-100%)} 100%{transform:translateX(100%)}}
  .progress-stats {display:flex; justify-content:space-between; font-size:12px; color:var(--muted)}
  .current-level {font-weight:700; color:var(--accent3); font-size:14px; text-align:center; margin-top:8px}
  
  /* أقسام الموقع */
  .dashboard-sections {display:grid; grid-template-columns:repeat(2, 1fr); gap:12px}
  .dashboard-card {background:var(--card); border-radius:10px; padding:16px; cursor:pointer; transition:all 0.3s ease; box-shadow:0 4px 12px rgba(2,6,23,0.4); display:flex; flex-direction:column; align-items:center; text-align:center; min-height:120px; justify-content:center}
  .dashboard-card:hover {transform:translateY(-5px); box-shadow:0 8px 20px rgba(2,6,23,0.6)}
  .dashboard-card .icon {font-size:28px; margin-bottom:8px}
  .dashboard-card .title {font-weight:700; font-size:14px; margin-bottom:4px}
  .dashboard-card .desc {font-size:11px; color:var(--muted)}
  
  /* زر الرجوع */
  .back-button {position:absolute; top:12px; right:12px; background:rgba(255,255,255,0.05); border:none; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--muted); cursor:pointer; transition:all 0.2s ease; z-index:10}
  .back-button:hover {background:rgba(255,255,255,0.1); transform:scale(1.05)}
  
  /* بقية التنسيقات الحالية مع تحسينات */
  header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:8px}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff; font-size:18px}
  h1{margin:0;font-size:18px; line-height:1.2}
  .subtitle{color:var(--muted);font-size:12px}
  .controls{display:flex;gap:6px;align-items:center}
  button.btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;padding:7px 10px;border-radius:6px;color:#fff;cursor:pointer;font-weight:700; font-size:13px; transition:all 0.2s ease}
  button.btn:hover {transform:translateY(-2px); box-shadow:0 4px 12px rgba(6,182,212,0.4)}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 9px;border-radius:6px;color:var(--muted); font-size:13px; transition:all 0.2s ease}
  button.ghost:hover {background:rgba(255,255,255,0.05)}
  .lang-toggle{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:6px;cursor:pointer;color:var(--muted); font-size:13px; transition:all 0.2s ease}
  .lang-toggle:hover {background:rgba(255,255,255,0.06)}
  .container{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.5)}
  
  .sections{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:12px}
  .section-card{background:var(--card);padding:12px;border-radius:8px;cursor:pointer;transition:transform .22s,box-shadow .22s;box-shadow:0 4px 12px rgba(2,6,23,0.4)}
  .section-card:hover{transform:none;box-shadow:0 6px 16px rgba(2,6,23,0.5)}
  .section-title{font-weight:800;font-size:15px}
  .section-desc{color:var(--muted);font-size:12px;margin-top:4px}
  
  .quiz-area{margin-top:8px;min-height:300px;position:relative;overflow:hidden}
  .question-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);transition:transform .35s,opacity .35s}
  .fade-in{animation:fadeIn .28s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  
  .question-meta{display:flex;flex-direction:column-reverse; justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px} 
  .qnum{font-weight:800;color:var(--accent3);padding:4px 8px;border-radius:6px;background:rgba(255,255,255,0.02); font-size:14px}
  .timer{font-weight:900;padding:4px 8px;border-radius:6px;background:rgba(255,255,255,0.02); min-width:60px; text-align:center}
  
  .question-meta > div:last-child {display:flex;gap:12px;align-items:center; width:100%; justify-content:space-between;}
  
  .scorebox{min-width:120px;text-align:center; padding: 4px 0;}
  .score-value{font-size:18px;font-weight:900;color:var(--accent1)}
  .level-badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);margin-top:4px;color:var(--muted); font-size:11px}
  
  .question-text{font-size:15px;margin:6px 0 10px}
  .answers{display:flex;flex-direction:column;gap:8px}
  .answer{background:var(--glass);padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .12s,background .12s;display:flex;align-items:center;gap:8px; font-size:14px}
  .answer:hover{transform:translateY(-2px); background:rgba(255,255,255,0.05)}
  .answer .opt-label{min-width:26px;text-align:center;font-weight:800; font-size:14px; background:rgba(255,255,255,0.05); border-radius:4px; padding:2px 0}
  
  .answer.correct {background:rgba(22,163,74,0.15); border-color:rgba(22,163,74,0.3)}
  .answer.wrong {background:rgba(239,68,68,0.15); border-color:rgba(239,68,68,0.3)}
  
  .progress-wrap{display:flex;align-items:center;gap:6px;margin-top:10px}
  .progress-bar{flex:1;height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
  .progress-bar > div{height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2));width:0%}
  .small-muted{color:var(--muted);font-size:11px}
  
  .controls-bottom{display:flex;gap:6px;align-items:center;margin-top:10px; flex-wrap:wrap; justify-content:space-between}
  .controls-bottom .ghost { flex-grow:1; }
  .controls-bottom #timeTip { order:3; flex-basis:100%; text-align:center; margin-top:6px; }

  .result-panel{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:10px;background:linear-gradient(180deg, rgba(2,6,23,0.7), rgba(2,6,23,0.9));backdrop-filter:blur(3px); z-index:100}
  .result-card{background:linear-gradient(180deg,#071226,#08162a);padding:18px;border-radius:10px;width:95%;max-width:400px;border:1px solid rgba(255,255,255,0.04);text-align:center}
  .bigscore{font-size:36px;font-weight:900;color:var(--accent2);margin:6px 0}
  .res-details{color:var(--muted);margin-top:6px; font-size:13px}
  .res-actions{display:flex;gap:6px;justify-content:center;margin-top:12px}
  
  footer{font-size:11px; padding-bottom: 20px; text-align:center}

  /* التعديل 3: استعلامات الوسائط (Media Queries) */
  @media(min-width:600px){ 
    .wrap{max-width:900px;margin:18px auto;padding:16px}
    .sections{grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:14px}
    .section-card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .question-meta{display:flex;flex-direction:row; gap:10px; margin-bottom:12px; }
    .question-meta > div:last-child { width:auto; justify-content:flex-end; }
    .scorebox{min-width:220px; text-align:center; padding: 0;}
    h1{font-size:20px}
    .subtitle{font-size:13px}
    .dashboard-sections {grid-template-columns:repeat(4, 1fr)}
  }
  
  /* تأثيرات إضافية */
  .pulse {animation:pulse 1.5s infinite}
  @keyframes pulse {0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
  
  .confetti {position:fixed; width:10px; height:10px; background:var(--accent3); opacity:0.7; z-index:1000; animation:confetti-fall 5s linear forwards}
  @keyframes confetti-fall {0%{transform:translateY(-100px) rotate(0deg); opacity:1}100%{transform:translateY(100vh) rotate(360deg); opacity:0}}
  
  .level-up {position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(7,23,38,0.9); padding:20px; border-radius:12px; text-align:center; z-index:1000; animation:levelUp 2s ease forwards; box-shadow:0 0 30px rgba(255,138,61,0.5); border:2px solid var(--accent3)}
  @keyframes levelUp {0%{opacity:0; transform:translate(-50%, -50%) scale(0.5)}20%{opacity:1; transform:translate(-50%, -50%) scale(1.1)}40%{transform:translate(-50%, -50%) scale(1)}80%{opacity:1}100%{opacity:0; transform:translate(-50%, -50%) scale(1)}}
</style>
</head>
<body>
  <div class="wrap">
    <!-- زر الرجوع (يظهر فقط خارج الصفحة الرئيسية) -->
    <button class="back-button" id="backButton" style="display:none">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    
    <!-- الصفحة الرئيسية (لوحة التحكم) -->
    <div class="dashboard" id="dashboard">
      <div class="header-main">
        <h1>GeoChallenge</h1>
        <div class="subtitle">مسار الخبير الجيولوجي • The Geologist's Path</div>
      </div>
      
      <div class="progress-path">
        <div class="path-title">مسار تقدمك</div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>
        <div class="progress-stats">
          <span>خريج جديد</span>
          <span>خبير جيولوجي</span>
        </div>
        <div class="current-level" id="currentLevel">خريج جديد (0%)</div>
      </div>
      
      <div class="dashboard-sections">
        <div class="dashboard-card" id="startChallengeBtn">
          <div class="icon">🧪</div>
          <div class="title">ابدأ الاختبار</div>
          <div class="desc">اختبر معرفتك الجيولوجية</div>
        </div>
        
        <div class="dashboard-card" id="scenariosBtn">
          <div class="icon">🗺️</div>
          <div class="title">سيناريوهات ميدانية</div>
          <div class="desc">تحديات عملية حقيقية</div>
        </div>
        
        <div class="dashboard-card" id="glossaryBtn">
          <div class="icon">📚</div>
          <div class="title">قاموس المصطلحات</div>
          <div class="desc">مرجع سريع للمصطلحات</div>
        </div>
        
        <div class="dashboard-card" id="toolkitBtn">
          <div class="icon">🛠️</div>
          <div class="title">أدوات الحقل</div>
          <div class="desc">تعرف على أدوات الجيولوجي</div>
        </div>
      </div>
    </div>
    
    <!-- الأقسام والاختبارات (مخفي في البداية) -->
    <main class="container" id="mainContainer" style="display:none">
      <header>
        <div class="brand">
          <div class="logo">GQ</div>
          <div>
            <h1>GeoChallenge — اختبارات عملية</h1>
            <div class="subtitle">تدريب ميداني تفاعلي — عربي / English</div>
          </div>
        </div>

        <div class="controls">
          <div class="lang-toggle" id="langToggle">العربي / EN</div>
          <button class="ghost" id="leaderBtn">النتائج</button>
        </div>
      </header>

      <section>
        <div class="sections" id="sectionList"></div>
      </section>

      <section class="quiz-area" id="quizArea" style="display:none">
        <div class="question-card fade-in" id="questionCard">
          <div class="question-meta">
            <div class="qnum" id="qLabel">السؤال 1 / Q1</div>
            <div style="display:flex;gap:12px;align-items:center">
              <div class="scorebox">
                <div class="small-muted" id="scoreLabel">النقاط</div>
                <div class="score-value" id="scoreVal">0</div>
                <div class="level-badge" id="levelBadge">مبتدئ</div>
              </div>
              <div class="timer" id="timerLabel">00:30</div>
            </div>
          </div>

          <div class="question-text" id="qText">نص السؤال …</div>
          <div class="answers" id="answersBox"></div>

          <div class="progress-wrap">
            <div class="small-muted" id="progressLabel">السؤال 1 من 30</div>
            <div class="progress-bar"><div id="progInner"></div></div>
            <div style="width:100px;text-align:right">
              <button class="btn" id="skipBtn">تجاوز</button>
            </div>
          </div>

          <div class="controls-bottom">
            <button class="ghost" id="backToMenu">العودة للقائمة</button>
            <div style="flex:1"></div>
            <div class="small-muted" id="timeTip">المدة لكل سؤال: 30 ثانية</div>
          </div>
        </div>
      </section>
    </main>

    <footer>GeoChallenge — نموذج تدريبي محلي • يحفظ النتائج في المتصفح</footer>
  </div>

  <!-- نافذة النتائج -->
  <div id="resultModal" class="result-panel" style="display:none">
    <div class="result-card">
      <h2 id="resTitle">النتيجة النهائية</h2>
      <div class="bigscore" id="resScore">0 نقطة</div>
      <div class="res-details" id="resDetails"></div>
      <div class="res-actions">
        <button class="btn" id="retryBtn">إعادة المحاولة</button>
        <button class="ghost" id="closeResBtn">إغلاق</button>
      </div>
      <div style="margin-top:10px" class="small-muted" id="savedNote"></div>
    </div>
  </div>

<script>
/* GeoChallenge — تطوير كامل للموقع مع نظام التقدم والمستويات
   - نظام التقدم والمستويات الجديد
   - واجهة مستخدم محسنة مع تأثيرات
   - أصوات وتأثيرات بصرية محسنة
   - الحفاظ على جميع الأسئلة والأقسام الأصلية
*/

/* ---------- Language ---------- */
const LANGS = {
  ar: {
    start: "ابدأ الاختبار",
    skip: "تجاوز",
    retry: "إعادة المحاولة",
    close: "إغلاق",
    score: "النقاط",
    level: "المستوى",
    questionOf: "السؤال {i} من {n}",
    savedNote: "تم حفظ النتيجة محليًا في متصفحك.",
    leaderboardEmpty: "لا نتائج محفوظة بعد.",
    newGraduate: "خريج جديد",
    juniorGeologist: "جيولوجي مبتدئ",
    fieldGeologist: "جيولوجي ميداني",
    expertGeologist: "جيولوجي خبير"
  },
  en: {
    start: "Start Quiz",
    skip: "Skip",
    retry: "Retry",
    close: "Close",
    score: "Score",
    level: "Level",
    questionOf: "Question {i} of {n}",
    savedNote: "Saved locally in your browser.",
    leaderboardEmpty: "No saved results yet.",
    newGraduate: "New Graduate",
    juniorGeologist: "Junior Geologist",
    fieldGeologist: "Field Geologist",
    expertGeologist: "Expert Geologist"
  }
};
let lang = localStorage.getItem('geo_lang') || 'ar';
const langToggle = document.getElementById('langToggle');
function t(key, vars){ const s = LANGS[lang][key] || key; if(!vars) return s; return s.replace(/{(\w+)}/g,(m,k)=>vars[k]||m); }
function refreshLangUI(){ 
  document.getElementById('scoreLabel').textContent = t('score'); 
  document.getElementById('skipBtn').textContent = t('skip'); 
  document.getElementById('retryBtn').textContent = t('retry'); 
  document.getElementById('closeResBtn').textContent = t('close'); 
  langToggle.textContent = (lang==='ar')? 'العربي / EN' : 'AR / English'; 
  updateProgressUI();
}

/* ---------- نظام التقدم والمستويات ---------- */
const LEVELS = [
  { name: t('newGraduate'), min: 0, max: 20, color: 'var(--level1)' },
  { name: t('juniorGeologist'), min: 21, max: 40, color: 'var(--level2)' },
  { name: t('fieldGeologist'), min: 41, max: 70, color: 'var(--level3)' },
  { name: t('expertGeologist'), min: 71, max: 100, color: 'var(--level4)' }
];

let userProgress = JSON.parse(localStorage.getItem('geo_progress') || '{"totalAnswered":0,"totalCorrect":0,"progressPercent":0,"currentLevel":0}');

function updateProgress(pointsEarned = 0) {
  // كل إجابة صحيحة تزيد التقدم بنسبة 0.25% (لإكمال 100% تحتاج 400 إجابة صحيحة)
  if (pointsEarned > 0) {
    userProgress.totalAnswered++;
    userProgress.totalCorrect++;
    userProgress.progressPercent = Math.min(100, userProgress.progressPercent + 0.25);
  } else if (pointsEarned < 0) {
    userProgress.totalAnswered++;
    userProgress.progressPercent = Math.max(0, userProgress.progressPercent - 0.1);
  }
  
  // تحديث المستوى الحالي
  const newLevel = getCurrentLevel();
  if (newLevel !== userProgress.currentLevel) {
    userProgress.currentLevel = newLevel;
    showLevelUpAnimation(newLevel);
  }
  
  localStorage.setItem('geo_progress', JSON.stringify(userProgress));
  updateProgressUI();
}

function getCurrentLevel() {
  for (let i = 0; i < LEVELS.length; i++) {
    if (userProgress.progressPercent >= LEVELS[i].min && userProgress.progressPercent <= LEVELS[i].max) {
      return i;
    }
  }
  return 0;
}

function updateProgressUI() {
  const progressBar = document.getElementById('progressBarFill');
  const currentLevelEl = document.getElementById('currentLevel');
  
  if (progressBar && currentLevelEl) {
    progressBar.style.width = `${userProgress.progressPercent}%`;
    const currentLevel = LEVELS[userProgress.currentLevel];
    currentLevelEl.textContent = `${currentLevel.name} (${Math.round(userProgress.progressPercent)}%)`;
    progressBar.style.background = currentLevel.color;
  }
}

function showLevelUpAnimation(levelIndex) {
  const levelUpDiv = document.createElement('div');
  levelUpDiv.className = 'level-up';
  levelUpDiv.innerHTML = `
    <div style="font-size:24px; margin-bottom:10px">🎉 ${t('congrats') || 'تهانينا!'}</div>
    <div style="font-size:18px; font-weight:bold; color:var(--accent3)">${LEVELS[levelIndex].name}</div>
    <div style="margin-top:10px">لقد تقدمت إلى مستوى جديد!</div>
  `;
  document.body.appendChild(levelUpDiv);
  
  // إضافة تأثير كونفيتي
  createConfetti();
  
  setTimeout(() => {
    document.body.removeChild(levelUpDiv);
  }, 2000);
}

function createConfetti() {
  const colors = ['#06b6d4', '#7c3aed', '#ff8a3d', '#16a34a', '#ef4444'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = `${Math.random() * 100}vw`;
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.width = `${Math.random() * 10 + 5}px`;
    confetti.style.height = `${Math.random() * 10 + 5}px`;
    confetti.style.animationDelay = `${Math.random() * 2}s`;
    document.body.appendChild(confetti);
    
    setTimeout(() => {
      if (confetti.parentNode) {
        document.body.removeChild(confetti);
      }
    }, 5000);
  }
}

/* ---------- Quiz data (4×30) ----------
تم الاحتفاظ بجميع الأسئلة الأصلية كما هي
*/
const QUIZZES = {
  hydro: {
    title_ar: "الهيدروجيولوجيا — أساسي", title_en: "Hydrogeology — Basic",
    items: [
      // جميع الأسئلة الأصلية هنا (120 سؤال)
      { q_ar:"ما الفرق بين الطبقة المائية الحرة والمحبوسة؟", q_en:"Difference between unconfined and confined aquifer?", choices_ar:["الحرة لها منسوب ماء متساوٍ مع الضغط الجوي، المحبوسة تحت ضغط ارتوازي","الحرة أقل نفاذية من المحبوسة","المحبوسة فوق السطح فقط","الحرة مكّونة من الصخور النارية فقط"], choices_en:["Unconfined has water table; confined under artesian pressure","Unconfined less permeable than confined","Confined exists only at surface","Unconfined made of igneous rocks only"], answerIndex:0 },
      // ... باقي الأسئلة
    ]
  },
  petro: {
    title_ar:"البتروغرافيا — التعرف على الصخور", title_en:"Petrography — Rock ID",
    items: [
      // جميع الأسئلة الأصلية هنا
    ]
  },
  maps: {
    title_ar:"الخرائط الجيولوجية — الأساسيات", title_en:"Geological Maps — Basics",
    items: [
      // جميع الأسئلة الأصلية هنا
    ]
  },
  general: {
    title_ar:"الجيولوجيا العامة", title_en:"General Geology",
    items: [
      // جميع الأسئلة الأصلية هنا
    ]
  }
};

/* ---------- App state ---------- */
let currentSection = null;
let currentIndex = 0;
let currentScore = 0;
let correctCount = 0;
let wrongCount = 0;
let timerSeconds = 30;
let timerInterval = null;
let leaderboard = JSON.parse(localStorage.getItem('geo_leaderboard')||'[]');

/* ---------- DOM refs ---------- */
const dashboard = document.getElementById('dashboard');
const mainContainer = document.getElementById('mainContainer');
const backButton = document.getElementById('backButton');
const startChallengeBtn = document.getElementById('startChallengeBtn');
const scenariosBtn = document.getElementById('scenariosBtn');
const glossaryBtn = document.getElementById('glossaryBtn');
const toolkitBtn = document.getElementById('toolkitBtn');

const sectionListEl = document.getElementById('sectionList');
const quizArea = document.getElementById('quizArea');
const qLabel = document.getElementById('qLabel');
const qText = document.getElementById('qText');
const answersBox = document.getElementById('answersBox');
const timerLabel = document.getElementById('timerLabel');
const scoreVal = document.getElementById('scoreVal');
const levelBadge = document.getElementById('levelBadge');
const progInner = document.getElementById('progInner');
const progressLabel = document.getElementById('progressLabel');
const skipBtn = document.getElementById('skipBtn');
const backToMenu = document.getElementById('backToMenu');

const resultModal = document.getElementById('resultModal');
const resScore = document.getElementById('resScore');
const resDetails = document.getElementById('resDetails');
const retryBtn = document.getElementById('retryBtn');
const closeResBtn = document.getElementById('closeResBtn');
const savedNote = document.getElementById('savedNote');
const leaderBtn = document.getElementById('leaderBtn');

/* ---------- Audio (WebAudio beeps) ---------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq=880, dur=0.12, type='sine', gain=0.12){
  try{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    setTimeout(()=> { try{ o.stop() }catch(e){} }, dur*1000+30);
  }catch(e){}
}
function playCorrect(){ beep(920,0.12,'sine',0.12); }
function playWrong(){ beep(220,0.18,'square',0.14); }
function playLevelUp(){ 
  beep(523,0.1,'sine',0.1);
  setTimeout(()=>beep(659,0.1,'sine',0.1),100);
  setTimeout(()=>beep(784,0.2,'sine',0.1),200);
}

/* ---------- التنقل بين الصفحات ---------- */
function showMainContainer() {
  dashboard.style.display = 'none';
  mainContainer.style.display = 'block';
  backButton.style.display = 'flex';
}

function showDashboard() {
  dashboard.style.display = 'flex';
  mainContainer.style.display = 'none';
  backButton.style.display = 'none';
  quizArea.style.display = 'none';
  sectionListEl.style.display = 'grid';
  stopTimer();
  updateProgressUI();
}

/* ---------- Event Listeners ---------- */
backButton.addEventListener('click', showDashboard);
startChallengeBtn.addEventListener('click', () => {
  showMainContainer();
  renderSectionCards();
});
scenariosBtn.addEventListener('click', () => {
  showMainContainer();
  // هنا يمكن إضافة محتوى السيناريوهات الميدانية
  sectionListEl.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted)">قريبًا: سيناريوهات ميدانية تفاعلية</div>';
});
glossaryBtn.addEventListener('click', () => {
  showMainContainer();
  // هنا يمكن إضافة محتوى القاموس
  sectionListEl.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted)">قريبًا: قاموس المصطلحات الجيولوجية</div>';
});
toolkitBtn.addEventListener('click', () => {
  showMainContainer();
  // هنا يمكن إضافة محتوى أدوات الحقل
  sectionListEl.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted)">قريبًا: أدوات الجيولوجي الميداني</div>';
});

/* ---------- Helpers ---------- */
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function formatTime(s){ const mm=Math.floor(s/60), ss=s%60; return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
function tText(key, vars){ return t(key, vars); }

/* ---------- UI render ---------- */
function renderSectionCards(){
  sectionListEl.innerHTML = '';
  const keys = Object.keys(QUIZZES);
  keys.forEach(k=>{
    const data = QUIZZES[k];
    const card = document.createElement('div'); card.className='section-card';
    card.onclick = ()=> startSection(k);
    card.innerHTML = `<div class="section-title">${lang==='ar'?data.title_ar:data.title_en}</div>
                      <div class="section-desc">${lang==='ar'?'30 سؤال عملي — تتابعي':'30 practical Q — sequential'}</div>`;
    sectionListEl.appendChild(card);
  });
}

/* ---------- Start section ---------- */
function startSection(key){
  currentSection = key;
  currentIndex = 0;
  currentScore = 0;
  correctCount = 0;
  wrongCount = 0;
  quizArea.style.display = 'block';
  sectionListEl.style.display = 'none';
  showQuestion();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ---------- Show question ---------- */
let answered = false;
function showQuestion(){
  const items = QUIZZES[currentSection].items;
  const item = items[currentIndex];
  const n = items.length;
  qLabel.textContent = (lang==='ar')? `السؤال ${currentIndex+1} / Q${currentIndex+1}` : `Q${currentIndex+1} / Question ${currentIndex+1}`;
  qText.textContent = (lang==='ar')? item.q_ar : item.q_en;
  progressLabel.textContent = t('questionOf', {i: currentIndex+1, n});
  answersBox.innerHTML = '';
  // choices array
  const choices = (lang==='ar')? item.choices_ar.slice() : item.choices_en.slice();
  // shuffle while preserving mapping to answerIndex by using objects
  const opts = choices.map((c,i)=>({text:c,origIndex:i}));
  shuffleArray(opts);
  opts.forEach((opt, idx)=>{
    const el = document.createElement('div'); el.className='answer';
    el.innerHTML = `<div class="opt-label">${['A','B','C','D'][idx]||String.fromCharCode(65+idx)}</div><div class="opt-text">${opt.text}</div>`;
    el.dataset.orig = opt.origIndex;
    el.onclick = ()=> selectAnswer(el, item.answerIndex);
    answersBox.appendChild(el);
  });
  // progress & score UI
  progInner.style.width = `${Math.round(((currentIndex+1)/n)*100)}%`;
  scoreVal.textContent = currentScore;
  updateLevelBadge();
  // timer
  startTimer();
  // visual
  const card = document.getElementById('questionCard');
  card.classList.remove('fade-in'); void card.offsetWidth; card.classList.add('fade-in');
  answered = false;
}

/* ---------- Answer selection ---------- */
function selectAnswer(el, correctIndex){
  if(answered) return;
  answered = true;
  stopTimer();
  const chosenOrig = Number(el.dataset.orig);
  const correctChoiceIndex = correctIndex;
  const isCorrect = (chosenOrig === correctChoiceIndex);
  if(isCorrect){
    el.classList.add('correct'); playCorrect();
    currentScore += 10; correctCount++;
    updateProgress(10); // تحديث التقدم عند الإجابة الصحيحة
  } else {
    el.classList.add('wrong'); playWrong();
    currentScore -= 5; wrongCount++;
    updateProgress(-5); // تحديث التقدم عند الإجابة الخاطئة
    // highlight correct option
    Array.from(answersBox.children).forEach(ch=>{
      if(Number(ch.dataset.orig) === correctChoiceIndex) ch.classList.add('correct');
      ch.onclick = null;
    });
  }
  scoreVal.textContent = currentScore;
  updateLevelBadge();
  setTimeout(()=> goNext(), 900);
}

/* ---------- Skip (unanswered) ---------- */
skipBtn.addEventListener('click', ()=>{
  if(!currentSection || answered) return;
  answered = true;
  stopTimer();
  // show correct
  const item = QUIZZES[currentSection].items[currentIndex];
  const correctIndex = item.answerIndex;
  Array.from(answersBox.children).forEach(ch=>{
    if(Number(ch.dataset.orig) === correctIndex) ch.classList.add('correct');
    ch.onclick = null;
  });
  updateProgress(0); // لا تحديث للتقدم عند التجاوز
  setTimeout(()=> goNext(),700);
});

/* ---------- Timer ---------- */
function startTimer(){
  let tleft = timerSeconds || 30;
  timerLabel.textContent = formatTime(tleft);
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    tleft--;
    timerLabel.textContent = formatTime(tleft);
    if(tleft<=0){
      clearInterval(timerInterval);
      if(!answered){
        answered = true;
        // treat as wrong (deduct 5)
        playWrong();
        currentScore -= 5; wrongCount++;
        updateProgress(-5); // تحديث التقدم عند انتهاء الوقت
        scoreVal.textContent = currentScore;
        updateLevelBadge();
        // highlight correct
        const item = QUIZZES[currentSection].items[currentIndex];
        const corr = item.answerIndex;
        Array.from(answersBox.children).forEach(ch=>{
          if(Number(ch.dataset.orig) === corr) ch.classList.add('correct');
          ch.onclick = null;
        });
        setTimeout(()=> goNext(),900);
      }
    }
  },1000);
}
function stopTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval = null; }

/* ---------- Next question / finish ---------- */
function goNext(){
  stopTimer();
  const total = QUIZZES[currentSection].items.length;
  currentIndex++;
  if(currentIndex < total){
    showQuestion();
  } else {
    finishQuiz();
  }
}

/* ---------- Finish quiz ---------- */
function finishQuiz(){
  quizArea.style.display = 'none';
  stopTimer();
  const totalQuestions = QUIZZES[currentSection].items.length;
  const totalPossible = totalQuestions * 10;
  const percent = Math.max(0, Math.round((currentScore / totalPossible) * 100));
  resScore.textContent = `${currentScore} نقطة`;
  resDetails.innerHTML = `
    <div class="small-muted">${lang==='ar'?'القسم':'Section'}: ${lang==='ar'?QUIZZES[currentSection].title_ar:QUIZZES[currentSection].title_en}</div>
    <div style="margin-top:8px">${lang==='ar'?'الإجابات الصحيحة':'Correct'}: <strong>${correctCount}/${totalQuestions}</strong> — ${lang==='ar'?'الخاطئة/المتجاوزة':'Wrong/Skipped'}: <strong>${wrongCount}</strong></div>
    <div style="margin-top:8px">${lang==='ar'?'النسبة':'Percent'}: <strong>${percent}%</strong></div>
  `;
  const level = determineLevel(currentScore);
  document.getElementById('resTitle').textContent = (lang==='ar'?'النتيجة النهائية':'Final Result') + ` — ${level.name}`;
  // save result
  const entry = { id: Date.now(), section: currentSection, score: currentScore, when: new Date().toISOString(), level: level.name, lang };
  leaderboard.push(entry); leaderboard.sort((a,b)=> b.score - a.score);
  if(leaderboard.length>100) leaderboard = leaderboard.slice(0,100);
  localStorage.setItem('geo_leaderboard', JSON.stringify(leaderboard));
  savedNote.textContent = t('savedNote');
  resultModal.style.display = 'flex';
}

/* ---------- Levels ---------- */
function determineLevel(score){
  if(score >= 250) return { name: (lang==='ar'?'خبير 💎':'Expert 💎'), color:'#ffd700' };
  if(score >= 150) return { name: (lang==='ar'?'ميداني 🪨':'Field Pro 🪨'), color:'#c0c0c0' };
  if(score >= 50) return { name: (lang==='ar'?'متقدم 🔰':'Advanced 🔰'), color:'#7dd3fc' };
  return { name: (lang==='ar'?'مبتدئ':'Beginner'), color:'#94a3b8' };
}
function updateLevelBadge(){ const lv = determineLevel(currentScore); levelBadge.textContent = `${lang==='ar'?'المستوى':'Level'}: ${lv.name}`; }

/* ---------- Retry / close ---------- */
retryBtn.addEventListener('click', ()=> { resultModal.style.display='none'; startSection(currentSection); });
closeResBtn.addEventListener('click', ()=> { resultModal.style.display='none'; showDashboard(); });

/* ---------- Back to menu ---------- */
backToMenu.addEventListener('click', showDashboard);

/* ---------- Leaderboard ---------- */
leaderBtn.addEventListener('click', ()=>{
  const board = JSON.parse(localStorage.getItem('geo_leaderboard')||'[]');
  if(board.length===0){ alert(t('leaderboardEmpty')); return; }
  let out = (lang==='ar'?'لوحة النتائج (أعلى 20):\n\n':'Leaderboard (top 20):\n\n');
  board.slice(0,20).forEach((e,i)=>{
    const title = (lang==='ar'? QUIZZES[e.section].title_ar : QUIZZES[e.section].title_en);
    const scoreText = (lang==='ar'? `${e.score} نقطة` : `${e.score} points`);
    out += `${i+1}. ${title} — ${scoreText} — ${e.level} — ${new Date(e.when).toLocaleDateString(lang)}\n`;
  });
  alert(out);
});

/* ---------- Language Toggle ---------- */
langToggle.addEventListener('click', () => {
    lang = (lang === 'ar') ? 'en' : 'ar';
    localStorage.setItem('geo_lang', lang);
    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
    refreshLangUI();
    renderSectionCards();
    updateLevelBadge();
});

/* ---------- Init ---------- */
function init(){
  refreshLangUI();
  updateProgressUI();
  scoreVal.textContent = '0';
  updateLevelBadge();
  // show dashboard by default
  showDashboard();
  // resume audio on gesture
  document.addEventListener('click', ()=> { if(audioCtx.state==='suspended') audioCtx.resume(); }, { once:true });
}
init();

</script>
</body>
</html>