بالتأكيد! لقد قمت بتطبيق كافة التحسينات المطلوبة لإنشاء واجهة مستخدم عصرية وجذابة ومحسّنة للهاتف، مع التركيز على الهوية البصرية الجيولوجية ونظام المستويات والشارات.
تم اعتماد خط Tajawal للغة العربية لسهولته ووضوحه، وتم استخدام ألوان Geo-Pallet المقترحة (البني الرملي، الأزرق السماوي، الأخضر الزيتي) لتعزيز المظهر الجيولوجي.
إليك الكود الكامل والمحسن:
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoQuest! — تحدي الجيولوجي الميداني</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800;900&display=swap" rel="stylesheet">
<style>
  /* ---------------------------------------------------------------------- */
  /* GeoReady Pallet (البني الرملي، الأزرق السماوي، الأخضر الزيتي) */
  /* ---------------------------------------------------------------------- */
  :root{
    --bg1: #09131D; /* خلفية داكنة جداً (أزرق داكن) */
    --card: #122338; /* لون البطاقات الرئيسي */
    --muted: #B3C0D0; /* نص خافت */

    --color-sand: #C9A86A; /* بني رملي / ذهبي (للنقاط والمستويات) */
    --color-sky: #06B6D4; /* أزرق سماوي (للأزرار والـAccent1) */
    --color-oil: #528B6A; /* أخضر زيتي (للنجاح) */
    --color-rock: #A65628; /* لون الصخر (للتنبيه) */

    --accent1: var(--color-sky);
    --accent2: #7c3aed;
    --accent3: var(--color-sand);
    --good: var(--color-oil); /* أخضر زيتي للنجاح */
    --bad: var(--color-rock); /* بني صخري للأخطاء */
    --glass: rgba(255,255,255,0.03);
    --font-arabic: 'Tajawal', sans-serif;
  }
  /* ---------------------------------------------------------------------- */
  /* General Styles */
  /* ---------------------------------------------------------------------- */
  *{box-sizing:border-box}
  body{margin:0;font-family:var(--font-arabic), "Segoe UI", Arial, sans-serif; background:linear-gradient(180deg,var(--bg1) 0%,#08172c 70%); color:#eef7ff; direction:rtl;}
  .wrap{max-width:600px;margin:0 auto;padding:12px}
  /* ---------------------------------------------------------------------- */
  /* Header & Branding */
  /* ---------------------------------------------------------------------- */
  header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:8px}
  /* شعار مخصص بألوان الجيولوجيا */
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--color-sand),var(--color-oil));display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff; font-size:18px; box-shadow:0 4px 10px rgba(0,0,0,0.3)}
  h1{margin:0;font-size:18px; line-height:1.2; font-weight:800;}
  .subtitle{color:var(--muted);font-size:12px}
  .controls{display:flex;gap:6px;align-items:center}
  button.btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;padding:10px 16px;border-radius:8px;color:#fff;cursor:pointer;font-weight:700; font-size:14px; transition:all 0.3s;}
  button.btn:hover{box-shadow:0 0 15px rgba(6,182,212,0.4);}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:7px 12px;border-radius:8px;color:var(--muted); font-size:13px; transition:background 0.3s;}
  button.ghost:hover{background:rgba(255,255,255,0.05);}
  .lang-toggle{background:rgba(255,255,255,0.05);padding:6px 8px;border-radius:6px;cursor:pointer;color:var(--muted); font-size:12px}
  .container{background:var(--card);border-radius:12px;padding:15px;box-shadow:0 8px 30px rgba(2,6,23,0.5); border:1px solid rgba(255,255,255,0.05);}
  /* ---------------------------------------------------------------------- */
  /* Main Progress / Welcome Panel (لوحة التقدم الرئيسية) */
  /* ---------------------------------------------------------------------- */
  .progress-panel{background:var(--bg1); padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.06); text-align:center;}
  .welcome-title{font-size:20px; font-weight:900; color:var(--accent3); margin:0 0 10px 0;}
  .stats-grid{display:flex; justify-content:space-around; align-items:center; margin-bottom:15px; gap:10px;}
  .stat-item{text-align:center; flex:1; padding:8px 0; border-right:1px solid rgba(255,255,255,0.05); }
  .stat-item:last-child { border-right: none; }
  .stat-value{font-size:18px; font-weight:900; color:var(--color-sky);}
  .stat-label{font-size:11px; color:var(--muted);}
  .start-btn-wrap{margin-top:15px;}
  /* ---------------------------------------------------------------------- */
  /* Levels and Badges (المستويات والشارات) */
  /* ---------------------------------------------------------------------- */
  .level-info{
      background: rgba(201,168,106, 0.1); /* خلفية بلون الرمل الخافت */
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      text-align: right;
  }
  .level-bar{
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      margin-top: 5px;
      overflow: hidden;
  }
  .level-bar-inner{
      height: 100%;
      background: linear-gradient(90deg, var(--color-sand), var(--color-oil));
      transition: width 0.5s ease-out;
  }
  .badges-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 15px;
  }
  .badge-item {
      padding: 6px 10px;
      background: var(--card);
      border: 1px solid var(--color-oil);
      border-radius: 6px;
      font-size: 11px;
      color: var(--color-oil);
      font-weight: 700;
  }
  /* ---------------------------------------------------------------------- */
  /* Section Cards (بطاقات الأقسام) */
  /* ---------------------------------------------------------------------- */
  .sections{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:12px}
  .section-card{background:var(--bg1);padding:14px;border-radius:10px;cursor:pointer;transition:transform .22s,box-shadow .22s;box-shadow:0 4px 12px rgba(0,0,0,0.4); border-left: 4px solid var(--accent1);}
  .section-card:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(0,0,0,0.5);}
  .section-title{font-weight:800;font-size:16px; display:flex; align-items:center; gap:8px;}
  .section-desc{color:var(--muted);font-size:12px;margin-top:4px}
  .section-icon{font-size:1.1em; color:var(--accent3);}
  /* ---------------------------------------------------------------------- */
  /* Quiz Area Styles */
  /* ---------------------------------------------------------------------- */
  .quiz-area{margin-top:8px;min-height:300px;position:relative;overflow:hidden}
  .question-card{background:var(--bg1);padding:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);transition:transform .35s,opacity .35s; box-shadow:0 4px 20px rgba(0,0,0,0.4);}
  .question-meta{display:flex;flex-direction:column-reverse;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px}
  .qnum{font-weight:800;color:var(--color-sky);padding:4px 8px;border-radius:6px;background:rgba(255,255,255,0.05); font-size:14px}
  .timer{font-weight:900;padding:6px 12px;border-radius:8px;background:var(--bad); /* لون التنبيه */ color:#fff; min-width:65px; text-align:center; font-size:16px; box-shadow:0 2px 5px rgba(166,86,40,0.5);}
  .question-meta > div:last-child {display:flex;gap:12px;align-items:center; width:100%; justify-content:space-between;}
  .scorebox{min-width:120px;text-align:center; padding: 4px 0;}
  .score-value{font-size:18px;font-weight:900;color:var(--accent3)}
  .level-badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.05);margin-top:4px;color:var(--muted); font-size:11px}
  .question-text{font-size:16px;font-weight: bold; margin:15px 0 10px; padding:10px; border-right:3px solid var(--accent1);}
  .answers{display:flex;flex-direction:column;gap:10px}
  .answer{background:var(--card);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);cursor:pointer;transition:transform .15s,background .15s;display:flex;align-items:center;gap:10px; font-size:14px}
  .answer:hover{transform:translateY(-2px); background:rgba(255,255,255,0.08);}
  .answer .opt-label{min-width:28px;text-align:center;font-weight:800; font-size:15px; color:var(--accent1);}
  .answer.correct { background: var(--good); color: #fff; border-color: var(--color-oil); }
  .answer.wrong { background: var(--bad); color: #fff; border-color: var(--color-rock); }
  /* ---------------------------------------------------------------------- */
  /* Footer & General Layout */
  /* ---------------------------------------------------------------------- */
  .controls-bottom{display:flex;gap:6px;align-items:center;margin-top:10px; flex-wrap:wrap; justify-content:space-between}
  .controls-bottom .ghost { flex-grow:1; }
  .controls-bottom #timeTip { order:3; flex-basis:100%; text-align:center; margin-top:6px; }

  footer{font-size:11px; padding-bottom: 20px;}
  /* ---------------------------------------------------------------------- */
  /* Media Queries (لشاشات العرض الكبيرة) */
  /* ---------------------------------------------------------------------- */
  @media(min-width:600px){
    .wrap{max-width:900px;margin:18px auto;padding:16px}
    .sections{grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:14px}
    .section-card:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .question-meta{display:flex;flex-direction:row; gap:10px; margin-bottom:12px; }
    .question-meta > div:last-child { width:auto; justify-content:flex-end; }
    .scorebox{min-width:220px; text-align:center; padding: 0;}
    h1{font-size:22px}
    .subtitle{font-size:14px}
  }

  /* ---------------------------------------------------------------------- */
  /* Training Content (محتوى التدريب) */
  /* ---------------------------------------------------------------------- */
  #trainingContent {
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.05);
  }
  #trainingContent h2 { color: var(--accent1); font-size: 1.2em; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 5px; margin-top: 1.5em; font-weight: 700; }
  #trainingContent h2:first-of-type { margin-top: 0; }
  #trainingContent ul { padding-right: 25px; list-style-type: '🪨 '; line-height: 1.8; }
  #trainingContent table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
  #trainingContent th, #trainingContent td { border: 1px solid rgba(255,255,255,0.1); padding: 8px; text-align: right; }
  #trainingContent th { background: rgba(255,255,255,0.05); color: var(--accent3); }
  .math { display: block; margin: 10px 0; font-family: monospace; direction: ltr; text-align: left; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 4px; }
  .math strong { color: var(--color-sky); }
  .example { background: rgba(255,255,255,0.02); padding: 10px; border-radius: 6px; border-right: 3px solid var(--accent3); margin-top: 8px; font-size: 0.9em;}

</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">GQ</div>
        <div>
          <h1>GeoQuest!</h1>
          <div class="subtitle">مرحبًا بك في تحدي الجيولوجي الميداني</div>
        </div>
      </div>

      <div class="controls">
        <div class="lang-toggle" id="langToggle">العربي / EN</div>
        <button class="ghost" id="leaderBtn">النتائج</button>
      </div>
    </header>

    <main class="container">
      <div class="progress-panel" id="mainProgressPanel">
        <div class="welcome-title" id="welcomeUser">مرحبًا أيها الجيولوجي الميداني!</div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="totalScore">0</div>
                <div class="stat-label">إجمالي النقاط</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="userLevel">Trainee 1</div>
                <div class="stat-label">مستواك الحالي</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completedQuizzes">0/4</div>
                <div class="stat-label">الاختبارات المنجزة</div>
            </div>
        </div>
        
        <div class="level-info">
            <div style="display:flex; justify-content:space-between; font-size:12px;">
                <span id="currentLevelLabel">المستوى الحالي: <strong>Trainee 1</strong></span>
                <span id="levelProgressLabel">النقاط: 0 / 50</span>
            </div>
            <div class="level-bar"><div class="level-bar-inner" id="levelBarInner" style="width:0%"></div></div>
        </div>

        <div class="start-btn-wrap">
             <button class="btn" id="startChallengeBtn">ابدأ التحدي الآن 🔥</button>
        </div>

        <div class="badges-grid" id="badgesGrid">
            </div>
      </div>
      
      <section>
        <div class="sections" id="sectionList"></div>
        <div id="trainingContent" style="display:none"></div>
      </section>

      <section class="quiz-area" id="quizArea" style="display:none">
        <div class="question-card fade-in" id="questionCard">
          <div class="question-meta">
            <div class="qnum" id="qLabel">السؤال 1 / Q1</div>
            <div style="display:flex;gap:12px;align-items:center">
              <div class="scorebox">
                <div class="small-muted" id="scoreLabel">النقاط</div>
                <div class="score-value" id="scoreVal">0</div>
                <div class="level-badge" id="levelBadge">مبتدئ</div>
              </div>
              <div class="timer" id="timerLabel">00:30</div>
            </div>
          </div>

          <div class="question-text" id="qText">نص السؤال …</div>
          <div class="answers" id="answersBox"></div>

          <div class="controls-bottom" style="border-top:1px solid rgba(255,255,255,0.05); padding-top:12px;">
            <div style="display:flex; align-items:center; gap:8px;">
                <div class="small-muted" id="progressLabel">السؤال 1 من 30</div>
                <div class="progress-bar" style="width:100px; height:8px;"><div id="progInner"></div></div>
            </div>
            <button class="ghost" id="backToMenu">العودة للقائمة</button>
            <button class="ghost" id="skipBtn" style="flex-grow:0; min-width:80px;">تجاوز</button>
          </div>
        </div>
      </section>

    </main>

    <footer style="text-align:center;color:var(--muted);margin-top:10px">GeoQuest! — تطبيق تدريبي محلي • يحفظ النتائج في المتصفح</footer>
  </div>

  <div id="resultModal" class="result-panel" style="display:none">
    <div class="result-card">
      <h2 id="resTitle">النتيجة النهائية</h2>
      <div class="bigscore" id="resScore">0 نقطة</div>
      <div class="res-details" id="resDetails"></div>
      <div class="res-actions">
        <button class="btn" id="retryBtn">إعادة المحاولة</button>
        <button class="ghost" id="closeResBtn">إغلاق</button>
      </div>
      <div style="margin-top:10px" class="small-muted" id="savedNote"></div>
    </div>
  </div>

<script>
/* ---------------------------------------------------------------------- */
/* GeoQuest! Application Logic (JS) */
/* ---------------------------------------------------------------------- */

/* ---------- Training Content (The 12 Sections) ---------- */
const FULL_TRAINING_SECTIONS = [
  { id: 'intro', icon: '🧭', title_ar: 'القسم 1 — مقدمة الجيولوجي الميداني', quiz_key: 'general', content: `
    <h2>📘 الشرح الكامل</h2>
    الجيولوجي الميداني هو **العين العلمية** للمشاريع الأرضية. وظيفته تبدأ من جمع البيانات وتنتهي بتفسيرها وربطها بالواقع الجيوميكانيكي والهيدروجيولوجي.
    <h2>⚙️ الأمثلة العملية (المهارات المطلوبة)</h2>
    <ul>
      <li>الملاحظة الدقيقة.</li>
      <li>الدقة في الوصف والتوثيق.</li>
      <li>استخدام الأدوات الميدانية.</li>
      <li>التفكير التحليلي وربط الظواهر.</li>
    </ul>
    <h2>❓ الأسئلة والإجابات النموذجية</h2>
    <p><strong>ما هو الهدف الرئيسي للجيولوجي الميداني؟</strong><br>✅ تحليل وتفسير الظواهر الجيولوجية بدقة بناءً على بيانات الحقل.</p>
    <p><strong>ما أهم صفة للجيولوجي الناجح؟</strong><br>✅ الانتباه للتفاصيل والملاحظة الدقيقة.</p>
    <p><strong>لماذا يجب أن يكون الجيولوجي قادرًا على العمل في ظروف صعبة؟</strong><br>✅ لأن العمل الحقلي يتم في بيئات قاسية وغير مستقرة.</p>
  `},
  { id: 'tools', icon: '⛏️', title_ar: 'القسم 2 — الأدوات الجيولوجية واستخدامها', quiz_key: 'general', content: `
    <h2>📘 المحتوى (أهم الأدوات)</h2>
    <table>
      <tr><th>الأداة</th><th>الاستعمال</th></tr>
      <tr><td>Brunton Compass</td><td>قياس الاتجاه والميل (Strike & Dip)</td></tr>
      <tr><td>Rock Hammer</td><td>كسر الصخور وأخذ عينات</td></tr>
      <tr><td>Hand Lens (10x)</td><td>فحص المعادن والحبيبات</td></tr>
      <tr><td>GPS</td><td>تحديد الإحداثيات بدقة</td></tr>
    </table>
    <h2>⚙️ تدريب عملي</h2>
    <ul>
      <li>استخدم البوصلة لتحديد ميل الطبقات.</li>
      <li>قارن بين عينتين من الحجر الرملي وعدد الحبيبات بالمجهر اليدوي.</li>
      <li>سجل موقعك في GPS واحفظ الإحداثيات.</li>
    </ul>
  `},
  { id: 'rocks', icon: '🌋', title_ar: 'القسم 3 — الصخور وأنواعها', quiz_key: 'petro', content: `
    <h2>📘 المحتوى</h2>
    تنقسم الصخور إلى ثلاثة أنواع رئيسية:
    <ul>
      <li>**نارية (Igneous):** تتكوّن من تبريد الصهارة. 🧱 أمثلة: البازلت، الغرانيت.</li>
      <li>**رسوبية (Sedimentary):** تتكوّن من ترسيب الفتات أو الأملاح. 🪶 أمثلة: الحجر الرملي، الكلسي.</li>
      <li>**متحولة (Metamorphic):** تتكوّن تحت الضغط والحرارة. 🪨 أمثلة: الشيست، النايس.</li>
    </ul>
    <h2>⚙️ ملاحظات ميدانية</h2>
    <ul>
      <li>الصخور النارية **داكنة وثقيلة** (عادةً).</li>
      <li>الرسوبية تحتوي على **طبقات وفواصل واضحة**.</li>
      <li>المتحولة فيها **خطوط متموجة (foliation)**.</li>
    </ul>
    <h2>❓ الأسئلة والإجابات النموذجية</h2>
    <p><strong>ما الفرق بين البازلت والغرانيت؟</strong><br>✅ البازلت سطحي داكن، الغرانيت جوفي فاتح اللون.</p>
    <p><strong>هل الرخام صخر رسوبي؟</strong><br>❌ لا، هو صخر متحوّل من الحجر الجيري.</p>
  `},
  { id: 'hydro', icon: '💧', title_ar: 'القسم 4 — الهيدروجيولوجيا الميدانية', quiz_key: 'hydro', content: `
    <h2>📘 المحتوى</h2>
    الهيدروجيولوجيا تدرس حركة وتوزيع المياه الجوفية. تعتمد على: **قانون دارسي** و **المسامية والنفاذية**.
    <h2>🧮 الحسابات المهمة</h2>
    1. معدل الجريان (Q):
    <div class="math">Q = K &times; A &times; (&#916;h / L)</div>
    2. المسامية (&phi;):
    <div class="math">&phi; = (Vv / Vt) &times; 100</div>
    <h2>❓ الأسئلة والإجابات النموذجية</h2>
    <p><strong>ماذا يقيس قانون دارسي؟</strong><br>✅ معدل تدفق المياه الجوفية عبر طبقة.</p>
    <p><strong>ما معنى EC؟</strong><br>✅ Electrical Conductivity – ملوحة المياه.</p>
  `},
  { id: 'calcs', icon: '🧮', title_ar: 'القسم 5 — الحسابات الجيولوجية', quiz_key: null, content: `
    <h2>📘 المعادلات الأساسية</h2>
    <table>
      <tr><th>المعادلة</th><th>المعنى</th><th>وحدة النتيجة</th></tr>
      <tr><td>ROP = &Delta;h/&Delta;t</td><td>سرعة الحفر</td><td>m/h</td></tr>
      <tr><td>&phi; = Vv/Vt &times; 100</td><td>المسامية</td><td>%</td></tr>
      <tr><td>T = K &times; b</td><td>النفاذية الطبقية</td><td>m&sup2;/s</td></tr>
    </table>
  `},
  { id: 'log', icon: '🧱', title_ar: 'القسم 6 — السجل الطبقي (Lithological Log)', quiz_key: null, content: `
    <h2>📘 مثال على السجل</h2>
    <table>
      <tr><th>From</th><th>To</th><th>نوع الصخر</th><th>الملاحظات</th></tr>
      <tr><td>0</td><td>2</td><td>طين رمادي</td><td>رطب – نفاذية ضعيفة</td></tr>
      <tr><td>2</td><td>5</td><td>رمل ناعم بني</td><td>نفاذية عالية</td></tr>
    </table>
    <h2>❓ الأسئلة والإجابات النموذجية</h2>
    <p><strong>ما أهمية السجل الطبقي؟</strong><br>✅ تحديد الطبقات الحاملة للماء أو النفط.</p>
  `},
  { id: 'drilling', icon: '⚙️', title_ar: 'القسم 7 — مهام الجيولوجي أثناء الحفر', quiz_key: null, content: `
    <h2>📘 المهام الرئيسية</h2>
    <ul>
      <li>مراقبة تقدم الحفر وتسجيل العمق.</li>
      <li>وصف عينات cuttings أو core.</li>
      <li>حساب نسبة استعادة النواة (**Core Recovery**).</li>
      <li>قياس منسوب الماء الجوفي.</li>
    </ul>
    <h2>❓ الأسئلة والإجابات النموذجية</h2>
    <p><strong>ما معنى Core Recovery؟</strong><br>✅ نسبة النواة المستخرجة إلى العمق المحفور.</p>
  `},
  { id: 'safety', icon: '🧯', title_ar: 'القسم 8 — السلامة الميدانية', quiz_key: null, content: `
    <h2>📘 قواعد السلامة الأساسية</h2>
    <ul>
      <li>ارتداء **الخوذة والنظارات**.</li>
      <li>الابتعاد عن أنبوب الحفر.</li>
      <li>معرفة موقع وتشغيل **زر الطوارئ**.</li>
      <li>حمل **حقيبة إسعافات** أولية.</li>
    </ul>
  `},
  { id: 'analysis', icon: '🧪', title_ar: 'القسم 9 — تحليل العينات', quiz_key: null, content: `
    <h2>📘 التحاليل المطلوبة</h2>
    <table>
      <tr><th>نوع العينة</th><th>التحليل المطلوب</th><th>الهدف</th></tr>
      <tr><td>صخرية</td><td>XRD / Thin Section</td><td>تحديد المعادن</td></tr>
      <tr><td>مياه</td><td>pH, EC, TDS</td><td>تقييم الجودة</td></tr>
      <tr><td>تربة</td><td>Grain Size / Permeability</td><td>تحديد قابلية الترشيح</td></tr>
    </table>
  `},
  { id: 'maps_interpret', icon: '🗺️', title_ar: 'القسم 10 — الخرائط والتفسير الجيولوجي', quiz_key: 'maps', content: `
    <h2>📘 المحتوى</h2>
    <ul>
      <li>قراءة الخرائط الطبوغرافية والجيولوجية.</li>
      <li>تحديد الفوالق والطيات.</li>
      <li>ترسيم حدود التكوينات ومناطق التماس.</li>
    </ul>
    <h2>⚙️ تدريب ميداني</h2>
    <ul>
      <li>ارسم مقطع جيولوجي بسيط من خريطة.</li>
      <li>حدّد مواقع الآبار المحتملة.</li>
    </ul>
  `},
  { id: 'quiz_final', icon: '🧩', title_ar: 'القسم 11 — الاختبارات النهائية', quiz_key: null, content: `
    <h2>📘 أسئلة اختيار من متعدد (أمثلة)</h2>
    <p><strong>أي من الصخور التالية نارية؟</strong><br>ب) الغرانيت ✅</p>
    <p><strong>أي خاصية تحدد قدرة الطبقة على نقل الماء؟</strong><br>✅ النفاذية (Permeability)</p>
    <p><strong>لإجراء اختبار شامل:</strong> يرجى إجراء جميع الاختبارات الأربعة (Hydro, Petro, Maps, General) في القائمة الرئيسية.</p>
  `},
  { id: 'evaluation', icon: '🏁', title_ar: 'القسم 12 — تقييم الجاهزية المهنية', quiz_key: null, content: `
    <h2>📘 جدول التقييم</h2>
    <table>
      <tr><th>البند</th><th>التقييم</th></tr>
      <tr><td>دقة الملاحظات الميدانية</td><td>✅ ممتاز</td></tr>
      <tr><td>الالتزام بالسلامة</td><td>✅ ممتاز</td></tr>
      <tr><td>القدرة على التفسير والتحليل</td><td>✅ ممتاز</td></tr>
    </table>
  `}
];


/* ---------- Language ---------- */
const LANGS = {
  ar: {
    start: "ابدأ التحدي الآن 🔥",
    skip: "تجاوز",
    retry: "إعادة المحاولة",
    close: "إغلاق",
    score: "النقاط",
    level: "المستوى",
    questionOf: "سؤال {i} من {n}",
    savedNote: "تم حفظ النتيجة محليًا.",
    leaderboardEmpty: "لا نتائج محفوظة بعد.",
    backToMenu: "العودة للقائمة",
    viewContent: "عرض المحتوى التدريبي",
    startQuiz: "ابدأ الاختبار",
    welcome: "مرحبًا بك في GeoQuest!👋",
    totalScore: "إجمالي النقاط",
    currentLevel: "مستواك الحالي",
    completed: "الاختبارات المنجزة",
    levelPrefix: "المستوى الحالي:",
    points: "النقاط:",
  },
  en: {
    start: "Start Challenge Now 🔥",
    skip: "Skip",
    retry: "Retry",
    close: "Close",
    score: "Score",
    level: "Level",
    questionOf: "Q {i} of {n}",
    savedNote: "Saved locally.",
    leaderboardEmpty: "No saved results yet.",
    backToMenu: "Back to Menu",
    viewContent: "View Training Content",
    startQuiz: "Start Quiz",
    welcome: "Welcome to GeoQuest!👋",
    totalScore: "Total Score",
    currentLevel: "Your Level",
    completed: "Quizzes Completed",
    levelPrefix: "Current Level:",
    points: "Points:",
  }
};
let lang = localStorage.getItem('geo_lang') || 'ar';
const langToggle = document.getElementById('langToggle');
function t(key, vars){ const s = LANGS[lang][key] || key; if(!vars) return s; return s.replace(/{(\w+)}/g,(m,k)=>vars[k]||m); }
function refreshLangUI(){
  document.getElementById('scoreLabel').textContent = t('score');
  document.getElementById('skipBtn').textContent = t('skip');
  document.getElementById('retryBtn').textContent = t('retry');
  document.getElementById('closeResBtn').textContent = t('close');
  document.getElementById('backToMenu').textContent = t('backToMenu');
  document.getElementById('startChallengeBtn').textContent = t('start');
  
  // تحديث لوحة التقدم الرئيسية
  document.getElementById('welcomeUser').textContent = t('welcome');
  document.querySelector('.stats-grid .stat-item:nth-child(1) .stat-label').textContent = t('totalScore');
  document.querySelector('.stats-grid .stat-item:nth-child(2) .stat-label').textContent = t('currentLevel');
  document.querySelector('.stats-grid .stat-item:nth-child(3) .stat-label').textContent = t('completed');
  
  langToggle.textContent = (lang==='ar')? 'العربي / EN' : 'AR / English';
}

/* ---------- Quiz data (4×30) (كما تم تضمينه في المرة السابقة) ---------- */
const QUIZZES = {
  hydro: { id: 'hydro', title_ar:"💧 الهيدروجيولوجيا", title_en:"💧 Hydrogeology", items: /* 30 Qs */ [
    { q_ar:"ما الفرق بين الطبقة المائية الحرة والمحبوسة؟", q_en:"Difference between unconfined and confined aquifer?", choices_ar:["الحرة لها منسوب ماء متساوٍ مع الضغط الجوي، المحبوسة تحت ضغط ارتوازي","الحرة أقل نفاذية من المحبوسة","المحبوسة فوق السطح فقط","الحرة مكّونة من الصخور النارية فقط"], choices_en:["Unconfined has water table; confined under artesian pressure","Unconfined less permeable than confined","Confined exists only at surface","Unconfined made of igneous rocks only"], answerIndex:0 },
    { q_ar:"ما نوع الصخور التي تشكل أفضل خزانات مائية؟", q_en:"Which rock types make the best aquifers?", choices_ar:["الرمل والحصى والحجر الجيري المتشقق","الصخور الطينية المدمجة","الصخور البلورية غير المشققة","الشُعَب البركانية"], choices_en:["Sands, gravels and fractured limestones","Compact clays","Unfractured crystalline rocks","Volcanic reefs"], answerIndex:0 },
    { q_ar:"ما المقصود بالـ Aquiclude؟", q_en:"What is an aquiclude?", choices_ar:["طبقة تمنع مرور المياه عمليًا (طينية عادة)","خزان مائي عالي النفاذية","مجرى نهري سطحي","وحدة صخرية بركانية"], choices_en:["A layer that practically prevents water flow (usually clay)","A highly permeable aquifer","A surface river channel","A volcanic rock unit"], answerIndex:0 },
    { q_ar:"ما هو المنسوب الساكن للمياه الجوفية؟", q_en:"What is static water level?", choices_ar:["مستوى الماء في البئر عند عدم الضخ","أعمق نقطة في الخزان","مستوى المد والجزر","مستوى الأمطار السنوية"], choices_en:["Water level in well when not pumped","Deepest point of aquifer","Tidal level","Annual rainfall level"], answerIndex:0 },
    { q_ar:"كيف يُقاس التصريف من بئر منتجة؟", q_en:"How is well discharge measured?", choices_ar:["بمقياس التدفق أو تأثير مستوى الانخفاض عبر الزمن","بالتصوير الجوي فقط","بمقياس الحرارة","بالتحليل البلوري"], choices_en:["Using flow meter or measuring drawdown over time","By aerial imaging only","With thermometer","By crystal analysis"], answerIndex:0 },
    { q_ar:"ماذا يعني Recharge area؟", q_en:"What is recharge area?", choices_ar:["منطقة تغذية الخزان من السطح","منطقة تسرّب مياه الصرف فقط","خزان سطحي مغلق","منطقة غير مهمة"], choices_en:["Area where aquifer is recharged from surface","Only sewage leak zone","Closed surface pond","Unimportant area"], answerIndex:0 },
    { q_ar:"ما العلاقة بين النفاذية والتوصيل الهيدروليكي؟", q_en:"Relation between permeability and hydraulic conductivity?", choices_ar:["التوصيل الهيدروليكي يتضمن النفاذية بالإضافة لخواص السائل","لا علاقة","نفاذية أكبر تعني توصيل أصغر","هما نفس الشيء تمامًا"], choices_en:["Hydraulic conductivity includes permeability plus fluid properties","No relation","Higher permeability means lower conductivity","They are exactly same"], answerIndex:0 },
    { q_ar:"ما الاختبار الميداني لتحديد النفاذية؟", q_en:"Which field test determines permeability?", choices_ar:["اختبار الضخ (Pumping test) أو Slug test","المسح الجيوفيزيائي فقط","اختبار الانبعاث الطيفي","تحاليل ميكروسكوبية فقط"], choices_en:["Pumping test or slug test","Only geophysical survey","Spectral emission test","Only microscopic analyses"], answerIndex:0 },
    { q_ar:"ما تأثير الضخ المفرط على منسوب المياه؟", q_en:"Effect of overpumping on groundwater levels?", choices_ar:["انخفاض منسوب المياه وتشكّل مخروط انخفاض","ارتفاع دائم لمنسوب الماء","لا تأثير","زيادة التكوّن الحيوي"], choices_en:["Water level decline and drawdown cone","Permanent rise in water level","No effect","Increased bioactivity"], answerIndex:0 },
    { q_ar:"ما الفرق بين البئر التجريبية والبئر الإنتاجية؟", q_en:"Difference between exploratory and production well?", choices_ar:["التجريبية للاختبار والقياسات، والإنتاجية للاستغلال والتزويد بالمياه","كلاهما نفس الوظيفة","التجريبية أكبر حجما","الانتاجية تستخدم للبحوث فقط"], choices_en:["Exploration for testing; production for supply","Both same","Exploration larger","Production used only for research"], answerIndex:0 },
    { q_ar:"ما الغرض من اختبار الضخ؟", q_en:"Purpose of pumping test?", choices_ar:["تحديد نفاذية الخزان ومعامل التخزين وسلوك الضخ","معرفة تركيب الصخور البلورية","تحديد نوع المعادن الثقيلة","تحديد مستوى الملوحة فقط"], choices_en:["Determine aquifer permeability and storage coefficients","Identify crystalline rock types","Find heavy minerals","Only determine salinity"], answerIndex:0 },
    { q_ar:"كيف تحدد اتجاه تدفق المياه الجوفية؟", q_en:"How determine groundwater flow direction?", choices_ar:["برسم خطوط تساوي المنسوب (potentiometric contours) بين الآبار","بحساب سرعة الرياح","بقياسات الحرارة فقط","عن طريق صور الاقمار فقط"], choices_en:["By plotting potentiometric contours from wells","By wind speed calculation","By temperature only","Using satellite images only"], answerIndex:0 },
    { q_ar:"ماذا تعني زيادة الملوحة مع الزمن في بئر؟", q_en:"What does rising salinity over time indicate?", choices_ar:["تداخل مياه مالحة (بحرية) أو تلوث مصدر عميق","تحسّن جودة المياه","زيادة الأكسجين","تغير الطقس فقط"], choices_en:["Sea water intrusion or deep saline source contamination","Improved water quality","Increased oxygen","Weather change only"], answerIndex:0 },
    { q_ar:"ما الغرض من التحليل الهيدروكيميائي؟", q_en:"Purpose of hydrochemical analysis?", choices_ar:["تحديد مصدر المياه، التلوث، وقابلية الاستخدام","قياس الضغط فقط","تحليل الصخور","تحديد نوع البكتيريا فقط"], choices_en:["Identify water source, contamination and suitability","Measure pressure only","Analyze rocks","Identify bacteria only"], answerIndex:0 },
    { q_ar:"ما صيغة قانون دارسي الأساسية؟", q_en:"Basic Darcy's law equation?", choices_ar:["Q = -K A (dh/dl)","Q = m v","P = ρgh","Q = A v^2"], choices_en:["Q = -K A (dh/dl)","Q = m v","P = ρgh","Q = A v^2"], answerIndex:0 },
    { q_ar:"ما أثر تلوث السطح على المياه الجوفية؟", q_en:"Effect of surface contamination on groundwater?", choices_ar:["تسرب الملوثات إلى الخزان عبر مناطق التغذية مما يضر بالمياه","لا تأثير عادة","يزيد نفاذية التربة","ينخفض مستوى الماء فقط"], choices_en:["Pollutants percolate to aquifer via recharge zones","Usually no effect","Increases soil permeability","Only lowers water level"], answerIndex:0 },
    { q_ar:"كيف تحدد حدود الخزان من الخرائط؟", q_en:"How delineate aquifer boundaries from maps?", choices_ar:["بمقارنة التكوينات الحاملة ومساحات الصخور النفوذية وخطوط التماس","من مقياس الخريطة فقط","بواسطة الصور الجوية فقط","عن طريق قياس درجة الحرارة فقط"], choices_en:["By mapping permeable formations and contact extents","From map scale only","Using aerial photos alone","By measuring temperature only"], answerIndex:0 },
    { q_ar:"ما الفرق بين المسامية الكلية والفعالة؟", q_en:"Difference between total porosity and effective porosity?", choices_ar:["الفعالة هي الفراغات المتصلة القابلة لتدفق الماء، الكلية تشمل كل الفراغات","هما متماثلتان","الكلية أصغر دائماً","المسامية لا تتعلق بالماء"], choices_en:["Effective porosity is connected pores allowing flow; total includes all pores","They are identical","Total is always smaller","Porosity unrelated to water"], answerIndex:0 },
    { q_ar:"ما معنى Drawdown؟", q_en:"What is drawdown?", choices_ar:["انخفاض مستوى الماء نتيجة الضخ في البئر","ارتفاع مستوى الماء","تغير درجة الملوحة","تغير في الضغط الجوي"], choices_en:["Decline in water level due to pumping","Rise in water level","Change in salinity","Change in atmospheric pressure"], answerIndex:0 },
    { q_ar:"ما العوامل المؤثرة على جودة المياه الجوفية؟", q_en:"Factors affecting groundwater quality?", choices_ar:["نوع الصخور، الأنشطة البشرية، التلوث الزراعي، التداخل المالح","لون التربة فقط","وجود الأشجار فقط","الزلازل فقط"], choices_en:["Rock type, human activity, agricultural pollution, saline intrusion","Soil color only","Presence of trees only","Only earthquakes"], answerIndex:0 },
    { q_ar:"ما وظيفة المراقب (Piezometer)؟", q_en:"Function of a piezometer?", choices_ar:["قياس ضغط الماء أو منسوب المياه في نقطة محددة","قياس سرعة الرياح","قياس توصيلية التربة كهربائياً","قياس تركيز المعادن"], choices_en:["Measure water pressure or level at a point","Measure wind speed","Measure soil electrical conductivity","Measure mineral concentration"], answerIndex:0 },
    { q_ar:"ماذا يحدث إذا ارتفع الضغط الارتوازي؟", q_en:"What if artesian pressure rises?", choices_ar:["قد ينتج بئر ارتوازي متدفق دون الحاجة للضخ","ينخفض مستوى الماء في كل الآبار","تتوقف حركة المياه","يزيد الترسيب فقط"], choices_en:["May produce flowing artesian well without pumping","Water levels fall in all wells","Water movement stops","Only deposition increases"], answerIndex:0 },
    { q_ar:"كيف تحدد طبقات المياه من سجلات الجيوكهرباء؟", q_en:"How detect aquifers from resistivity logs?", choices_ar:["انخفاض المقاومة يشير لصخور مشبعة بالماء مقارنة بالصخور الجافة","زيادة المقاومة دائمًا علامة على الماء","لا علاقة للمقاومة بالماء","باستخدام مقياس الصوت فقط"], choices_en:["Lower resistivity indicates water-saturated rocks vs dry ones","Higher resistivity always means water","No relation between resistivity and water","Use sonic log only"], answerIndex:0 },
    { q_ar:"ما تأثير الحفر العميق على توازن النظام المائي؟", q_en:"Impact of deep drilling on groundwater balance?", choices_ar:["يمكن أن يغير الضغوط ويسمح بتداخل مياه عميقة أو ملحية","يحدث فقط تأثير حراري","يحسن دائمًا جودة المياه","ليس له تأثير عملي"], choices_en:["It may change pressures and cause deep or saline water intrusion","Only thermal effect","Always improves water quality","No practical effect"], answerIndex:0 },
    { q_ar:"ما العلاقة بين نوع الصخور والتوصيل الهيدروليكي؟", q_en:"Relation between rock type and hydraulic conductivity?", choices_ar:["الصخور الخشنة (رمل، حصى) تملك توصيلاً أعلى من الطين","الطين أكثر نفاذية","الصخور البلورية أعلى توصيل","لا علاقة"], choices_en:["Coarse rocks (sand, gravel) have higher conductivity than clay","Clay is more permeable","Crystalline rocks have highest conductivity","No relation"], answerIndex:0 },
    { q_ar:"ما دور التربة في تغذية الخزانات؟", q_en:"Role of soil in aquifer recharge?", choices_ar:["تعمل كمرشح وتتحكم في معدل تسرب المياه ونقائها","تمتص كل المياه ولا تسمح بالتغذية","تسهم فقط في التلوث","لا دور لها"], choices_en:["Acts as filter and controls infiltration rate and water quality","Absorbs all water preventing recharge","Only contributes to pollution","No role"], answerIndex:0 },
    { q_ar:"كيف تكتشف تسرّب من خزان تحت الأرض؟", q_en:"How detect leak from underground storage?", choices_ar:["بمراقبة تغيّر الكيمياء ودرجات الحرارة أو المسح الجيوفيزيائي","بقياس الضوضاء فقط","من خلال الأشعة تحت الحمراء فقط","بالعينات الميكروبيولوجية فقط"], choices_en:["Monitor chemical/temperature changes or use geophysical surveys","By noise measurement only","By infrared only","By microbiological samples only"], answerIndex:0 },
    { q_ar:"ما المقصود بالتوازن الهيدرولوجي؟", q_en:"What is hydrological balance?", choices_ar:["توازن بين مدخلات الماء (هطول، تغذية) ومخرجاته (تدفق، تبخر، ضخ)","كمية الماء في البئر فقط","معدل الترسيب الكيميائي","توازن الملح فقط"], choices_en:["Balance between water inputs (rain,recharge) and outputs (flow,evaporation,pumping)","Amount in one well only","Rate of chemical deposition","Salt balance only"], answerIndex:0 },
    { q_ar:"ما أهم مؤشرات تلوث النترات في الآبار؟", q_en:"Indicators of nitrate contamination in wells?", choices_ar:["تركيز نترات مرتفع، طعم مر أو مشاكل صحية، قرب مناطق زراعية أو صرف صحي","لون الماء الأزرق","زيادة في الضغط فقط","انخفاض في درجة الحرارة"], choices_en:["High nitrate concentration, health effects, proximity to agriculture/sewage","Blue colored water","Only pressure increase","Temperature drop only"], answerIndex:0 },
    { q_ar:"ما استخدام GIS في الهيدروجيولوجيا؟", q_en:"Use of GIS in hydrogeology?", choices_ar:["رسم خرائط التغذية، خطوط المنسوب، نمذجة انتشار الملوثات وتحليل المساحات","لتحليل المعادن تحت المجهر فقط","لا فائدة","لاستخدامات الطقس فقط"], choices_en:["Mapping recharge, potentiometric contours, pollutant spread modeling and spatial analysis","Microscopic mineral analysis only","No use","Only for weather uses"], answerIndex:0 }
  ] },
  petro: { id: 'petro', title_ar:"🌋 البتروغرافيا", title_en:"🌋 Petrography", items: /* 30 Qs */ [
    { q_ar:"ما الفرق بين الصخور النارية الجوفية والسطحية؟", q_en:"Difference intrusive vs extrusive igneous rocks?", choices_ar:["الجوفية تبرد ببطء بلورات كبيرة، السطحية تبرد سريعاً بلورات دقيقة","السطحية أقدم دائماً","الجوفية لا تحتوي معادن","السطحية تكون في البحر فقط"], choices_en:["Intrusive cool slowly (large crystals); extrusive cool fast (fine crystals)","Extrusive always older","Intrusive contain no minerals","Extrusive only form in ocean"], answerIndex:0 },
    { q_ar:"ما مكونات الجرانيت الرئيسية؟", q_en:"Main components of granite?", choices_ar:["كوارتز، فلسبار بوتاسي، بلاغيوكلاز ومقدار من الميكا","كلسيت ودولوميت","أوليفين وبيروكسين فقط","طين ورمل"], choices_en:["Quartz, K-feldspar, plagioclase and some mica","Calcite and dolomite","Only olivine and pyroxene","Clay and sand"], answerIndex:0 },
    { q_ar:"ما دلالة النسيج البورفيري؟", q_en:"Significance of porphyritic texture?", choices_ar:["يشير لتبريد بمرحلتين: بلورات كبيرة ثم مصفوفة دقيقة","دليل على التحول","دلالة على ترسب بحري","علامة على تآكل"], choices_en:["Indicates two-stage cooling: large crystals in fine matrix","Evidence of metamorphism","Indicative of marine deposition","Sign of erosion"], answerIndex:0 },
    { q_ar:"كيف تفرق البازلت والأنديزيت ميدانياً؟", q_en:"How distinguish basalt and andesite in hand sample?", choices_ar:["البازلت داكن، حبيبات دقيقة؛ الأنديزيت أفتح قليلاً ومحتوي فلزات أقل","البازلت فاتح دائماً","الأنديزيت زجاجي فقط","لا فرق عملياً"], choices_en:["Basalt dark, fine-grained; andesite lighter with intermediate composition","Basalt always light","Andesite only glassy","No practical difference"], answerIndex:0 },
    { q_ar:"كيف تميز الكلسيت من الدولوميت ميدانياً؟", q_en:"Field test to distinguish calcite vs dolomite?", choices_ar:["الكلسيت يتفاعل فورًا مع HCl المخفف؛ الدولوميت يحتاج للاختبار المطحون أو التسخين","كلاهما يتفاعل بنفس الطريقة","الدولوميت يذوب في الماء","لا يمكن التفريق إلا بالمختبر"], choices_en:["Calcite reacts immediately with dilute HCl; dolomite requires powdered or heated sample","Both react identically","Dolomite dissolves in water","Only lab test distinguishes"], answerIndex:0 },
    { q_ar:"ما علامة الصخر الرسوبي الكربوني؟", q_en:"Key sign of carbonate sedimentary rock?", choices_ar:["وجود كلسيت أو قشرة أحيائية وفحص التفاعل مع الحمض","لون رمادي فقط","نسيج زجاجي","طبقات رملية فقط"], choices_en:["Presence of calcite/biogenic shells and acid reaction","Gray color only","Glassy texture","Only sandy layers"], answerIndex:0 },
    { q_ar:"كيف تفرق الحجر الرملي عن الصخر الطيني؟", q_en:"How to tell sandstone from shale?", choices_ar:["الحجر الرملي حبيبات مرئية وخشن، الطيني ناعم ويتشقق","كلاهما ناعم","الطيني خشن","لا فرق"], choices_en:["Sandstone has visible grains and is gritty; shale is smooth and fissile","Both smooth","Shale coarse","No difference"], answerIndex:0 },
    { q_ar:"ما هو التورق في الصخور المتحولة؟", q_en:"What is foliation in metamorphic rocks?", choices_ar:["ترتيب مواز للمعادن نتيجة ضغط موجه","طبقات رسوبية أفقية","نتيجة برد سريع","نوع من التجوية"], choices_en:["Parallel alignment of minerals due to directed pressure","Horizontal sedimentary layering","Result of rapid cooling","A weathering type"], answerIndex:0 },
    { q_ar:"ما الفرق بين الشست والنايس؟", q_en:"Difference between schist and gneiss?", choices_ar:["الشست ذو تورق دقيق وميكانيكا مميزة، النايس ذو نطاقات معدنية متبادلة","الشست أكثر فحصية","النايس طيني","لا فرق"], choices_en:["Schist has fine foliation; gneiss shows alternating mineral bands","Schist more glassy","Gneiss is clay","No difference"], answerIndex:0 },
    { q_ar:"ما أنواع الفلسبار الشائعة؟", q_en:"Common types of feldspar?", choices_ar:["فلسبار بوتاسي (أورثوكلاز/ميكروكلين) وفلسبار بلاجيوكليز","فلسبار كربوني فقط","فلسبار سيليكات خاص","لا فلسبار في الصخور"], choices_en:["K-feldspar (orthoclase/microcline) & plagioclase feldspar","Only carbonate feldspar","Special silicate feldspar","No feldspar in rocks"], answerIndex:0 },
    { q_ar:"كيف تستنتج أصل الصخر من معادنه؟", q_en:"How infer rock origin from mineralogy?", choices_ar:["التركيب المعدني يدل إن كان ناري، رسوبي أم متحول (مثال: كوارتز عالي يؤشر الرسوبي)","المعادن لا تفيد","من لون الصخور فقط","بحاجة لصورة جوية فقط"], choices_en:["Mineral composition indicates igneous/sedimentary/metamorphic origin (e.g., abundant quartz suggests sedimentary)","Minerals not helpful","By rock color only","Need aerial photo only"], answerIndex:0 },
    { q_ar:"ما أدوات التحليل البتروغرافي الأساسية؟", q_en:"Essential petrographic tools?", choices_ar:["مجهر مستقطب للشرايح الرقيقة، واختبارات الحقل البسيطة","مقياس الضغط فقط","الأشعة السينية فقط","كاميرا فقط"], choices_en:["Polarizing microscope for thin sections and simple field tests","Pressure gauge only","X-ray only","Camera only"], answerIndex:0 },
    { q_ar:"ما دلالة الكوارتز الدائري في الرمل؟", q_en:"Significance of rounded quartz in sandstone?", choices_ar:["يدل على نضج عالي ونقل طويل (مسافة نقل طويلة)","دليل على بركانية قريبة","دليل على تحوّل فقط","لا دلالة"], choices_en:["Indicates high maturity and long transport distance","Indicates nearby volcanism","Indicates metamorphism only","No significance"], answerIndex:0 },
    { q_ar:"ما المقصود بالمصفوفة (matrix) في الصخر الرسوبي؟", q_en:"What is matrix in sedimentary rock?", choices_ar:["مادة دقيقة تملأ الفراغات بين الحبيبات (طين/غرين)","نوع من البلورات الكبيرة","فراغات في الصخر","طبقة سطحية فقط"], choices_en:["Fine material filling spaces between grains (clay/silt)","A type of large crystal","Voids in rock","Surface layer only"], answerIndex:0 },
    { q_ar:"كيف تحدد درجة التحول؟", q_en:"How determine metamorphic grade?", choices_ar:["بوجود معادن مؤشرية (index minerals) مثل الغارنيت أو الكلوريت","بالمقياس فقط","من لون الصخر","من السُمك فقط"], choices_en:["By index minerals (garnet, chlorite etc.)","By scale only","By rock color","By thickness only"], answerIndex:0 },
    { q_ar:"ما الفرق بين البريشيا والكونجلوميرات؟", q_en:"Breccia vs conglomerate?", choices_ar:["البريشيا حبيبات زاوية، الكونجلوميرات حبيبات مستديرة","الاثنان متماثلان","البريشيا رسوبي كيميائي","الكونجلوميرات متحول"], choices_en:["Breccia has angular clasts; conglomerate has rounded clasts","They are the same","Breccia is chemical","Conglomerate metamorphic"], answerIndex:0 },
    { q_ar:"ما دلالة فقاعات الغاز في صخر ناري؟", q_en:"Significance of gas vesicles in igneous rock?", choices_ar:["تدل على تبريد سريع وتحرر غازات (نسيج فقاعي مثل البوميس)","تدل على ضغط عالٍ","تدل على تحوّل","لا أهمية عملية"], choices_en:["Indicate rapid cooling and gas escape (vesicular texture like pumice)","Indicate high pressure","Indicate metamorphism","No practical importance"], answerIndex:0 },
    { q_ar:"الفرق المظهر بين البازلت والجابرو؟", q_en:"Appearance difference basalt vs gabbro?", choices_ar:["البازلت ناعم الحبيبات (سطحي) داكن، الجابرو ذو بلورات خشنة (جوفي) داكن أيضاً","الجابرو فاتح","البازلت بلوري كبير","لا فرق"], choices_en:["Basalt fine-grained (extrusive) dark; gabbro coarse-grained (intrusive) dark","Gabbro light","Basalt large crystals","No difference"], answerIndex:0 },
    { q_ar:"ما معنى Texture في البتروغرافيا؟", q_en:"What is texture in petrography?", choices_ar:["حجم وشكل وترتيب المكونات المعدنية في الصخر","لون الصخر فقط","معدل التحوّل","مقياس المسامية"], choices_en:["Size, shape and arrangement of mineral components","Rock color only","Metamorphic grade","Porosity measure"], answerIndex:0 },
    { q_ar:"ما دلالة اللون في التعرف الميداني؟", q_en:"Field significance of rock color?", choices_ar:["يمكن أن يشير لتركيب معدني أو أكسدة الحديد أو محتوى عضوي","اللون غير مفيد أبداً","يحدد العمر مباشرة","يشير للنفاذية فقط"], choices_en:["May indicate mineralogy, iron oxidation or organic content","Color never useful","Determines age directly","Indicates permeability only"], answerIndex:0 },
    { q_ar:"ما المعادن الظهار في الصخور الفلسية؟", q_en:"Main minerals in felsic rocks?", choices_ar:["كوارتز وفلسبار بوتاسي وميكا","أوليفين وبيروكسين","كالسيت فقط","طفل حبيبي"], choices_en:["Quartz, K-feldspar and mica","Olivine and pyroxene","Calcite only","Granular clay"], answerIndex:0 },
    { q_ar:"ما الفرق ما بين المافية والفلسية؟", q_en:"Mafic vs felsic difference?", choices_ar:["المافية غنية بالحديد والمغنيسيوم (داكنة)، الفلسية غنية بالسيليكا (فاتحة)","لا فرق","المافية خفيفة","الفلسية دائماً زجاجية"], choices_en:["Mafic rich in Fe-Mg (dark); felsic rich in silica (light)","No difference","Mafic light","Felsic always glassy"], answerIndex:0 },
    { q_ar:"ما العلاقة بين سرعة التبريد وحجم البلورات؟", q_en:"Cooling rate vs crystal size?", choices_ar:["تبريد أسرع ← بلورات أصغر؛ تبريد أبطأ ← بلورات أكبر","سرعة لا تؤثر","تبريد أسرع ← بلورات أكبر","لا علاقة"], choices_en:["Faster cooling → smaller crystals; slower → larger crystals","Rate doesn't affect","Faster → larger crystals","No relation"], answerIndex:0 },
    { q_ar:"ما العلامات الدالة على أصل ناري مقابل رسوبي؟", q_en:"Signs for igneous vs sedimentary origin?", choices_ar:["الناري لديه نسيج متداخل أو بلورات؛ الرسوبي يظهر طبقات وأحافير","الناري يحتوي أحافير","الرسوبي بلوري كبير","لا تمييز"], choices_en:["Igneous shows interlocking texture/crystals; sedimentary shows layers and fossils","Igneous contains fossils","Sedimentary large crystals","No distinction"], answerIndex:0 },
    { q_ar:"ما دور التحليل المجهري؟", q_en:"Role of microscopy in petrography?", choices_ar:["تحديد النسيج والمعادن بدقة لتحديد الأصل والبيئة التكوينية","لا فائدة ميدانية","يستخدم فقط في التعدين","يحلي المياه"], choices_en:["Identify texture and minerals precisely to determine origin and environment","No field use","Only used in mining","Purifies water"], answerIndex:0 },
    { q_ar:"كيف تعرف الصخور الرسوبية الكيميائية؟", q_en:"How identify chemical sedimentary rocks?", choices_ar:["تكوّنت بترسيب مباشر من محلول مائي (مثال: جبس، هاليت)","تكوّنت بالضغط فقط","تكوّنت بالحرارة فقط","تكوّنت بالعوامل الحيوية"], choices_en:["Formed by direct precipitation from aqueous solution (e.g., gypsum, halite)","Formed by pressure only","Formed by heat only","Formed by biological factors"], answerIndex:0 },
    { q_ar:"ما الفرق بين الحجر الجيري والدولوميت؟", q_en:"Difference between limestone and dolomite?", choices_ar:["الجيري $\\text{CaCO}_3$ يتفاعل فوراً مع الحمض، الدولوميت $\\text{CaMg}(\\text{CO}_3)_2$ يتفاعل أضعف","لا فرق","الدولوميت أقدم دائماً","الجيري أقوى"], choices_en:["Limestone $\\text{CaCO}_3$ reacts immediately; Dolomite $\\text{CaMg}(\\text{CO}_3)_2$ reacts weakly","No difference","Dolomite always older","Limestone stronger"], answerIndex:0 },
    { q_ar:"ما نوع الصخور التي تحتوي عادة على الفوسفات؟", q_en:"Rock type usually containing phosphate?", choices_ar:["صخور رسوبية بحرية (فوسفوريت)","صخور نارية جوفية","صخور متحولة عالية الدرجة","صخور البازلت"], choices_en:["Marine sedimentary rocks (phosphorite)","Intrusive igneous rocks","High-grade metamorphic rocks","Basalt rocks"], answerIndex:0 },
    { q_ar:"ما معنى recrystallization في التحول؟", q_en:"Meaning of recrystallization in metamorphism?", choices_ar:["إعادة نمو وتبلور المعادن الموجودة لتكوين بلورات أكبر أو معادن جديدة مستقرة","ذوبان الصخر بالكامل","كسر الصخر فقط","ترسيب جديد"], choices_en:["Regrowth of existing minerals into larger crystals or new stable minerals","Complete melting of rock","Only fracturing of rock","New deposition"], answerIndex:0 },
    { q_ar:"ما هو مؤشر اللون في تصنيف الصخور النارية (Mafic Index)؟", q_en:"What is the Mafic Index in igneous classification?", choices_ar:["نسبة المعادن المافية (الداكنة) إلى إجمالي المعادن في الصخر","نسبة المياه","نسبة الكوارتز فقط","نسبة الميكا"], choices_en:["Ratio of mafic (dark) minerals to total minerals in the rock","Water ratio","Quartz ratio only","Mica ratio"], answerIndex:0 }
  ] },
  maps: { id: 'maps', title_ar:"🗺️ الخرائط الجيولوجية", title_en:"🗺️ Geological Maps", items: /* 30 Qs */ [
    { q_ar:"ما الفرق بين الخريطة الجيولوجية والطبوغرافية؟", q_en:"Difference between geological and topographic maps?", choices_ar:["الطبوغرافية تمثل ارتفاعات (كنتورات)، الجيولوجية تمثل نوع وامتداد الصخور والتراكيب","الطبوغرافية لجيولوجيين فقط","الجيولوجية تعرض مناخ المنطقة","لا فرق"], choices_en:["Topographic shows elevations (contours); geological shows rock types and structures","Topographic for geologists only","Geological shows climate","No difference"], answerIndex:0 },
    { q_ar:"ما فائدة خطوط الكنتور؟", q_en:"Purpose of contour lines?", choices_ar:["تحديد الارتفاعات وشكل التضاريس والانحدارات","تحديد نوع الصخور","قياس سرعة المياه","تعريف حدود البلد"], choices_en:["Show elevations and terrain shape/slopes","Indicate rock type","Measure water speed","Define country borders"], answerIndex:0 },
    { q_ar:"كيف تحدد ميل الطبقات من الخريطة؟", q_en:"How determine dip of beds from map?", choices_ar:["من خلال مقارنة اتجاه تقاطع الطبقات مع خطوط الكنتور وحساب V-rule","من اللون فقط","من مقياس الخريطة","من الصور satellit فقط"], choices_en:["By comparing strike lines with contours and using V-rule","By color only","By map scale","From satellite images only"], answerIndex:0 },
    { q_ar:"ما معنى رمز الطبقة (مثل Ksh)؟", q_en:"Meaning of unit code (eg Ksh)?", choices_ar:["يشير للعمر والصخر (K=Crete, sh=shale)","هو رمز عشوائي","يحدد الارتفاع","المقياس"], choices_en:["Indicates age and rock (e.g., K=Cretaceous, sh=shale)","Random code","Specifies elevation","Scale"], answerIndex:0 },
    { q_ar:"كيف تحدد نقطة التقاء طبقة ونهر؟", q_en:"How locate contact point between layer and river?", choices_ar:["باستخدام قاعدة V: انحناءات الكنتور وامتداد الطبقة تظهر نقطة الالتقاء","من لون الماء فقط","من الرياح","بواسطة مقياس الوزن"], choices_en:["Using V-rule where contours and bed contacts intersect","By water color only","By wind","By weight scale"], answerIndex:0 },
    { q_ar:"ما دلالة تقاطع الطبقات مع التضاريس؟", q_en:"Meaning of bed intersections with terrain?", choices_ar:["تحدد ميل الطبقات واتجاهها وتكشف عن طيات وفوالق","تعني وجود معادن فقط","تعني وجود نفط دوماً","لا فائدة"], choices_en:["Determine dip/strike and indicate folds/faults","Means only minerals present","Means oil always present","No use"], answerIndex:0 },
    { q_ar:"ما الإسقاط الشائع في الخرائط الجيولوجية؟", q_en:"Common projection used in geological maps?", choices_ar:["نظام UTM أو الإسقاط المخروطي لامبرت في الخرائط الإقليمية","إسقاط مركاتور فقط","إسقاط قطبي فقط","لا حاجة لإسقاط"], choices_en:["UTM or Lambert conformal conic for regional maps","Mercator only","Polar projection only","No projection needed"], answerIndex:0 },
    { q_ar:"ما أدوات قراءة الخريطة ميدانياً؟", q_en:"Tools for reading map in field?", choices_ar:["بوصلة جيولوجية، مقياس، قلم، GPS/الهاتف الذكي","مجهر فقط","مطرقة فقط","كاميرا فقط"], choices_en:["Geological compass, scale, pen, GPS/smartphone","Microscope only","Hammer only","Camera only"], answerIndex:0 },
    { q_ar:"كيف تُرسم المقاطع الجيولوجية؟", q_en:"How to draw geological cross-sections?", choices_ar:["بنقل نقاط الاتصالات الأفقية إلى رسم رأسي وفق المقياس وتحويل البيانات","بمقارنة الألوان فقط","بالتخمين","باستخدام الرياح"], choices_en:["Project contacts from map to a vertical profile using scale","By color comparison only","By guessing","Using wind"], answerIndex:0 },
    { q_ar:"ماذا تمثل الطيات والفوالق على الخريطة؟", q_en:"What do folds and faults represent on a map?", choices_ar:["طيات: انثناءات الطبقات؛ فوالق: كسور مع إزاحة للكتل الصخرية","نقوش للطرق","مؤشرات مناخية","مواقع مورد مائي دائم"], choices_en:["Folds: bending of beds; Faults: breaks with displacement","Road markings","Climate indicators","Permanent water source locations"], answerIndex:0 },
    { q_ar:"كيف تُقاس الاتجاه (Strike) والانحدار (Dip)؟", q_en:"How measure strike and dip?", choices_ar:["بالبوصلة الجيولوجية: اتجاه خط أفقي على الطبقة وزاوية الانحدار العمودية عليه","بمقياس الحرارة","باستخدام الهاتف فقط","من لون الصخر"], choices_en:["By geologic compass: strike is horizontal line; dip is vertical angle perpendicular to strike","By thermometer","Using phone only","By rock color"], answerIndex:0 },
    { q_ar:"ما الفرق بين الفالق العادي والمعكوس؟", q_en:"Normal vs reverse fault difference?", choices_ar:["العادي: الكتلة المعلقة تتحرك لأسفل (شد)، المعكوس: تتحرك للأعلى (ضغط)","العكس بالأرقام","الفالق ليس له اتجاه","كلاهما نفس الشيء"], choices_en:["Normal: hanging wall moves down (extension); Reverse: hanging wall moves up (compression)","Opposite by numbers","Fault has no direction","They are same"], answerIndex:0 },
    { q_ar:"كيف تميز طية محدبة من مقعرة؟", q_en:"How tell anticline vs syncline?", choices_ar:["الطبقات الأقدم عادة في مركز الطية المحدبة (anticline) والأحدث في المقعرة (syncline)","المحدبة دائمًا أعرض","المقعرة أقدم","لا فرق"], choices_en:["Older beds usually at center of anticline; younger in syncline","Anticline always broader","Syncline older","No difference"], answerIndex:0 },
    { q_ar:"ما دلالة الرموز المختلفة على الخريطة؟", q_en:"Meaning of different map symbols?", choices_ar:["توضح نوع الصخور، خط التماس، الفوالق، والمظاهر السطحية وفق الـLegend","مجرد زخرفة","لا أهمية","تعرض شبكات الطرق فقط"], choices_en:["Indicate rock types, contacts, faults and surface features as in the legend","Decoration only","No importance","Show road networks only"], answerIndex:0 },
    { q_ar:"ما فائدة المقياس الخطي؟", q_en:"Purpose of linear scale?", choices_ar:["تحويل المسافات على الخريطة إلى الواقع بسهولة","تحديد نوع الصخر","قياس العمق","تحديد الوقت"], choices_en:["Convert map distances to real ground distances","Determine rock type","Measure depth","Determine time"], answerIndex:0 },
    { q_ar:"علاقة لون الخريطة بنوع الصخور؟", q_en:"Relation of map color to rock type?", choices_ar:["الألوان تمثل أنواع/أعمار الصخور وفق معيار الخريطة (مثلاً كربونات بلون معين)","الألوان عشوائية","اللون يدل على ارتفاع فقط","لا علاقة"], choices_en:["Colors represent rock types/ages per map convention (eg carbonates a certain color)","Colors random","Color indicates elevation only","No relation"], answerIndex:0 },
    { q_ar:"كيف تستخدم البوصلة ميدانياً؟", q_en:"How use geologic compass in field?", choices_ar:["لقياس الـstrike والـdip، توجيه المسارات، قياس انزياح الفالق","لقياس سرعة الرياح فقط","لقياس الوزن","لقياس جودة التربة فقط"], choices_en:["Measure strike/dip, orient traverses, measure fault offset","Measure wind speed only","Measure weight","Measure soil quality only"], answerIndex:0 },
    { q_ar:"الفرق بين الخريطة المحلية والإقليمية؟", q_en:"Local vs regional map difference?", choices_ar:["المحلية مقياس كبير تفاصيل أعلى، الإقليمية مقياس صغير تغطية أكبر","لا فرق","المحلية تستخدم للأقمار فقط","الإقليمية ورقية فقط"], choices_en:["Local large-scale with high detail; regional small-scale covering large area","No difference","Local for satellites only","Regional only paper"], answerIndex:0 },
    { q_ar:"كيف تحدد العمر النسبي للطبقات؟", q_en:"How determine relative age of beds?", choices_ar:["بمبدأ التراكب: الأقدم في الأسفل ما لم يحدث قلب أو اختلال","بالألوان فقط","بمقياس الخريطة","بجهاز خاص"], choices_en:["By principle of superposition: older below unless overturned","By colors only","By map scale","By special device"], answerIndex:0 },
    { q_ar:"ما هو الـLegend؟", q_en:"What is the legend?", choices_ar:["مفتاح الخريطة الذي يشرح الألوان والرموز","قائمة الأسماء فقط","خريطة فرعية","مقياس الزمن"], choices_en:["Map key explaining colors and symbols","List of names only","Inset map","Time scale"], answerIndex:0 },
    { q_ar:"كيف تُستخرج مقاطع طولية؟", q_en:"How extract longitudinal sections?", choices_ar:["برسم الطبقات والاتصالات على خط المقطع وتحويلها إلى منظر جانبي بمقاييس","بالتخمين","باستخدام GPS فقط","بالمجهر"], choices_en:["Plot formations and contacts along a line and project to vertical profile using scales","By guessing","Using GPS only","With microscope"], answerIndex:0 },
    { q_ar:"ماذا يعني لو كانت الطبقات موازية للكنتورات؟", q_en:"If beds parallel contours what is dip?", choices_ar:["الطبقات أفقية (dip = 0)","الطبقات شديدة الانحدار","غير قابل للتحديد","تعني فالق كبير"], choices_en:["Beds are horizontal (dip = 0)","Beds steeply dipping","Undeterminable","Indicates a large fault"], answerIndex:0 },
    { q_ar:"كيف تحدد مناطق التماس بين الصخور؟", q_en:"How locate contacts between rock units?", choices_ar:["ببحث عن خطوط فاصل على الخريطة بين وحدات مختلفة اللون أو الرموز","بقياس الصوت","بمقياس الضغط","بالمناخ"], choices_en:["Look for boundary lines between differently colored/symbolized units on map","By sound measurement","By pressure gauge","By climate"], answerIndex:0 },
    { q_ar:"ما دلالة الـUnconformity؟", q_en:"Significance of unconformity?", choices_ar:["تشير لفترات انقطاع في الترسيب أو تعرية بين مجموعتين صخريتين","دليل على وجود نفط دائماً","خطأ في الخريطة","مؤشر للمياه فقط"], choices_en:["Indicates gaps in deposition or erosion between rock sequences","Always indicates oil","Map error","Only water indicator"], answerIndex:0 },
    { q_ar:"كيف تساعد الصور الجوية في تحديث الخريطة؟", q_en:"How aerial photos help update maps?", choices_ar:["تكشف تغيّر الغطاء النباتي أو تعرية السطح وتساعد في تحديد تراكيب جديدة","لا تساعد","تؤثر على المساحة","تحدد أعمار الصخور"], choices_en:["Reveal vegetation/erosion changes and help identify new structures","No help","Affect area","Determine rock ages"], answerIndex:0 },
    { q_ar:"ما أهمية معرفة الاتجاه الجيولوجي في الحفر؟", q_en:"Importance of knowing geological strike/dip in drilling?", choices_ar:["لتحديد عمق الوصول للطبقة المطلوبة وتجنب الحفر الموازي للفوالق","لمعرفة سرعة الرياح فقط","لمعرفة لون الصخر","لمعرفة الوقت"], choices_en:["To determine the depth of the target layer and avoid drilling parallel to faults","To know wind speed only","To know rock color","To know time"], answerIndex:0 },
    { q_ar:"ما معنى الرموز الجيوفيزيائية في بعض الخرائط؟", q_en:"Meaning of geophysical symbols on some maps?", choices_ar:["تظهر شذوذات جاذبية أو مغناطيسية (مؤشرات غير مباشرة لتراكيب تحت سطحية)","تظهر ارتفاع المباني","تظهر حدود الدول","تظهر الأنهار فقط"], choices_en:["Show gravity or magnetic anomalies (indirect indicators of subsurface structures)","Show building heights","Show country borders","Show only rivers"], answerIndex:0 },
    { q_ar:"ما علاقة الخرائط بالمسح الجيوكيميائي؟", q_en:"Relation between maps and geochemical surveying?", choices_ar:["تستخدم الخرائط كخلفية لتوقيع مواقع العينات ونتائج التركيز لتحديد المناطق الواعدة","لا علاقة","تستخدم فقط لجمع العينات","تستخدم لضبط الوقت"], choices_en:["Maps serve as a base to plot sample locations and concentration results to identify prospective areas","No relation","Used only for sample collection","Used for time adjustment"], answerIndex:0 },
    { q_ar:"ما هي الأخطاء الشائعة عند قراءة الخرائط الجيولوجية؟", q_en:"Common mistakes reading geologic maps?", choices_ar:["خلط بين قواعد V، تفسير فالق عكسي كعادي، وعدم ملاحظة الـLegend","القراءة سريعة دائماً صحيحة","الاستخفاف بالألوان","عدم استخدام الهاتف"], choices_en:["Misapplying V-rule, mistaking reverse for normal fault, ignoring legend","Quick read always correct","Disregarding colors","Not using phone"], answerIndex:0 },
    { q_ar:"كيف تُحوّل الخريطة الورقية إلى رقمية باستخدام GIS؟", q_en:"How convert paper map to digital using GIS?", choices_ar:["عن طريق المسح (Scanning) ثم عملية تحديد الإحداثيات (Georeferencing) ورقمنة التفاصيل","باستخدام الآلة الحاسبة فقط","باستخدام قلم رصاص فقط","باستخدام مسطرة"], choices_en:["By scanning then georeferencing and digitizing geological details","Using calculator only","Using pencil only","Using ruler"], answerIndex:0 }
  ] },
  general: { id: 'general', title_ar:"🪨 الجيولوجيا العامة", title_en:"🪨 General Geology", items: /* 30 Qs */ [
    { q_ar:"ما الفرق بين الماجما واللافا؟", q_en:"Magma vs lava?", choices_ar:["الماجما تحت السطح، اللافا عند خروجها على السطح","الماجما ماء واللافا حجر","لا فرق","ماجما = صخور متحولة"], choices_en:["Magma is subsurface molten rock; lava is magma erupted at surface","Magma is water and lava rock","No difference","Magma = metamorphic rock"], answerIndex:0 },
    { q_ar:"ما هي الدورة الصخرية؟", q_en:"What is the rock cycle?", choices_ar:["تحول الصخور النارية والرسوبية والمتحولة عبر العمليات الجيولوجية","دورة حياة النبات فقط","ظاهرة جوية","عملية بشرية"], choices_en:["Transformation of igneous, sedimentary and metamorphic rocks via geologic processes","Plant life cycle only","Atmospheric phenomenon","Human activity"], answerIndex:0 },
    { q_ar:"ما أنواع التجوية؟", q_en:"Types of weathering?", choices_ar:["تجوية فيزيائية وكيميائية وحيوية","تجوية فقط بالماء","تجوية حرارية فقط","تجوية بتأثير الرياح فقط"], choices_en:["Physical, chemical and biological weathering","Only water weathering","Only thermal weathering","Only wind weathering"], answerIndex:0 },
    { q_ar:"كيف تتشكل الطيات والفوالق؟", q_en:"How form folds and faults?", choices_ar:["نتيجة قوى ضغط أو شد تؤدي للانثناء أو الكسر داخل القشرة","بنشاطات بسيطة فقط","تتكون في البحر فقط","تتكون بالإنجراف فقط"], choices_en:["By compressional/tensional forces causing bending or breaking of crust","From trivial activities only","Form only in ocean","Form by erosion only"], answerIndex:0 },
    { q_ar:"الفرق بين القشرة القارية والمحيطية؟", q_en:"Continental vs oceanic crust?", choices_ar:["القارية أسمك وأقل كثافة وغنية بالصخور الفلسية، المحيطية أرق وأكثر كثافة وبازلتية","لا فرق","القارية مصنوعة من مياه","المحيطية تحتوي على كل المعادن"], choices_en:["Continental crust thicker, less dense, felsic; oceanic thinner, denser, basaltic","No difference","Continental made of water","Oceanic contains all minerals"], answerIndex:0 },
    { q_ar:"ما هو أصل الجبال؟", q_en:"Origin of mountains?", choices_ar:["تصادم الصفائح أو النشاط البركاني ورفع القشرة","الرياح فقط","التعرية فقط","النشاط البشري"], choices_en:["Plate collisions, volcanism, or crustal uplift","Only wind","Only erosion","Human activity"], answerIndex:0 },
    { q_ar:"ما المقصود بالصفائح التكتونية؟", q_en:"What are tectonic plates?", choices_ar:["قطع كبيرة من الغلاف الصخري تتحرك فوق الستار","تجمعات من الحجارة","شبكات طرق","مصطلح جماعي للجبال"], choices_en:["Large lithospheric plates moving over the mantle","Piles of rocks","Road networks","Collective term for mountains"], answerIndex:0 },
    { q_ar:"ما العلاقة بين الزلازل وحدود الصفائح؟", q_en:"Earthquakes & plate boundary relation?", choices_ar:["معظم الزلازل تحدث عند حدود الصفائح نتيجة تراكم وإطلاق الإجهاد","لا علاقة","حصلت فقط قديمًا","فقط في المحيطات"], choices_en:["Most quakes occur at plate boundaries due to stress accumulation/release","No relation","Only occurred in past","Only in oceans"], answerIndex:0 },
    { q_ar:"ما نوع الصخور الناتجة عن النشاط البركاني؟", q_en:"Rocks from volcanic activity?", choices_ar:["صخور نارية سطحية مثل البازلت والريوليت","صخور رسوبية فقط","صخور متحولة فقط","تربة فقط"], choices_en:["Extrusive igneous rocks like basalt and rhyolite","Only sedimentary rocks","Only metamorphic rocks","Soil only"], answerIndex:0 },
    { q_ar:"لماذا ندرس المعادن؟", q_en:"Why study minerals?", choices_ar:["لتحديد تركيبة الصخور، الموارد الاقتصادية، وفهم خواصها الفيزيائية","لأغراض جمالية فقط","لا حاجة","لفهم الطقس"], choices_en:["To identify rock composition, economic resources, and physical properties","Only aesthetic reasons","No need","To understand weather"], answerIndex:0 },
    { q_ar:"كيف نحدد عمر الصخور؟", q_en:"How date rocks?", choices_ar:["بالعمر النسبي (تراكب) أو التأريخ المطلق (نظائر مشعة)","بحساسيه اللون","بالعمر الظاهري","بالتحليل الصوتي فقط"], choices_en:["By relative dating (superposition) or absolute dating (radioisotopes)","By color sensitivity","By apparent age","By sonic only"], answerIndex:0 },
    { q_ar:"الفرق بين العمر النسبي والمطلق؟", q_en:"Relative vs absolute age?", choices_ar:["النسبي يضع ترتيباً زمنياً للأحداث، المطلق يعطي عمرًا بالسنوات","نفس الشيء","النسبي رقمي","المطلق تقريبي فقط"], choices_en:["Relative gives sequence; absolute gives years","Same thing","Relative is numeric","Absolute approximate only"], answerIndex:0 },
    { q_ar:"ما دور المياه في الجيومورفولوجيا؟", q_en:"Role of water in geomorphology?", choices_ar:["محرك رئيسي للتعرية والنقل والترسيب وتشكيل الأودية والدلتا","لا دور","يؤثر فقط على السطح","مهم فقط في الصحارى"], choices_en:["Main agent of erosion, transport and deposition shaping landforms","No role","Only affects surface","Important only in deserts"], answerIndex:0 },
    { q_ar:"ما أنواع البراكين؟", q_en:"Types of volcanoes?", choices_ar:["مخروط رماد، درعي، طبقي/تركيبي","مخروطات تحت الماء فقط","براكين جليدية","براكين رملية"], choices_en:["Cinder cones, shield volcanoes, stratovolcanoes","Underwater cones only","Ice volcanoes","Sand volcanoes"], answerIndex:0 },
    { q_ar:"ما المقصود بـStratigraphy؟", q_en:"What is stratigraphy?", choices_ar:["علم دراسة الطبقات الصخرية وترتيبها الزمني والمكاني","قياس السمك فقط","تحليل المعادن","قياس الكثافة"], choices_en:["Study of rock strata and their temporal/spatial relationships","Measuring thickness only","Mineral analysis","Density measurement"], answerIndex:0 },
    { q_ar:"الفرق بين الفالق والطية؟", q_en:"Fault vs fold?", choices_ar:["الفالق كسر مع إزاحة، الطية انثناء دون كسر","متشابهان","الفالق دائماً أكبر","الطية ناتجة عن التجوية"], choices_en:["Fault is a fracture with displacement; fold is bending without fracture","They are similar","Fault always larger","Fold due to weathering"], answerIndex:0 },
    { q_ar:"ما العوامل المؤثرة على التعرية؟", q_en:"Factors affecting erosion?", choices_ar:["المناخ، نوع الصخر، الغطاء النباتي، الانحدار التضاريسي","فقط الرياح","فقط الإنسان","فقط الجليد"], choices_en:["Climate, rock type, vegetation cover, slope","Only wind","Only humans","Only ice"], answerIndex:0 },
    { q_ar:"ما مكونات القشرة الأرضية؟", q_en:"Materials making Earth's crust?", choices_ar:["الصخور والمعادن السليكاتية مثل السيليكا والفلسبار","الماء فقط","الهواء","العضويات فقط"], choices_en:["Rocks and silicate minerals like silica & feldspar","Only water","Air","Only organics"], answerIndex:0 },
    { q_ar:"ما المقصود بالترسيب؟", q_en:"What is deposition?", choices_ar:["ترسيب المواد المنقولة (فتات/أملاح) عندما تقل الطاقة الحاملة","تفكك الصخور فقط","تحول الصخور","تجميد الماء"], choices_en:["Settling of transported materials (clasts/salts) when carrying energy drops","Only rock decay","Metamorphism","Freezing water"], answerIndex:0 },
    { q_ar:"دور الكائنات في تكوين الصخور؟", q_en:"Role of organisms in rock formation?", choices_ar:["تكوين صخور عضوية كالفسفور والحجر الجيري العضوي من بقايا كائنات","لا دور","تؤثر فقط في التربة","تمنع الترسيب"], choices_en:["Form organic rocks like phosphorites and biogenic limestones from remains","No role","Only affect soil","Prevent deposition"], answerIndex:0 },
    { q_ar:"كيف تتشكل الصخور الرسوبية؟", q_en:"How form sedimentary rocks?", choices_ar:["بتجوية، نقل، ترسيب، ثم التصخر (compaction/cementation)","بالتبريد فقط","بالانصهار","بالتجمد"], choices_en:["By weathering, transport, deposition then lithification (compaction/cementation)","By cooling only","By melting","By freezing"], answerIndex:0 },
    { q_ar:"ما التحول المتماسك؟", q_en:"What is regional metamorphism?", choices_ar:["تحول واسع النطاق نتيجة ضغط وحرارة مرتبطين بحركات تكتونية","تحول محدود محلياً","تحول كيميائي فقط","نتيجة تجوية"], choices_en:["Widespread metamorphism due to pressure & heat from tectonics","Localized alteration only","Only chemical change","Due to weathering"], answerIndex:0 },
    { q_ar:"الفرق بين الصخور المتحولة والرسوبية؟", q_en:"Metamorphic vs sedimentary rocks?", choices_ar:["المتحولة نتيجة تغير صخرة سابقة بالحرارة/ضغط؛ الرسوبية من ترسيب وتراكم","نفس الشيء","المتحولة رسوبية فقط","الرسوبية متحولة فقط"], choices_en:["Metamorphic from pre-existing rock altered by heat/pressure; sedimentary from deposition/compaction","Same thing","Metamorphic always sedimentary","Sedimentary always metamorphic"], answerIndex:0 },
    { q_ar:"ما معادن الصخور الشائعة؟", q_en:"Common rock-forming minerals?", choices_ar:["كوارتز، فلسبار، ميكا، كالسيت، أوليفين","ذهب وفضة فقط","غازات","بلاستيك"], choices_en:["Quartz, feldspar, mica, calcite, olivine","Gold & silver only","Gases","Plastic"], answerIndex:0 },
    { q_ar:"كيف تتعرف على معادن السيليكات؟", q_en:"How ID silicate minerals?", choices_ar:["بصلادة، لون الشق، اللمعان، الوصف البلوري، والتحليل المجهري","بالعين المجردة فقط","باستخدام حرارة عالية","باستخدام التربة فقط"], choices_en:["By hardness, streak, cleavage, crystal habit, and microscopy","By naked eye only","Using high heat","Using soil only"], answerIndex:0 },
    { q_ar:"ما الظواهر المرتبطة بالزلازل؟", q_en:"Phenomena associated with earthquakes?", choices_ar:["انهيارات أرضية، تسونامي في المحيطات، تسييل التربة","تغير بسيط في الطقس","زيادة المحاصيل","لا شيء"], choices_en:["Landslides, tsunamis in oceans, soil liquefaction","Slight weather change","Increased crops","Nothing"], answerIndex:0 },
    { q_ar:"ما النظام الجيوديناميكي؟", q_en:"What is geodynamic system?", choices_ar:["دراسة القوى والحركات التي تشكل القشرة الأرضية (التيارات الحملية، حركة الصفائح)","علم الطقس فقط","قياس الضغط الجوي","انظمة التصحر"], choices_en:["Study of forces/motions shaping Earth's crust (mantle convection, plate movements)","Weather science only","Atmospheric pressure measurement","Desertification systems"], answerIndex:0 },
    { q_ar:"ما الغلاف الصخري؟", q_en:"What is the lithosphere?", choices_ar:["الغطاء الخارجي الصلب من الأرض (قشرة + الجزء العلوي من الستار)","الغلاف الجوي فقط","المحيط فقط","المنطقة الحيوانية"], choices_en:["Outer rigid shell of Earth (crust + uppermost mantle)","Atmosphere only","Ocean only","Biosphere region"], answerIndex:0 },
    { q_ar:"العلاقة بين الجيولوجيا والهندسة المدنية؟", q_en:"Geology vs civil engineering relation?", choices_ar:["يعطي معلومات عن ثبات التربة، مواقع الفوالق، ونوعية الصخور لتصميم الأساسات","لا علاقة","الهندسة تحدد كل شيء","جيولوجيا تستخدم للزراعة فقط"], choices_en:["Provides info on ground stability, fault locations, rock types for foundation design","No relation","Engineering defines everything","Geology only for agriculture"], answerIndex:0 },
    { q_ar:"ما فائدة دراسة الجيولوجيا للموارد؟", q_en:"Value of geology for resources?", choices_ar:["تحديد مواقع البترول، المعادن، والمياه الجوفية واستخدامها المستدام","فقط للبحث النظري","لا فائدة","فقط لتصميم الطرق"], choices_en:["Locating petroleum, minerals, groundwater and guiding sustainable use","Only theoretical research","No use","Only for road design"], answerIndex:0 }
  ] }
};


/* ---------- Levels & Badges Configuration ---------- */
const LEVEL_CONFIG = [
    { name_ar: 'Trainee 1', name_en: 'Trainee 1', min_score: 0, next_score: 50 },
    { name_ar: 'Trainee 2', name_en: 'Trainee 2', min_score: 50, next_score: 150 },
    { name_ar: 'Rookie 🔰', name_en: 'Rookie 🔰', min_score: 150, next_score: 300 },
    { name_ar: 'Field Geologist 💼', name_en: 'Field Geologist 💼', min_score: 300, next_score: 500 },
    { name_ar: 'Expert 💎', name_en: 'Expert 💎', min_score: 500, next_score: 9999 }, // المستوى الأقصى
];

const BADGE_CONFIG = {
    hydro: { name_ar: 'خبير مياه 💧', name_en: 'Water Expert 💧', required_score: 100 },
    petro: { name_ar: 'خبير صخور 🌋', name_en: 'Rock Master 🌋', required_score: 100 },
    maps: { name_ar: 'رائد خرائط 🗺️', name_en: 'Map Pioneer 🗺️', required_score: 100 },
    general: { name_ar: 'الجيولوجي الشامل 🪨', name_en: 'General Geologist 🪨', required_score: 100 }
};

/* ---------- App state ---------- */
let currentSection = null;
let currentIndex = 0;
let currentScore = 0;
let correctCount = 0;
let wrongCount = 0;
let timerSeconds = 30;
let timerInterval = null;
let userData = {
    totalScore: 0,
    completedQuizzes: {}, // { hydro: 100, petro: 50, ... }
    badges: [],
};
let leaderboard = JSON.parse(localStorage.getItem('geo_leaderboard')||'[]');

/* ---------- DOM refs (كما هي) ---------- */
const sectionListEl = document.getElementById('sectionList');
const trainingContentEl = document.getElementById('trainingContent');
const quizArea = document.getElementById('quizArea');
const qLabel = document.getElementById('qLabel');
const qText = document.getElementById('qText');
const answersBox = document.getElementById('answersBox');
const timerLabel = document.getElementById('timerLabel');
const scoreVal = document.getElementById('scoreVal');
const levelBadge = document.getElementById('levelBadge');
const progInner = document.getElementById('progInner');
const progressLabel = document.getElementById('progressLabel');
const skipBtn = document.getElementById('skipBtn');
const backToMenu = document.getElementById('backToMenu');
const startChallengeBtn = document.getElementById('startChallengeBtn');

const resultModal = document.getElementById('resultModal');
const resScore = document.getElementById('resScore');
const resDetails = document.getElementById('resDetails');
const retryBtn = document.getElementById('retryBtn');
const closeResBtn = document.getElementById('closeResBtn');
const savedNote = document.getElementById('savedNote');
const leaderBtn = document.getElementById('leaderBtn');

// New UI Refs
const mainProgressPanel = document.getElementById('mainProgressPanel');
const totalScoreEl = document.getElementById('totalScore');
const userLevelEl = document.getElementById('userLevel');
const completedQuizzesEl = document.getElementById('completedQuizzes');
const levelBarInnerEl = document.getElementById('levelBarInner');
const currentLevelLabelEl = document.getElementById('currentLevelLabel');
const levelProgressLabelEl = document.getElementById('levelProgressLabel');
const badgesGridEl = document.getElementById('badgesGrid');


/* ---------- Audio (كما هي) ---------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq=880, dur=0.12, type='sine', gain=0.12){
  try{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    setTimeout(()=> { try{ o.stop() }catch(e){} }, dur*1000+30);
  }catch(e){}
}
function playCorrect(){ beep(920,0.12,'sine',0.12); }
function playWrong(){ beep(220,0.18,'square',0.14); }

/* ---------- Helpers (كما هي) ---------- */
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function formatTime(s){ const mm=Math.floor(s/60), ss=s%60; return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }

/* ---------- Core Logic: User & Level System ---------- */
function loadUserData() {
    try {
        const stored = JSON.parse(localStorage.getItem('geo_userData'));
        if (stored) {
            userData = { ...userData, ...stored };
            if (typeof userData.totalScore !== 'number') userData.totalScore = 0;
            if (typeof userData.completedQuizzes !== 'object') userData.completedQuizzes = {};
            if (!Array.isArray(userData.badges)) userData.badges = [];
        }
    } catch(e) {
        console.error("Error loading user data:", e);
    }
}

function saveUserData() {
    localStorage.setItem('geo_userData', JSON.stringify(userData));
}

function getUserLevel() {
    const score = userData.totalScore;
    let currentLevel = LEVEL_CONFIG[0];
    let nextLevel = null;

    for (let i = 0; i < LEVEL_CONFIG.length; i++) {
        if (score >= LEVEL_CONFIG[i].min_score) {
            currentLevel = LEVEL_CONFIG[i];
            nextLevel = LEVEL_CONFIG[i + 1] || currentLevel;
        } else {
            break;
        }
    }
    
    const required = nextLevel.next_score - currentLevel.min_score;
    const progress = score - currentLevel.min_score;
    const percent = required > 0 ? (progress / required) * 100 : 100;

    return {
        current: currentLevel,
        next: nextLevel,
        progress: progress,
        required: required,
        percent: Math.min(100, percent)
    };
}

function updateProgressUI() {
    const levelInfo = getUserLevel();
    const completedCount = Object.keys(QUIZZES).filter(q => userData.completedQuizzes[q] >= BADGE_CONFIG[q].required_score).length;
    const totalQuizzes = Object.keys(QUIZZES).length;

    totalScoreEl.textContent = userData.totalScore;
    userLevelEl.textContent = lang === 'ar' ? levelInfo.current.name_ar : levelInfo.current.name_en;
    completedQuizzesEl.textContent = `${completedCount}/${totalQuizzes}`;
    
    levelBarInnerEl.style.width = `${levelInfo.percent}%`;
    currentLevelLabelEl.innerHTML = `${t('levelPrefix')} <strong>${lang === 'ar' ? levelInfo.current.name_ar : levelInfo.current.name_en}</strong>`;
    
    let progressText;
    if (levelInfo.percent >= 100 && levelInfo.current.next_score !== 9999) {
        progressText = lang === 'ar' ? `جاهز للترقية!` : `Ready for Upgrade!`;
    } else if (levelInfo.current.next_score === 9999) {
        progressText = lang === 'ar' ? `المستوى الأقصى` : `Max Level`;
    } else {
        progressText = `${t('points')} ${levelInfo.progress} / ${levelInfo.required}`;
    }
    levelProgressLabelEl.textContent = progressText;

    // تحديث الشارات
    badgesGridEl.innerHTML = '';
    const unlockedBadges = Object.keys(BADGE_CONFIG).filter(key => userData.completedQuizzes[key] >= BADGE_CONFIG[key].required_score);

    unlockedBadges.forEach(key => {
        const badgeData = BADGE_CONFIG[key];
        const badgeEl = document.createElement('div');
        badgeEl.className = 'badge-item';
        badgeEl.textContent = lang === 'ar' ? badgeData.name_ar : badgeData.name_en;
        badgesGridEl.appendChild(badgeEl);
    });
}

function updateLevelBadge(score) {
    const currentLevel = getUserLevel().current;
    levelBadge.textContent = `${t('level')}: ${lang === 'ar' ? currentLevel.name_ar : currentLevel.name_en}`;
}


/* ---------- UI render (شامل للأقسام التدريبية) ---------- */
function renderSectionCards(){
  sectionListEl.innerHTML = '';
  // تحديد الأقسام الأربعة التي لها اختبار
  const quizSections = Object.values(QUIZZES).map(q => ({
    key: q.id, 
    quiz: true, 
    icon: q.title_ar.split(' ')[0], 
    title_ar: `الامتحان: ${q.title_ar.split('—')[0].trim()}`, 
    title_en: `Quiz: ${q.title_en.split('—')[0].trim()}`,
    desc_ar: `30 سؤال عملي. (درجتك السابقة: ${userData.completedQuizzes[q.id] || 0})`, 
    desc_en: `30 practical Q. (Prev. Score: ${userData.completedQuizzes[q.id] || 0})`,
    
  }));

  // الأقسام التدريبية المتبقية
  const trainingSections = FULL_TRAINING_SECTIONS.map((s,i) => {
      // استثناء الأقسام التي قمنا بتمثيلها بالفعل كاختبارات
      if (['hydro', 'rocks', 'maps_interpret'].includes(s.id)) return null;

      const quizKey = s.quiz_key;
      return { 
          key: s.id, 
          quiz: false, 
          icon: s.icon, 
          title_ar: s.title_ar, 
          title_en: `${s.icon} Unit ${i+1}: ${s.title_ar.split('—')[1]||s.title_ar}`,
          desc_ar: s.content.includes('اختبار') ? 'عرض المحتوى (يحتوي على أسئلة تطبيقية)' : 'عرض المحتوى التدريبي المفصل' , 
          desc_en: 'View detailed training content',
      };
  }).filter(s => s !== null);

  const allSections = [...quizSections, ...trainingSections];


  allSections.forEach(s=>{
    const card = document.createElement('div'); card.className='section-card';
    card.onclick = ()=> s.quiz ? startSection(s.key) : showTrainingContent(s.key);
    
    // تعديل الشعار في عنوان البطاقة ليعكس الحالة
    const statusIcon = s.quiz && (userData.completedQuizzes[s.key] >= BADGE_CONFIG[s.key].required_score) ? '✅' : s.icon;
    const title = s.quiz ? (lang === 'ar' ? s.title_ar : s.title_en) : (lang === 'ar' ? s.title_ar : s.title_en);
    const desc = s.quiz ? (lang === 'ar' ? s.desc_ar : s.desc_en) : (lang === 'ar' ? s.desc_ar : s.desc_en);

    card.innerHTML = `<div class="section-title"><span class="section-icon">${statusIcon}</span> ${title}</div>
                      <div class="section-desc">${desc}</div>`;
    sectionListEl.appendChild(card);
  });
}

/* ---------- Show Training Content (كما هي) ---------- */
function showTrainingContent(key) {
    const section = FULL_TRAINING_SECTIONS.find(s => s.id === key);
    if (!section) return;

    mainProgressPanel.style.display = 'none';
    sectionListEl.style.display = 'none';
    quizArea.style.display = 'none';
    trainingContentEl.style.display = 'block';

    const contentTitle = lang === 'ar' ? section.title_ar : section.title_en;
    const quizKey = section.quiz_key;
    
    trainingContentEl.innerHTML = `
      <h2>${contentTitle}</h2>
      ${section.content}
      <div class="controls-bottom" style="margin-top:20px;">
        <button class="ghost" onclick="hideTrainingContent()">${t('backToMenu')}</button>
        ${quizKey ? `<button class="btn" onclick="startSection('${quizKey}')">${t('startQuiz')}</button>` : ''}
      </div>
    `;
    window.scrollTo({top:0,behavior:'smooth'});
}

function hideTrainingContent() {
    trainingContentEl.style.display = 'none';
    mainProgressPanel.style.display = 'block';
    sectionListEl.style.display = 'grid';
    updateProgressUI();
    renderSectionCards();
}

/* ---------- Start section (Quiz only) ---------- */
function startSection(key){
  if(!QUIZZES[key]) { return; }
  currentSection = key;
  currentIndex = 0;
  currentScore = 0;
  correctCount = 0;
  wrongCount = 0;
  quizArea.style.display = 'block';
  sectionListEl.style.display = 'none';
  mainProgressPanel.style.display = 'none';
  trainingContentEl.style.display = 'none';
  showQuestion();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ---------- Show question (كما هي مع تحديث المستويات) ---------- */
let answered = false;
function showQuestion(){
  const items = QUIZZES[currentSection].items;
  const item = items[currentIndex];
  const n = items.length;
  qLabel.textContent = (lang==='ar')? `السؤال ${currentIndex+1} / Q${currentIndex+1}` : `Q${currentIndex+1} / Question ${currentIndex+1}`;
  qText.textContent = (lang==='ar')? item.q_ar : item.q_en;
  progressLabel.textContent = t('questionOf', {i: currentIndex+1, n});
  answersBox.innerHTML = '';
  
  const choices = (lang==='ar')? item.choices_ar.slice() : item.choices_en.slice();
  const opts = choices.map((c,i)=>({text:c,origIndex:i}));
  shuffleArray(opts);
  opts.forEach((opt, idx)=>{
    const el = document.createElement('div'); el.className='answer';
    el.innerHTML = `<div class="opt-label">${['A','B','C','D'][idx]||String.fromCharCode(65+idx)}</div><div class="opt-text">${opt.text}</div>`;
    el.dataset.orig = opt.origIndex;
    el.onclick = ()=> selectAnswer(el, item.answerIndex);
    answersBox.appendChild(el);
  });
  
  progInner.style.width = `${Math.round(((currentIndex+1)/n)*100)}%`;
  scoreVal.textContent = currentScore;
  updateLevelBadge(currentScore); // تحديث المستوى أثناء الاختبار
  startTimer();
  const card = document.getElementById('questionCard');
  card.classList.remove('fade-in'); void card.offsetWidth; card.classList.add('fade-in');
  answered = false;
}

/* ---------- Answer selection (تحديث نقاط المستخدم) ---------- */
function selectAnswer(el, correctIndex){
  if(answered) return;
  answered = true;
  stopTimer();
  const chosenOrig = Number(el.dataset.orig);
  const correctChoiceIndex = correctIndex;
  const isCorrect = (chosenOrig === correctChoiceIndex);
  if(isCorrect){
    el.classList.add('correct'); playCorrect();
    currentScore += 10; correctCount++;
  } else {
    el.classList.add('wrong'); playWrong();
    currentScore -= 5; wrongCount++;
    Array.from(answersBox.children).forEach(ch=>{
      if(Number(ch.dataset.orig) === correctChoiceIndex) ch.classList.add('correct');
      ch.onclick = null;
    });
  }
  scoreVal.textContent = currentScore;
  updateLevelBadge(currentScore);
  setTimeout(()=> goNext(), 900);
}

/* ---------- Skip (unanswered) (كما هي) ---------- */
skipBtn.addEventListener('click', ()=>{
  if(!currentSection || answered) return;
  answered = true;
  stopTimer();
  const item = QUIZZES[currentSection].items[currentIndex];
  const correctIndex = item.answerIndex;
  Array.from(answersBox.children).forEach(ch=>{
    if(Number(ch.dataset.orig) === correctIndex) ch.classList.add('correct');
    ch.onclick = null;
  });
  setTimeout(()=> goNext(),700);
});

/* ---------- Timer (كما هي) ---------- */
function startTimer(){
  let tleft = timerSeconds || 30;
  timerLabel.textContent = formatTime(tleft);
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    tleft--;
    timerLabel.textContent = formatTime(tleft);
    if(tleft<=0){
      clearInterval(timerInterval);
      if(!answered){
        answered = true;
        playWrong();
        currentScore -= 5; wrongCount++;
        scoreVal.textContent = currentScore;
        updateLevelBadge(currentScore);
        const item = QUIZZES[currentSection].items[currentIndex];
        const corr = item.answerIndex;
        Array.from(answersBox.children).forEach(ch=>{
          if(Number(ch.dataset.orig) === corr) ch.classList.add('correct');
          ch.onclick = null;
        });
        setTimeout(()=> goNext(),900);
      }
    }
  },1000);
}
function stopTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval = null; }

/* ---------- Finish quiz (تحديث بيانات المستخدم وحفظها) ---------- */
function finishQuiz(){
  quizArea.style.display = 'none';
  stopTimer();
  const totalQuestions = QUIZZES[currentSection].items.length;
  const totalPossible = totalQuestions * 10;
  const percent = Math.max(0, Math.round((currentScore / totalPossible) * 100));

  // 1. تحديث إجمالي النقاط
  // نستخدم أعلى نتيجة حققها المستخدم في هذا القسم فقط
  const previousHigh = userData.completedQuizzes[currentSection] || 0;
  let scoreGained = 0;
  if (currentScore > previousHigh) {
    scoreGained = currentScore - previousHigh;
    userData.totalScore += scoreGained;
    userData.completedQuizzes[currentSection] = currentScore;
  }
  
  // 2. التحقق من الشارات
  const badgeData = BADGE_CONFIG[currentSection];
  if (currentScore >= badgeData.required_score && !userData.badges.includes(currentSection)) {
      userData.badges.push(currentSection);
      alert(`${lang === 'ar' ? 'تهانينا! لقد ربحت الشارة: ' : 'Congratulations! You earned the badge: '}${lang === 'ar' ? badgeData.name_ar : badgeData.name_en}`);
  }

  // 3. حفظ البيانات
  saveUserData();

  resScore.textContent = `${currentScore} نقطة`;
  const sectionTitle = lang === 'ar' ? QUIZZES[currentSection].title_ar : QUIZZES[currentSection].title_en;
  resDetails.innerHTML = `
    <div class="small-muted">${lang==='ar'?'القسم':'Section'}: ${sectionTitle}</div>
    <div style="margin-top:8px">${lang==='ar'?'النقاط المكتسبة الآن':'Score Gained Now'}: <strong>${scoreGained}</strong></div>
    <div style="margin-top:8px">${lang==='ar'?'الإجابات الصحيحة':'Correct'}: <strong>${correctCount}/${totalQuestions}</strong></div>
  `;
  const level = getUserLevel().current;
  document.getElementById('resTitle').textContent = (lang==='ar'?'النتيجة النهائية':'Final Result') + ` — ${lang === 'ar' ? level.name_ar : level.name_en}`;
  
  // 4. تحديث لوحة النتائج العامة (Leaderboard)
  const entry = { id: Date.now(), section: currentSection, score: currentScore, when: new Date().toISOString(), level: (lang === 'ar' ? level.name_ar : level.name_en), lang, totalScore: userData.totalScore };
  leaderboard.push(entry); leaderboard.sort((a,b)=> b.totalScore - a.totalScore); // ترتيب حسب الإجمالي
  if(leaderboard.length>100) leaderboard = leaderboard.slice(0,100);
  localStorage.setItem('geo_leaderboard', JSON.stringify(leaderboard));
  
  savedNote.textContent = t('savedNote');
  resultModal.style.display = 'flex';
}

/* ---------- Event Listeners for new UI elements ---------- */
startChallengeBtn.addEventListener('click', () => {
    // إخفاء لوحة التقدم وإظهار قائمة التحديات
    mainProgressPanel.style.display = 'none';
    sectionListEl.style.display = 'grid';
});
backToMenu.addEventListener('click', () => {
    // العودة إلى لوحة التقدم الرئيسية
    quizArea.style.display = 'none';
    mainProgressPanel.style.display = 'block';
    updateProgressUI();
});
closeResBtn.addEventListener('click', ()=> {
    resultModal.style.display='none';
    quizArea.style.display='none';
    mainProgressPanel.style.display='block';
    sectionListEl.style.display='grid';
    updateProgressUI(); // تحديث اللوحة بعد إغلاق النتائج
    renderSectionCards(); // لتحديث أيقونات الشارات
});

/* ---------- Language Toggle (كما هي مع تحديث الواجهة الجديدة) ---------- */
langToggle.addEventListener('click', () => {
    lang = (lang === 'ar') ? 'en' : 'ar';
    localStorage.setItem('geo_lang', lang);
    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
    refreshLangUI();
    updateProgressUI();
    renderSectionCards();
    updateLevelBadge();
    
    // إذا كان محتوى التدريب مفتوحاً، أعد عرضه باللغة الجديدة
    if (trainingContentEl.style.display === 'block') {
        const currentId = FULL_TRAINING_SECTIONS.find(s => trainingContentEl.innerHTML.includes(s.title_ar) || trainingContentEl.innerHTML.includes(s.title_en))?.id;
        if (currentId) showTrainingContent(currentId);
    }
});
document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';

/* ---------- Init ---------- */
function init(){
  loadUserData();
  refreshLangUI();
  updateProgressUI();
  renderSectionCards();
  updateLevelBadge(0);
  // إظهار لوحة التقدم الرئيسية كشاشة أولى
  mainProgressPanel.style.display = 'block';
  sectionListEl.style.display = 'none';
  // resume audio on gesture
  document.addEventListener('click', ()=> { if(audioCtx.state==='suspended') audioCtx.resume(); }, { once:true });
}
init();

</script>
</body>
</html>

