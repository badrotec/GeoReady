// بيانات الأسئلة الكاملة (تم إضافة الأقسام الأربعة الأخرى بأسئلة)
const questionsData = {
    "basic-geology": [
        // ... (الأسئلة السابقة هنا)
        {
            "id": 1,
            "question": "أي مما يلي يُعتبر من المعادن؟",
            "options": ["الكوارتز", "البازلت", "الجرانيت", "الحجر الجيري"],
            "answer": "الكوارتز",
            "explanation": "الكوارتز هو معدن مكون من ثاني أكسيد السيليكون، بينما البازلت والجرانيت والحجر الجيري هي صخور تتكون من مجموعة من المعادن."
        },
        {
            "id": 2,
            "question": "العنصر الأساسي في تركيب الكوارتز هو:",
            "options": ["الحديد", "السيليكون", "الكالسيوم", "الألومنيوم"],
            "answer": "السيليكون",
            "explanation": "الكوارتز يتكون أساسًا من ثاني أكسيد السيليكون (SiO₂)، حيث يشكل السيليكون العنصر الأساسي في تركيبه الكيميائي."
        },
        {
            "id": 3,
            "question": "الصخور النارية تتكون نتيجة:",
            "options": [
                "ترسيب المواد الذائبة في الماء",
                "تبخر مياه البحار",
                "تبرد وتصلب الصهارة",
                "ضغط المواد العضوية"
            ],
            "answer": "تبرد وتصلب الصهارة",
            "explanation": "تنشأ الصخور النارية من تبرد وتصلب الصهارة (الماغما) سواء في باطن الأرض (صخور جوفية) أو على سطحها (صخور بركانية)."
        },
        {
            "id": 4,
            "question": "من أمثلة الصخور الرسوبية الكيميائية:",
            "options": ["الجرانيت", "الحجر الجيري", "البازلت", "الرخام"],
            "answer": "الحجر الجيري",
            "explanation": "الحجر الجيري هو صخر رسوبي كيميائي يتكون من ترسب كربونات الكالسيوم من المحاليل المائية."
        },
        {
            "id": 5,
            "question": "التحول في الصخور يحدث بفعل:",
            "options": ["الحرارة والضغط", "الرياح", "التجوية", "المياه الجوفية فقط"],
            "answer": "الحرارة والضغط",
            "explanation": "تحدث عملية التحول في الصخور نتيجة تعرضها لدرجات حرارة وضغوط عالية، مما يؤدي إلى تغير في تركيبها المعدني ونسيجها."
        },
        {
            "id": 6,
            "question": "أي من التالي ليس صخرًا متحولًا؟",
            "options": ["الشيست", "الرخام", "الجرانيت", "النايس"],
            "answer": "الجرانيت",
            "explanation": "الجرانيت هو صخر ناري، بينما الشيست والرخام والنايس هي صخور متحولة."
        },
        {
            "id": 7,
            "question": "الطبقات الجيولوجية الأقدم توجد عادة:",
            "options": ["في الأعلى", "في الأسفل", "في الوسط", "في أي مكان عشوائي"],
            "answer": "في الأسفل",
            "explanation": "وفقًا لمبدأ تعاقب الطبقات، تكون الطبقات الأقدم في الأسفل والأحدث في الأعلى في التتابع الطبقي غير المقلوب."
        },
        {
            "id": 8,
            "question": "وحدة الزمن الجيولوجي الأكبر تُسمى:",
            "options": ["العصر", "الحقبة", "الحقبة الكبرى", "الفترة"],
            "answer": "الحقبة الكبرى",
            "explanation": "الحقبة الكبرى (Eon) هي أكبر وحدة زمنية في المقياس الزمني الجيولوجي، تليها الحقبة (Era) ثم الفترة (Period) فالعصر (Epoch)."
        },
        {
            "id": 9,
            "question": "الأحافير تُستخدم في:",
            "options": [
                "تحديد تركيب الصخور الكيميائي",
                "معرفة عمر الطبقات",
                "تحديد نوع الصهارة",
                "قياس الكثافة"
            ],
            "answer": "معرفة عمر الطبقات",
            "explanation": "تستخدم الأحافير في تحديد العمر النسبي للطبقات الصخرية ومضاهاة الطبقات بين المناطق المختلفة."
        },
        {
            "id": 10,
            "question": "من الأحافير الفهرسية الجيدة:",
            "options": ["الديناصور", "التريلوبايت", "الإنسان القديم", "النباتات الحديثة"],
            "answer": "التريلوبايت",
            "explanation": "التريلوبايت من الأحافير الفهرسية الممتازة لأنها عاشت لفترة زمنية محددة وانتشرت على نطاق واسع."
        },
        {
            "id": 11,
            "question": "الصخور الرسوبية تشكل نسبة تقارب:",
            "options": [
                "10% من القشرة الأرضية",
                "50%",
                "5%",
                "75% من سطح اليابسة"
            ],
            "answer": "75% من سطح اليابسة",
            "explanation": "رغم أن الصخور الرسوبية تشكل 5% فقط من حجم القشرة الأرضية، إلا أنها تغطي حوالي 75% من سطح اليابسة."
        },
        {
            "id": 12,
            "question": "من أمثلة الصخور النارية الجوفية:",
            "options": ["البازلت", "الريولايت", "الجرانيت", "الأنديزيت"],
            "answer": "الجرانيت",
            "explanation": "الجرانيت هو صخر ناري جوفي يتكون من تبرد الصهارة ببطء في باطن الأرض، مما يسمح بتكون بلورات كبيرة."
        },
        {
            "id": 13,
            "question": "التطبق المتقاطع يدل على:",
            "options": [
                "تغير في لون الصخر",
                "تغير في اتجاه الترسيب",
                "تغير في التركيب المعدني",
                "عملية تحول"
            ],
            "answer": "تغير في اتجاه الترسيب",
            "explanation": "التطبق المتقاطع ينتج عن تغير اتجاه التيارات المائية أو الرياحية أثناء عملية الترسيب."
        },
        {
            "id": 14,
            "question": "التحجر هو:",
            "options": [
                "إذابة الأحافير",
                "استبدال المواد العضوية بالمعادن",
                "تبخر المياه",
                "ضغط الصخور"
            ],
            "answer": "استبدال المواد العضوية بالمعادن",
            "explanation": "التحجر هو عملية استبدال المواد العضوية في الكائنات الحية بمعادن مثل السيليكا أو الكالسيت."
        },
        {
            "id": 15,
            "question": "أكثر المعادن صلابة هو:",
            "options": ["الكوارتز", "الفلسبار", "الكالسيت", "الألماس"],
            "answer": "الألماس",
            "explanation": "الألماس هو أصلب المعادن الطبيعية ويحتل المرتبة 10 على مقياس موس للصلادة."
        },
        {
            "id": 16,
            "question": "مقياس موس يُستخدم لقياس:",
            "options": ["الكثافة", "الصلابة", "اللون", "الوزن الذري"],
            "answer": "الصلابة",
            "explanation": "مقياس موس هو مقياس نسبي لصلادة المعادن، ابتكره العالم الألماني فريدريك موس عام 1812."
        },
        {
            "id": 17,
            "question": "عملية التجوية الكيميائية تؤدي إلى:",
            "options": [
                "تفتت الصخور فقط",
                "تغير التركيب الكيميائي للصخر",
                "ترسيب المعادن",
                "تجمد الماء في الشقوق"
            ],
            "answer": "تغير التركيب الكيميائي للصخر",
            "explanation": "التجوية الكيميائية تغير التركيب الكيميائي للصخور من خلال تفاعلات كيميائية مثل الأكسدة والتحلل المائي."
        },
        {
            "id": 18,
            "question": "دورة الصخور توضح:",
            "options": [
                "تكوين المعادن فقط",
                "تحول الصخور من نوع إلى آخر",
                "تكوين القارات",
                "نشوء الكائنات الحية"
            ],
            "answer": "تحول الصخور من نوع إلى آخر",
            "explanation": "دورة الصخور توضح العلاقة بين الصخور النارية والرسوبية والمتحولة وكيفية تحولها من نوع إلى آخر."
        },
        {
            "id": 19,
            "question": "الصخور النارية الغنية بالسيليكا تُسمى:",
            "options": ["قاعدية", "فوق قاعدية", "متوسطة", "حمضية"],
            "answer": "حمضية",
            "explanation": "الصخور النارية الحمضية تحتوي على أكثر من 66% سيليكا، مثل الجرانيت والريولايت."
        },
        {
            "id": 20,
            "question": "في علم الطبقات، المضاهاة تعني:",
            "options": [
                "مقارنة صلابة الصخور",
                "مقارنة الطبقات من أماكن مختلفة",
                "مقارنة الألوان",
                "تحديد نوع المعادن"
            ],
            "answer": "مقارنة الطبقات من أماكن مختلفة",
            "explanation": "المضاهاة هي عملية ربط ومقارنة الطبقات الصخرية من مناطق مختلفة لتحديد علاقاتها الزمنية."
        },
        {
            "id": 21,
            "question": "الجرانيت يتكون أساسًا من:",
            "options": [
                "الفلسبار والكوارتز",
                "الكالسيت والدولوميت",
                "المايكا والبيروكسين",
                "الحديد والمغنيسيوم"
            ],
            "answer": "الفلسبار والكوارتز",
            "explanation": "الجرانيت يتكون أساسًا من الفلسبار القلوي والكوارتز، مع كميات أقل من المعادن الداكنة مثل المايكا."
        },
        {
            "id": 22,
            "question": "الحجر الرملي يتكون من:",
            "options": ["معادن كربوناتية", "حبيبات كوارتز", "طين ومعادن فلزية", "مواد عضوية"],
            "answer": "حبيبات كوارتز",
            "explanation": "الحجر الرملي يتكون أساسًا من حبيبات الكوارتز المتماسكة بمادة لاحمة مثل السيليكا أو كربونات الكالسيوم."
        },
        {
            "id": 23,
            "question": "في الصخور المتحولة، اتجاه المعادن يدل على:",
            "options": ["عمر الصخر", "نوع الصهارة", "اتجاه الضغط", "سرعة التبريد"],
            "answer": "اتجاه الضغط",
            "explanation": "في الصخور المتحولة، يتجه ترتيب المعادن بشكل متوازي نتيجة للضغط الموجه أثناء عملية التحول."
        },
        {
            "id": 24,
            "question": "أي من العصور التالية هو الأقدم؟",
            "options": ["الميسوزوي", "السينوزوي", "الباليوزوي", "البروتيروزوي"],
            "answer": "البروتيروزوي",
            "explanation": "البروتيروزوي هو الحقبة الأقدم بين هذه الخيارات، حيث امتد من 2500 إلى 541 مليون سنة مضت."
        },
        {
            "id": 25,
            "question": "في الجيولوجيا التاريخية، دراسة الطبقات والصخور تُستخدم في:",
            "options": [
                "رسم الخرائط الجيولوجية",
                "إعادة بناء تاريخ الأرض",
                "معرفة درجة الحرارة",
                "تحليل المعادن فقط"
            ],
            "answer": "إعادة بناء تاريخ الأرض",
            "explanation": "تهدف الجيولوجيا التاريخية إلى إعادة بناء تاريخ الأرض من خلال درسة الطبقات الصخرية والأحافير والتراكيب الجيولوجية."
        }
    ],
    "hydrogeology": [
        // ... (الأسئلة السابقة هنا)
        {
            "id": 1,
            "question": "الهيدروجيولوجيا تدرس:",
            "options": ["الصخور النارية فقط", "المياه الجوفية وحركتها", "التكتونيات", "المعادن"],
            "answer": "المياه الجوفية وحركتها",
            "explanation": "الهيدروجيولوجيا هي العلم الذي يدرس توزيع وحركة المياه الجوفية في التربة والصخور تحت سطح الأرض."
        },
        {
            "id": 2,
            "question": "الطبقة الحاملة للمياه الجوفية تُسمى:",
            "options": ["الطبقة غير المشبعة", "الطبقة الحاملة (Aquifer)", "الطبقة المعدنية", "الصخر المتحول"],
            "answer": "الطبقة الحاملة (Aquifer)",
            "explanation": "الطبقة الحاملة (Aquifer) هي طبقة صخرية مسامية ونفاذة قادرة على تخزين ونقل كميات كبيرة من المياه الجوفية."
        },
        {
            "id": 3,
            "question": "الطبقة غير المشبعة تعرف بـ:",
            "options": ["Zone of Saturation", "Zone of Aeration", "Aquifer", "Bedrock"],
            "answer": "Zone of Aeration",
            "explanation": "الطبقة غير المشبعة (Zone of Aeration) هي المنطقة الواقعة فوق مستوى الماء الجوفي حيث تكون المسام مليئة جزئيًا بالماء والهواء."
        },
        {
            "id": 4,
            "question": "معدل نفاذية الصخور يعني:",
            "options": ["صلابة الصخور", "قدرة الصخور على تمرير المياه", "كثافة المياه", "عمق الصخر"],
            "answer": "قدرة الصخور على تمرير المياه",
            "explanation": "النفاذية هي خاصية الصخور والتربة التي تسمح للمياه بالتدفق خلالها، وتقاس بكمية المياه التي يمكن أن تمر عبر مساحة معينة في زمن محدد."
        },
        {
            "id": 5,
            "question": "الصخور الرملية غالبًا ما تكون:",
            "options": ["طبقات حاملة للمياه", "طبقات غير حاملة", "صخور متحولة", "صخور نارية"],
            "answer": "طبقات حاملة للمياه",
            "explanation": "الصخور الرملية تتميز بمسامية ونفاذية عالية، مما يجعلها طبقات حاملة ممتازة للمياه الجوفية."
        },
        {
            "id": 6,
            "question": "المياه الجوفية المرتفعة طبيعيًا فوق سطح الأرض تُسمى:",
            "options": ["مياه ارتوازية", "مياه سطحية", "مياه متجددة", "مياه معدنية"],
            "answer": "مياه ارتوازية",
            "explanation": "المياه الارتوازية هي مياه جوفية تتدفق تلقائيًا إلى سطح الأرض بسبب الضغط في الطبقة الحاملة المحصورة."
        },
        {
            "id": 7,
            "question": "البئر الذي يصل إلى الطبقة الحاملة ويخرج منها الماء طبيعيًا هو:",
            "options": ["بئر جاف", "بئر ارتوازي", "بئر مفتوح", "بئر أرتوازي مغلق"],
            "answer": "بئر ارتوازي",
            "explanation": "البئر الارتوازي هو بئر يحفر في طبقة حاملة محصورة، حيث يتدفق الماء تلقائيًا إلى سطح الأرض بسبب الضغط."
        },
        {
            "id": 8,
            "question": "المياه الجوفية تتجدد بشكل رئيسي عن طريق:",
            "options": ["التبخر", "التسرب من الأمطار", "الذوبان الجليدي", "النشاط البركاني"],
            "answer": "التسرب من الأمطار",
            "explanation": "تتجدد المياه الجوفية بشكل رئيسي من خلال تسرب مياه الأمطار عبر التربة والطبقات الصخرية إلى الخزانات الجوفية."
        },
        {
            "id": 9,
            "question": "المسامية تعني:",
            "options": ["قدرة الصخر على تحمل الضغط", "نسبة الفراغات في الصخر", "وزن الصخور", "عمق الصخور"],
            "answer": "نسبة الفراغات في الصخر",
            "explanation": "المسامية هي نسبة حجم الفراغات في الصخر أو التربة إلى الحجم الكلي، وتشير إلى قدرة المادة على تخزين السوائل."
        },
        {
            "id": 10,
            "question": "أي من الصخور التالية منخفضة النفاذية عادة؟",
            "options": ["الحجر الرملي", "الحجر الجيري المفتت", "الطين", "الحصى"],
            "answer": "الطين",
            "explanation": "الطين يتميز بمسامية عالية لكن نفاذية منخفضة جدًا بسبب صغر حجم المسام واتصالها الضعيف."
        },
        {
            "id": 11,
            "question": "الجدول المائي (Water Table) هو:",
            "options": ["عمق البئر", "سطح المياه الجوفية", "طبقة غير مشبعة", "طبقة صخرية صلبة"],
            "answer": "سطح المياه الجوفية",
            "explanation": "الجدول المائي هو السطح العلوي للمنطقة المشبعة بالماء في باطن الأرض، حيث يكون الضغط المساوي للضغط الجوي."
        },
        {
            "id": 12,
            "question": "الطبقة الحاملة غير المحصورة تعرف بـ:",
            "options": ["Confined Aquifer", "Unconfined Aquifer", "Artesian Aquifer", "Impermeable Layer"],
            "answer": "Unconfined Aquifer",
            "explanation": "الطبقة الحاملة غير المحصورة هي التي لا تعلوها طبقة غير منفذة، ويكون سطحها العلوي هو مستوى الماء الجوفي."
        },
        {
            "id": 13,
            "question": "من طرق قياس حركة المياه الجوفية:",
            "options": ["المقياس الحراري", "اختبار النفاذية", "اختبار الضغط", "قياس درجة الحرارة"],
            "answer": "اختبار النفاذية",
            "explanation": "يتم قياس حركة المياه الجوفية باستخدام اختبارات النفاذية مثل اختبار الضخ واختبار الحقن."
        },
        {
            "id": 14,
            "question": "المياه الجوفية الغنية بالمعادن تسمى:",
            "options": ["مياه سطحية", "مياه معدنية", "مياه ملوثة", "مياه عذبة"],
            "answer": "مياه معدنية",
            "explanation": "المياه المعدنية هي مياه جوفية تحتوي على كميات كبيرة من الأملاح والمعادن الذائبة."
        },
        {
            "id": 15,
            "question": "التلوث بالمواد الكيميائية في المياه الجوفية يُعرف بـ:",
            "options": ["التلوث الطبيعي", "التلوث الصناعي", "التلوث الكيميائي", "التلوث البيولوجي"],
            "answer": "التلوث الكيميائي",
            "explanation": "التلوث الكيميائي للمياه الجوفية ينتج عن تسرب المواد الكيميائية من المصادر الصناعية أو الزراعية."
        },
        {
            "id": 16,
            "question": "أي من التالي يؤثر على سرعة حركة المياه الجوفية؟",
            "options": ["المسامية والنفاذية", "لون الماء", "نوع المعادن فقط", "العمق فقط"],
            "answer": "المسامية والنفاذية",
            "explanation": "سرعة حركة المياه الجوفية تعتمد على نفاذية الصخور ومساميتها، وكذلك على التدرج الهيدروليكي."
        },
        {
            "id": 17,
            "question": "المياه الجوفية في الصخور المتصدعة تُسمى:",
            "options": ["مياه طبقية", "مياه تصدعية", "مياه سطحية", "مياه طبقية متحركة"],
            "answer": "مياه تصدعية",
            "explanation": "المياه التصدعية توجد في الشقوق والفواصل والتصدعات في الصخور، وتختلف عن المياه الطبقية في الطبقات المسامية."
        },
        {
            "id": 18,
            "question": "الطبقة الحاملة المحصورة فوقها صخور غير نفاذة تُسمى:",
            "options": ["Unconfined Aquifer", "Confined Aquifer", "Artesian Aquifer", "Impermeable Layer"],
            "answer": "Confined Aquifer",
            "explanation": "الطبقة الحاملة المحصورة هي التي تعلوها وتحتويها طبقات صخرية غير منفذة، مما يخلق ضغطًا على المياه فيها."
        },
        {
            "id": 19,
            "question": "أي من العوامل التالية يزيد من تجدد المياه الجوفية؟",
            "options": ["إزالة الغطاء النباتي", "زيادة الأمطار", "إزالة التربة السطحية", "بناء الطرق"],
            "answer": "زيادة الأمطار",
            "explanation": "تساعد زيادة كميات الأمطار على تجدد المياه الجوفية من خلال زيادة معدل التسرب إلى الخزانات الجوفية."
        },
        {
            "id": 20,
            "question": "الميزة الأساسية للطبقة الحاملة الارتوازية هي:",
            "options": ["المياه تحت ضغط", "المياه في طبقة مفتوحة", "عدم وجود ماء", "مياه متحركة ببطء"],
            "answer": "المياه تحت ضغط",
            "explanation": "الطبقة الحاملة الارتوازية تتميز بأن المياه فيها تكون تحت ضغط، مما يسمح بتدفقها تلقائيًا إلى سطح الأرض."
        },
        {
            "id": 21,
            "question": "أي الصخور التالية غالبًا ما تشكل حاجزًا مائيًا؟",
            "options": ["الطين", "الحجر الرملي", "الحصى", "الحجر الجيري المفتت"],
            "answer": "الطين",
            "explanation": "الطين يشكل حاجزًا مائيًا فعالاً بسبب نفاذيته المنخفضة جدًا، مما يمنع أو يبطئ حركة المياه الجوفية."
        },
        {
            "id": 22,
            "question": "البئر الذي يحتاج إلى ضخ المياه للخروج يُسمى:",
            "options": ["بئر ارتوازي", "بئر عادي (غير ارتوازي)", "بئر معدنية", "بئر طبيعي"],
            "answer": "بئر عادي (غير ارتوازي)",
            "explanation": "البئر العادي (غير الارتوازي) هو الذي يحتاج إلى ضخ لاستخراج المياه، على عكس البئر الارتوازي الذي يتدفق تلقائيًا."
        },
        {
            "id": 23,
            "question": "اختبارات النفاذية تُستخدم لتحديد:",
            "options": ["درجة الحرارة", "سرعة مرور المياه عبر الصخور", "الكثافة", "لون الصخور"],
            "answer": "سرعة مرور المياه عبر الصخور",
            "explanation": "اختبارات النفاذية تقيس معدل تدفق المياه عبر الصخور أو التربة تحت تدرج هيدروليكي معين."
        },
        {
            "id": 24,
            "question": "من أهم مصادر تلوث المياه الجوفية:",
            "options": ["الأمطار فقط", "التسرب من المصانع والمزارع", "التغيرات المناخية", "الصخور المتحولة"],
            "answer": "التسرب من المصانع والمزارع",
            "explanation": "تعتبر الأنشطة الصناعية والزراعية من أهم مصادر تلوث المياه الجوفية بسبب تسرب المواد الكيميائية والمبيدات."
        },
        {
            "id": 25,
            "question": "المياهل (Permeability) في الهيدروجيولوجيا تعني:",
            "options": ["قدرة الصخور على امتصاص المياه", "قدرة المياه على المرور خلال الصخور", "كمية المياه المخزنة", "عمق البئر"],
            "answer": "قدرة المياه على المرور خلال الصخور",
            "explanation": "النفاذية (Permeability) هي خاصية الصخور التي تسمح للمياه بالمرور خلالها، وتختلف عن المسامية التي تشير إلى قدرة التخزين."
        }
    ],
    "petrology": [
        // ... (الأسئلة السابقة هنا)
        {
            "id": 1,
            "topic": "الجيولوجيا البترولية",
            "question": "البترول يتكون أساسًا من:",
            "options": ["الكربون والهيدروجين", "الأكسجين والنيتروجين", "الكالسيوم والحديد", "الكبريت والسيليكا"],
            "answer": "الكربون والهيدروجين",
            "explanation": "يتكون البترول أساسًا من مركبات الهيدروكربونات التي تتألف من ذرات الكربون والهيدروجين بنسب مختلفة."
        },
        {
            "id": 2,
            "topic": "الجيولوجيا البترولية",
            "question": "أصل النفط يعود إلى:",
            "options": ["بقايا كائنات بحرية دقيقة", "الصخور النارية", "النشاط البركاني", "التفاعلات الكيميائية غير العضوية"],
            "answer": "بقايا كائنات بحرية دقيقة",
            "explanation": "ينشأ النفط من تحلل الكائنات البحرية الدقيقة (العوالق) التي ترسبت في قيعان البحار والمحيطات وتحللت في ظروف خالية من الأكسجين."
        },
        {
            "id": 3,
            "topic": "الجيولوجيا البترولية",
            "question": "الصخور المصدرية (Source Rocks) هي:",
            "options": ["التي يخزن فيها النفط", "التي يتكون فيها النفط", "التي تمنع هجرة النفط", "التي تغطي المكمن"],
            "answer": "التي يتكون فيها النفط",
            "explanation": "الصخور المصدرية هي الصخور الغنية بالمواد العضوية التي تتحول بفعل الحرارة والضغط إلى النفط والغاز."
        },
        {
            "id": 4,
            "topic": "الجيولوجيا البترولية",
            "question": "الصخور الخازنة (Reservoir Rocks) تتميز بـ:",
            "options": ["قلة المسامية", "ارتفاع النفاذية والمسامية", "احتوائها على معادن ثقيلة", "طبيعتها النارية فقط"],
            "answer": "ارتفاع النفاذية والمسامية",
            "explanation": "الصخور الخازنة تتميز بمسامية عالية تسمح بتخزين النفط ونفاذية عالية تسمح له بالتدفق خلالها."
        },
        {
            "id": 5,
            "topic": "الجيولوجيا البترولية",
            "question": "الصخور الغطائية (Cap Rocks) تكون عادة:",
            "options": ["مسامية", "غير منفذة", "جيرية", "رملية"],
            "answer": "غير منفذة",
            "explanation": "الصخور الغطائية هي صخور غير منفذة تعلو المكمن النفطي وتمنع هجرة النفط والغاز إلى الأعلى."
        },
        {
            "id": 6,
            "topic": "الجيولوجيا البترولية",
            "question": "الهيدروكربونات هي:",
            "options": ["مركبات من الكربون والهيدروجين", "مركبات معدنية", "مركبات كبريتية", "أكاسيد معدنية"],
            "answer": "مركبات من الكربون والهيدروجين",
            "explanation": "الهيدروكربونات هي مركبات عضوية تتكون أساسًا من ذرات الكربون والهيدروجين، وهي المكون الرئيسي للنفط والغاز."
        },
        {
            "id": 7,
            "topic": "الجيولوجيا البترولية",
            "question": "عملية تحول المواد العضوية إلى بترول تُعرف بـ:",
            "options": ["النضوج الحراري (Thermal Maturation)", "التبلور", "الانصهار", "الأكسدة"],
            "answer": "النضوج الحراري (Thermal Maturation)",
            "explanation": "النضوج الحراري هو عملية تحول المواد العضوية إلى نفط وغاز تحت تأثير الحرارة والضغط عبر ملايين السنين."
        },
        {
            "id": 8,
            "topic": "الجيولوجيا البترولية",
            "question": "المكمن البترولي (Oil Trap) هو:",
            "options": ["صخر ناري يحتوي على معادن", "مكان تتجمع فيه الهيدروكربونات", "منطقة التصدع", "نبع ماء جوفي"],
            "answer": "مكان تتجمع فيه الهيدروكربونات",
            "explanation": "المكمن البترولي هو تركيب جيولوجي يسمح بتجمع النفط والغاز ومنع هجرته، ويتكون من صخر خازن وصخر غطائي."
        },
        {
            "id": 9,
            "topic": "الجيولوجيا البترولية",
            "question": "من أنواع المصائد البترولية:",
            "options": ["التركيبية والطبقية", "الكيميائية والمغناطيسية", "السطحية والجوفية", "الرسوبية والمتحولة"],
            "answer": "التركيبية والطبقية",
            "explanation": "تنقسم المصائد البترولية إلى نوعين رئيسيين: التركيبية (مثل الطيات والصدوع) والطبقية (نتيجة تغير صفات الصخور)."
        },
        {
            "id": 10,
            "topic": "الجيولوجيا البترولية",
            "question": "أفضل الصخور الخازنة للنفط عادة تكون:",
            "options": ["الطفلة", "الحجر الرملي", "الجرانيت", "البازلت"],
            "answer": "الحجر الرملي",
            "explanation": "الحجر الرملي من أفضل الصخور الخازنة بسبب مساميته العالية ونفاذيته الجيدة، يليه الحجر الجيري في الأهمية."
        },
        {
            "id": 11,
            "topic": "الجيولوجيا البترولية",
            "question": "المصائد التركيبية تنشأ بفعل:",
            "options": ["تراكم الرواسب", "القوى التكتونية", "التآكل", "العمليات الكيميائية"],
            "answer": "القوى التكتونية",
            "explanation": "تنشأ المصائد التركيبية نتيجة للقوى التكتونية التي تؤدي إلى تكوين الطيات والصدوع والتراكيب الأخرى."
        },
        {
            "id": 12,
            "topic": "الجيولوجيا البترولية",
            "question": "المصائد الطبقية تتكون بسبب:",
            "options": ["التغير في ميل الطبقات", "التراكيب الجيولوجية", "التغير في نوع الصخر أثناء الترسيب", "التصدعات الرأسية"],
            "answer": "التغير في نوع الصخر أثناء الترسيب",
            "explanation": "تنشأ المصائد الطبقية نتيجة التغير الرأسي أو الأفقي في خصائص الصخور، مثل تغير المسامية أو النفاذية."
        },
        {
            "id": 13,
            "topic": "الجيولوجيا البترولية",
            "question": "الغاز الطبيعي يتكون أساسًا من:",
            "options": ["الميثان", "الإيثان", "البروبان", "الهيدروجين"],
            "answer": "الميثان",
            "explanation": "يتكون الغاز الطبيعي أساسًا من الميثان (CH₄)، مع كميات أقل من الإيثان والبروبان والبيوتان."
        },
        {
            "id": 14,
            "topic": "الجيولوجيا البترولية",
            "question": "الجيوكيمياء البترولية تدرس:",
            "options": ["خصائص الصخور النارية", "التركيب الكيميائي للنفط ومصدره", "المعادن", "أنواع الزلازل"],
            "answer": "التركيب الكيميائي للنفط ومصدره",
            "explanation": "تهتم الجيوكيمياء البترولية بدراسة التركيب الكيميائي للنفط والغاز وتتبع مصدره وتاريخه الجيولوجي."
        },
        {
            "id": 15,
            "topic": "الجيولوجيا البترولية",
            "question": "الهجرة البترولية (Migration) تحدث عندما:",
            "options": ["يتبخر النفط", "ينتقل النفط من الصخر المصدر إلى المكمن", "يختلط النفط بالماء", "يتأكسد النفط"],
            "answer": "ينتقل النفط من الصخر المصدر إلى المكمن",
            "explanation": "الهجرة البترولية هي عملية انتقال النفط والغاز من الصخور المصدرية إلى الصخور الخازنة حيث يتجمع في المكامن."
        },
        {
            "id": 16,
            "topic": "الجيولوجيا البترولية",
            "question": "الجيولوجيا التركيبية مهمة في دراسة النفط لأنها:",
            "options": ["تحدد مواقع الصدوع والطيات التي تشكل المصائد", "تحدد نوع الصخور فقط", "تقيس عمر الصخور", "تحدد عمق المياه"],
            "answer": "تحدد مواقع الصدوع والطيات التي تشكل المصائد",
            "explanation": "تساعد الجيولوجيا التركيبية في تحديد التراكيب الجيولوجية التي تشكل مصائد النفط مثل الطيات المحدبة والصدوع."
        },
        {
            "id": 17,
            "topic": "الجيولوجيا البترولية",
            "question": "المسامية العالية تعني:",
            "options": ["كمية كبيرة من الفتحات داخل الصخر", "كثافة عالية للصخر", "صلابة الصخر", "انخفاض النفاذية"],
            "answer": "كمية كبيرة من الفتحات داخل الصخر",
            "explanation": "المسامية العالية تعني أن الصخر يحتوي على نسبة عالية من الفراغات، مما يزيد من قدرته على تخزين السوائل."
        },
        {
            "id": 18,
            "topic": "الجيولوجيا البترولية",
            "question": "أهم الصخور المصدرية للنفط عادة هي:",
            "options": ["الطفل الغني بالمواد العضوية", "الحجر الرملي", "الحجر الجيري", "البازلت"],
            "answer": "الطفل الغني بالمواد العضوية",
            "explanation": "الصخور الطينية الغنية بالمواد العضوية (مثل الطفل الأسود) هي أهم الصخور المصدرية للنفط."
        },
        {
            "id": 19,
            "topic": "الجيولوجيا البترولية",
            "question": "السجلات البئرية (Well Logs) تستخدم في:",
            "options": ["دراسة سطح الأرض", "تحديد الطبقات الحاملة للنفط", "قياس الضغط الجوي", "تحليل المعادن"],
            "answer": "تحديد الطبقات الحاملة للنفط",
            "explanation": "السجلات البئرية تسجل الخصائص الفيزيائية للطبقات الصخرية في البئر، وتساعد في تحديد الطبقات الحاملة للنفط."
        },
        {
            "id": 20,
            "topic": "الجيولوجيا البترولية",
            "question": "المنطقة التي يختلط فيها النفط بالماء تعرف بـ:",
            "options": ["Oil-Water Contact", "Gas Cap", "Oil Zone", "Aquifer Base"],
            "answer": "Oil-Water Contact",
            "explanation": "Oil-Water Contact هي السطح الفاصل بين منطقة النفط ومنطقة الماء في المكمن البترولي."
        },
        {
            "id": 21,
            "topic": "الجيولوجيا البترولية",
            "question": "الضغط داخل المكمن يُحافظ عليه بواسطة:",
            "options": ["الغاز والماء المحيط", "الصخور النارية", "الطبقات السطحية", "الغازات الجوية"],
            "answer": "الغاز والماء المحيط",
            "explanation": "يتم الحفاظ على الضغط داخل المكمن بواسطة عمود الماء في المنطقة المحيطة وضغط الغاز في القبة الغازية."
        },
        {
            "id": 22,
            "topic": "الجيولوجيا البترولية",
            "question": "الغاز المصاحب يوجد عادة:",
            "options": ["فوق النفط في المكمن", "تحت النفط", "في الصخر المصدر", "في الطبقة الغطائية"],
            "answer": "فوق النفط في المكمن",
            "explanation": "الغاز المصاحب، بسبب كثافته المنخفضة، يتجمع فوق النفط في المكمن مكونًا ما يعرف بالغاز المصاحب أو القبة الغازية."
        },
        {
            "id": 23,
            "topic": "الجيولوجيا البترولية",
            "question": "الحفر المائل يستخدم من أجل:",
            "options": ["تقليل التكلفة", "الوصول إلى المصائد الجانبية", "قياس الضغط فقط", "الحفر في مناطق جبلية"],
            "answer": "الوصول إلى المصائد الجانبية",
            "explanation": "يستخدم الحفر المائل (Directional Drilling) للوصول إلى المصائد البترولية التي لا يمكن الوصول إليها بالحفر الرأسي."
        },
        {
            "id": 24,
            "topic": "الجيولوجيا البترولية",
            "question": "من الأدلة على وجود النفط في منطقة ما:",
            "options": ["تسربات نفطية سطحية", "الصخور النارية", "وجود الفحم", "وجود الذهب"],
            "answer": "تسربات نفطية سطحية",
            "explanation": "التسربات النفطية السطحية (Oil Seeps) من أهم الأدلة المباشرة على وجود النفط في المنطقة."
        },
        {
            "id": 25,
            "topic": "الجيولوجيا البترولية",
            "question": "أهم مناطق إنتاج النفط في العالم تقع في:",
            "options": ["الصحراء الكبرى", "الشرق الأوسط", "أوروبا", "أمريكا الجنوبية"],
            "answer": "الشرق الأوسط",
            "explanation": "يتركز حوالي 50% من احتياطي النفط العالمي في منطقة الشرق الأوسط، خاصة في السعودية والعراق والإمارات والكويت."
        }
    ],
    // ===================================
    // الأقسام الجديدة مع أسئلة اختبارية
    // ===================================
    "sedimentary-geology": [
        {
            "id": 1,
            "question": "العامل الذي يؤدي إلى دمج وتصلب الرواسب لتصبح صخرًا رسوبيًا يُسمى:",
            "options": ["التجوية", "التآكل", "التصخر (Lithification)", "الانصهار"],
            "answer": "التصخر (Lithification)",
            "explanation": "التصخر يشمل عمليتي التراص (Compaction) والتلاحم (Cementation)، ويحول الرواسب المفككة إلى صخور صلبة."
        },
        {
            "id": 2,
            "question": "الحجر الجيري هو صخر رسوبي يتكون أساسًا من معدن:",
            "options": ["الكوارتز", "الكالسيت", "الجبس", "الهاليت"],
            "answer": "الكالسيت",
            "explanation": "يتكون الحجر الجيري بشكل رئيسي من كربونات الكالسيوم، والتي تشكل معدن الكالسيت."
        },
        {
            "id": 3,
            "question": "أصغر حجم حبيبات في الصخور الرسوبية الفتاتية هو:",
            "options": ["الرمل", "الحصى", "الطين", "الطمي"],
            "answer": "الطين",
            "explanation": "حجم حبيبات الطين هو الأقل من 1/256 ملم، يليه الطمي ثم الرمل."
        },
        {
            "id": 4,
            "question": "وجود علامات التموج (Ripple Marks) في الصخر يدل على بيئة:",
            "options": ["عميقة وساكنة", "وجود تيارات ماء أو رياح", "بركانية", "متحولة"],
            "answer": "وجود تيارات ماء أو رياح",
            "explanation": "تتشكل علامات التموج بفعل حركة الماء أو الرياح على سطح الرواسب."
        },
        {
            "id": 5,
            "question": "أي مما يلي يُعد بيئة ترسيب بحرية ضحلة (Shallow Marine)؟",
            "options": ["الأنهار", "الكثبان الرملية", "الأرفف القارية", "المراوح الغرينية"],
            "answer": "الأرفف القارية",
            "explanation": "الأرفف القارية هي مناطق واسعة منخفضة العمق، وتُعد بيئة مثالية لترسيب الحجر الجيري."
        }
    ], 
    "geochemistry": [
        {
            "id": 1,
            "question": "العنصر الأكثر وفرة بالوزن في القشرة الأرضية هو:",
            "options": ["السيليكون", "الأكسجين", "الألمنيوم", "الحديد"],
            "answer": "الأكسجين",
            "explanation": "يشكل الأكسجين حوالي 46.6% من وزن القشرة الأرضية، كونه المكون الرئيسي لمعادن السيليكات."
        },
        {
            "id": 2,
            "question": "ما هو الاسم الكيميائي للكوارتز؟",
            "options": ["كربونات الكالسيوم", "ثاني أكسيد السيليكون", "أكسيد الحديد", "هيدروكسيد الألومنيوم"],
            "answer": "ثاني أكسيد السيليكون",
            "explanation": "الصيغة الكيميائية للكوارتز هي $SiO_2$ (ثاني أكسيد السيليكون)."
        },
        {
            "id": 3,
            "question": "اللون الأحمر في الصخور الرسوبية عادة ما يشير إلى بيئة غنية بـ:",
            "options": ["الكربون العضوي", "الحديد المؤكسد (الهيماتيت)", "الكبريت", "الكالسيت"],
            "answer": "الحديد المؤكسد (الهيماتيت)",
            "explanation": "الأكاسيد الحديدية (خاصة الهيماتيت) تتشكل في بيئات مؤكسدة وتعطي الصخور لونًا أحمر أو بنيًا."
        },
        {
            "id": 4,
            "question": "المعادن التي تتشكل من عملية التجوية الكيميائية تُسمى معادن:",
            "options": ["أولية", "ثانوية", "بركانية", "نادرة"],
            "answer": "ثانوية",
            "explanation": "تتشكل المعادن الثانوية (مثل معادن الطين) من تفاعلات كيميائية لمعادن أصلية (أولية) مع الماء والأحماض."
        },
        {
            "id": 5,
            "question": "ماذا تعني قيمة pH أقل من 7 في المياه الجوفية؟",
            "options": ["وسط قلوي", "وسط حمضي", "وسط متعادل", "وسط مالح"],
            "answer": "وسط حمضي",
            "explanation": "قيمة pH أقل من 7 تدل على أن الوسط حمضي، مما يزيد من قدرة الماء على إذابة المعادن."
        }
    ],
    "structural-geology": [
        {
            "id": 1,
            "question": "الفالق العادي (Normal Fault) ينتج بشكل أساسي عن قوى:",
            "options": ["ضغط (Compression)", "شد (Tension)", "قص (Shear)", "التواء"],
            "answer": "شد (Tension)",
            "explanation": "تحدث فوالق الشد (العادية) عندما تتعرض القشرة الأرضية لقوى شد تسحب الكتلتين بعيدًا عن بعضهما."
        },
        {
            "id": 2,
            "question": "في الطية المحدبة (Anticline)، تكون أقدم الطبقات موجودة في:",
            "options": ["الحائط المعلق", "مركز الطية", "جناحي الطية", "مستوى التصدع"],
            "answer": "مركز الطية",
            "explanation": "تتميز الطية المحدبة بأن الطبقات الأقدم تقع في المركز وتحيط بها الطبقات الأحدث."
        },
        {
            "id": 3,
            "question": "زاوية ميل الطبقة عن المستوى الأفقي تسمى:",
            "options": ["الاتجاه (Strike)", "الميل (Dip)", "القص", "التحول"],
            "answer": "الميل (Dip)",
            "explanation": "الميل هو الزاوية بين سطح الطبقة والمستوى الأفقي، ويُقاس عموديًا على الاتجاه."
        },
        {
            "id": 4,
            "question": "الهياكل الجيولوجية التي تتشكل نتيجة التشوه اللدن (Ductile Deformation) هي:",
            "options": ["الفوالق", "الصدوع", "الطيات", "التصدعات"],
            "answer": "الطيات",
            "explanation": "تتكون الطيات (Folds) نتيجة التشوه اللدن الذي يحدث تحت درجات حرارة وضغوط عالية، على عكس الفوالق التي تحدث بالتشوه الهش."
        },
        {
            "id": 5,
            "question": "الفالق الذي ينخفض فيه الحائط المعلق بالنسبة للحائط السفلي يُسمى:",
            "options": ["فالق عادي", "فالق عكسي", "فالق انزلاق جانبي", "طية مقعرة"],
            "answer": "فالق عادي",
            "explanation": "يحدث الفالق العادي نتيجة الشد، حيث يتحرك الحائط المعلق إلى الأسفل بالنسبة للحائط السفلي."
        }
    ],
    "geophysics": [
        {
            "id": 1,
            "question": "الجيوفيزياء تدرس الخصائص... للأرض والصخور.",
            "options": ["الكيميائية", "الفيزيائية", "البيولوجية", "التاريخية"],
            "answer": "الفيزيائية",
            "explanation": "تهتم الجيوفيزياء بقياس الخصائص الفيزيائية مثل الكثافة، المغناطيسية، والسرعة الزلزالية لاستكشاف باطن الأرض."
        },
        {
            "id": 2,
            "question": "أهم طريقة جيوفيزيائية لتحديد التراكيب البترولية قبل الحفر هي:",
            "options": ["المسح المغناطيسي", "الجاذبية", "القياسات الكهربائية", "المسح الزلزالي (Seismic)"],
            "answer": "المسح الزلزالي (Seismic)",
            "explanation": "يوفر المسح الزلزالي أدق صور لطبقات باطن الأرض والتراكيب الجيولوجية الضرورية لاكتشاف النفط والغاز."
        },
        {
            "id": 3,
            "question": "الموجة الزلزالية التي لا تنتقل عبر السوائل (الماء أو الماغما) هي موجة:",
            "options": ["P-Wave", "S-Wave", "Surface Wave", "Sound Wave"],
            "answer": "S-Wave",
            "explanation": "موجات S (موجات القص) هي موجات ميكانيكية لا يمكنها الانتشار إلا في الأوساط الصلبة، على عكس موجات P التي تنتقل في جميع الأوساط."
        },
        {
            "id": 4,
            "question": "تقنية الجاذبية تُستخدم في الجيوفيزياء لكشف التغيرات في:",
            "options": ["درجة الحرارة", "المقاومة الكهربائية", "الكثافة الصخرية", "النشاط الزلزالي"],
            "answer": "الكثافة الصخرية",
            "explanation": "تعتمد طريقة الجاذبية على قياس التغيرات في مجال جاذبية الأرض الناتجة عن تباين كثافات الصخور تحت السطح."
        },
        {
            "id": 5,
            "question": "يتم استخدام سجل الكثافة (Density Log) لتحديد خاصية الصخر التالية:",
            "options": ["المقاومة الكهربائية", "المسامية", "المحتوى الطيني", "درجة الحرارة"],
            "answer": "المسامية",
            "explanation": "يُستخدم سجل الكثافة لتقدير مسامية الصخور الخازنة، حيث أن الكثافة المنخفضة تشير عادة إلى مسامية عالية."
        }
    ]
};

// حالة التطبيق
let appState = {
    currentSubject: null,
    currentQuestionIndex: 0,
    userAnswers: {},
    quizStarted: false,
    quizCompleted: false,
    score: 0,
    currentStreak: 0,
    bestStreak: 0,
    timeLeft: 20, // 20 ثانية لكل سؤال
    timerInterval: null,
    currentQuestions: [], // الأسئلة العشوائية
    progress: {
        'basic-geology': 0,
        'hydrogeology': 0,
        'petrology': 0,
        'sedimentary-geology': 0,
        'geochemistry': 0,
        'structural-geology': 0,
        'geophysics': 0
    }
};

// عناصر DOM
const elements = {
    loadingScreen: document.getElementById('loading-screen'),
    mainApp: document.getElementById('main-app'),
    subjectSelection: document.getElementById('subject-selection'),
    quizSection: document.getElementById('quiz-section'),
    resultsSection: document.getElementById('results-section'),
    confirmationModal: document.getElementById('confirmation-modal')
};

// =======================================================
// وظائف تشغيل الأصوات 🎵
// =======================================================
// يجب التأكد من وجود هذه الملفات في مسار 'sounds/'
const correctSound = new Audio('sounds/correct.mp3');
const wrongSound = new Audio('sounds/wrong.mp3');
const timeoutSound = new Audio('sounds/timeout.mp3');

function playCorrect() { 
    if (!correctSound.paused) {
        correctSound.pause();
        correctSound.currentTime = 0;
    }
    correctSound.play(); 
}
function playWrong() { 
    if (!wrongSound.paused) {
        wrongSound.pause();
        wrongSound.currentTime = 0;
    }
    wrongSound.play(); 
}
function playTimeout() { 
    if (!timeoutSound.paused) {
        timeoutSound.pause();
        timeoutSound.currentTime = 0;
    }
    timeoutSound.play(); 
}
// =======================================================


// تهيئة التطبيق
function initApp() {
    // محاكاة تحميل البيانات
    setTimeout(() => {
        elements.loadingScreen.classList.add('hidden');
        elements.mainApp.classList.remove('hidden');
        loadUserProgress();
        setupEventListeners();
        updateUI();
    }, 2000);
}

// تحميل تقدم المستخدم
function loadUserProgress() {
    const savedProgress = localStorage.getItem('geologyTrainingProgress');
    if (savedProgress) {
        const progress = JSON.parse(savedProgress);
        // دمج التقدم المحفوظ مع التقدم الحالي (لإضافة الأقسام الجديدة)
        appState.progress = { ...appState.progress, ...progress.progress };
        appState.bestStreak = progress.bestStreak || 0;
    }
    updateProgressBars();
}

// حفظ تقدم المستخدم
function saveUserProgress() {
    const progressData = {
        progress: appState.progress,
        bestStreak: appState.bestStreak,
        lastUpdated: new Date().toISOString()
    };
    localStorage.setItem('geologyTrainingProgress', JSON.stringify(progressData));
}

// إعداد مستمعي الأحداث
function setupEventListeners() {
    // أزرار بدء التدريب
    document.querySelectorAll('.start-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const subjectCard = e.target.closest('.subject-card');
            const subject = subjectCard.dataset.subject;
            
            if (questionsData[subject] && questionsData[subject].length > 0) {
                startQuiz(subject);
            } else {
                alert('عفواً، لا توجد أسئلة متوفرة لهذا القسم بعد.');
            }
        });
    });

    // أزرار التحكم في الاختبار
    document.getElementById('exit-quiz').addEventListener('click', showExitConfirmation);
    document.getElementById('prev-btn').addEventListener('click', prevQuestion);
    document.getElementById('next-btn').addEventListener('click', nextQuestion);
    document.getElementById('submit-btn').addEventListener('click', submitAnswer);

    // أزرار النتائج
    document.getElementById('review-btn').addEventListener('click', reviewAnswers);
    document.getElementById('new-quiz-btn').addEventListener('click', newQuiz);

    // النافذة المنبثقة
    document.getElementById('cancel-exit').addEventListener('click', hideModal);
    document.getElementById('confirm-exit').addEventListener('click', exitQuiz);
    document.querySelector('.modal-close').addEventListener('click', hideModal);

    // إغلاق النافذة المنبثقة بالنقر خارجها
    elements.confirmationModal.addEventListener('click', (e) => {
        if (e.target === elements.confirmationModal) {
            hideModal();
        }
    });
}

// تحديث واجهة المستخدم
function updateUI() {
    updateProgressBars();
}

// تحديث أشرطة التقدم
function updateProgressBars() {
    const subjects = Object.keys(appState.progress);
    subjects.forEach(subject => {
        // نستخدم تبديل لأسماء الـ IDs الطويلة لتتوافق مع HTML
        let progressId = subject;
        if (subject === 'basic-geology') progressId = 'basic';
        else if (subject === 'hydrogeology') progressId = 'hydro';
        else if (subject === 'petrology') progressId = 'petro';
        
        // الأقسام الجديدة تستخدم الاسم كاملاً كـ ID
        
        const progressFill = document.getElementById(`${progressId}-progress`);
        
        if (progressFill) {
            progressFill.style.width = `${appState.progress[subject]}%`;
            const progressTextElement = progressFill.closest('.subject-progress').querySelector('.progress-text');
            if(progressTextElement) {
                progressTextElement.textContent = `${Math.round(appState.progress[subject])}% مكتمل`;
            }
        }
    });
}

// بدء الاختبار
function startQuiz(subject) {
    // إيقاف أي مؤقت سابق قبل بدء اختبار جديد
    clearInterval(appState.timerInterval); 
    
    appState.currentSubject = subject;
    appState.currentQuestionIndex = 0;
    appState.userAnswers = {};
    appState.quizStarted = true;
    appState.quizCompleted = false;
    appState.score = 0;
    appState.currentStreak = 0;
    appState.timeLeft = 20;

    // توليد أسئلة عشوائية
    generateRandomQuestions();

    // تبديل الأقسام
    elements.subjectSelection.classList.add('hidden');
    elements.quizSection.classList.remove('hidden');
    elements.resultsSection.classList.add('hidden');

    // تحديث واجهة الاختبار
    updateQuizUI();
    
    // تحميل السؤال الأول وبدء المؤقت
    loadQuestion();
}

// توليد أسئلة عشوائية
function generateRandomQuestions() {
    const allQuestions = [...questionsData[appState.currentSubject]];
    appState.currentQuestions = [];
    
    // اختيار 25 سؤال عشوائي
    const maxQuestions = Math.min(25, allQuestions.length);
    for (let i = 0; i < maxQuestions; i++) {
        const randomIndex = Math.floor(Math.random() * allQuestions.length);
        appState.currentQuestions.push(allQuestions[randomIndex]);
        allQuestions.splice(randomIndex, 1);
    }
}

// تحديث واجهة الاختبار
function updateQuizUI() {
    const subjectNames = {
        'basic-geology': 'الجيولوجيا الأساسية',
        'hydrogeology': 'الهيدروجيولوجيا',
        'petrology': 'الجيولوجيا البترولية',
        'sedimentary-geology': 'الجيولوجيا الرسوبية',
        'geochemistry': 'الجيوكيمياء',
        'structural-geology': 'الجيولوجيا التركيبية',
        'geophysics': 'الجيوفيزياء'
    };

    document.getElementById('current-subject').textContent = subjectNames[appState.currentSubject];
    document.getElementById('streak-counter').textContent = `${appState.currentStreak} تتابع`;
}

// تحميل السؤال
function loadQuestion() {
    // إيقاف أي مؤقت سابق لضمان عدم تداخل المؤقتات
    clearInterval(appState.timerInterval); 
    
    const currentQuestion = appState.currentQuestions[appState.currentQuestionIndex];

    if (!currentQuestion) return;

    // إعادة تعيين المؤقت وبدء عد جديد
    appState.timeLeft = 20;
    updateTimerDisplay();
    startTimer(); // إعادة بدء المؤقت لكل سؤال جديد

    // تحديث العداد
    document.getElementById('current-q-number').textContent = appState.currentQuestionIndex + 1;

    // تحديث نص السؤال
    document.getElementById('question-text').textContent = currentQuestion.question;

    // تحديث الخيارات
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';

    const optionLetters = ['أ', 'ب', 'ج', 'د'];
    currentQuestion.options.forEach((option, index) => {
        const optionElement = document.createElement('div');
        optionElement.className = 'option';
        
        optionElement.classList.remove('selected', 'correct', 'incorrect');
        
        if (appState.userAnswers[appState.currentQuestionIndex] === index) {
            optionElement.classList.add('selected');
        }

        optionElement.innerHTML = `
            <div class="option-letter">${optionLetters[index]}</div>
            <div class="option-text">${option}</div>
        `;

        // إزالة مؤقتة لـ pointerEvents في وضع الاختبار
        optionElement.style.pointerEvents = 'auto'; 

        optionElement.addEventListener('click', () => selectOption(index));
        optionsContainer.appendChild(optionElement);
    });

    // تحديث أزرار التحكم
    updateQuizControls();
    updateProgressBar();
    
    // إعادة تمكين الأزرار
    document.getElementById('prev-btn').disabled = appState.currentQuestionIndex === 0;
    document.getElementById('next-btn').disabled = appState.currentQuestionIndex === appState.currentQuestions.length - 1;
    document.getElementById('submit-btn').disabled = (appState.userAnswers[appState.currentQuestionIndex] === undefined);
    
    // إخفاء الشرح عند تحميل سؤال جديد
    document.getElementById('explanation-box').classList.add('hidden');
}

// اختيار خيار
function selectOption(optionIndex) {
    document.querySelectorAll('.option').forEach(option => {
        option.classList.remove('selected');
    });

    const selectedOption = document.querySelectorAll('.option')[optionIndex];
    selectedOption.classList.add('selected');

    appState.userAnswers[appState.currentQuestionIndex] = optionIndex;

    // تحديث زر التأكيد
    document.getElementById('submit-btn').classList.remove('hidden');
    document.getElementById('submit-btn').disabled = false;
    
    updateQuizControls();
}

// تحديث أزرار التحكم
function updateQuizControls() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');

    prevBtn.disabled = appState.currentQuestionIndex === 0;

    // التعامل مع زر التالي/إنهاء الاختبار
    if (appState.currentQuestionIndex === appState.currentQuestions.length - 1) {
        nextBtn.classList.add('hidden');
        if (appState.userAnswers[appState.currentQuestionIndex] !== undefined) {
            submitBtn.classList.remove('hidden');
            submitBtn.innerHTML = '<i class="fas fa-flag-checkered"></i> إنهاء الاختبار';
        }
    } else {
        nextBtn.classList.remove('hidden');
        submitBtn.classList.add('hidden');
        submitBtn.innerHTML = '<i class="fas fa-check"></i> تأكيد الإجابة';
    }
}

// تحديث شريط التقدم
function updateProgressBar() {
    const progress = ((appState.currentQuestionIndex + 1) / appState.currentQuestions.length) * 100;
    
    document.getElementById('quiz-progress').style.width = `${progress}%`;
    document.getElementById('progress-percent').textContent = `${Math.round(progress)}%`;
}

// السؤال السابق
function prevQuestion() {
    if (appState.currentQuestionIndex > 0) {
        appState.currentQuestionIndex--;
        loadQuestion();
    }
}

// السؤال التالي
function nextQuestion() {
    if (appState.currentQuestionIndex < appState.currentQuestions.length - 1) {
        appState.currentQuestionIndex++;
        loadQuestion();
    }
}

// تأكيد الإجابة (الخطوة 4) ✅
function submitAnswer() {
    // إيقاف المؤقت عند تأكيد الإجابة لمنع الانتقال التلقائي
    clearInterval(appState.timerInterval);
    
    const currentQuestion = appState.currentQuestions[appState.currentQuestionIndex];
    const userAnswerIndex = appState.userAnswers[appState.currentQuestionIndex];

    if (userAnswerIndex === undefined) return;

    const userAnswer = currentQuestion.options[userAnswerIndex];
    const isCorrect = userAnswer === currentQuestion.answer;

    // تحديث النتيجة
    if (isCorrect) {
        appState.score++;
        appState.currentStreak++;
        playCorrect(); // تشغيل صوت النجاح
        
        if (appState.currentStreak > appState.bestStreak) {
            appState.bestStreak = appState.currentStreak;
        }
    } else {
        appState.currentStreak = 0;
        playWrong(); // تشغيل صوت الخطأ
    }

    // عرض التغذية الراجعة
    showAnswerFeedback(isCorrect, currentQuestion.explanation);

    // تحديث العداد
    document.getElementById('streak-counter').textContent = `${appState.currentStreak} تتابع`;

    // الانتقال التلقائي أو إنهاء الاختبار بعد 3 ثواني
    setTimeout(() => {
        if (appState.currentQuestionIndex < appState.currentQuestions.length - 1) {
            appState.currentQuestionIndex++;
            loadQuestion();
        } else {
            finishQuiz();
        }
    }, 3000);
}

// عرض التغذية الراجعة
function showAnswerFeedback(isCorrect, explanation) {
    const options = document.querySelectorAll('.option');
    const currentQuestion = appState.currentQuestions[appState.currentQuestionIndex];
    
    options.forEach((option, index) => {
        const optionText = option.querySelector('.option-text').textContent;
        
        // إزالة التحديد قبل إضافة الألوان
        option.classList.remove('selected'); 
        
        if (optionText === currentQuestion.answer) {
            option.classList.add('correct'); // الإجابة الصحيحة
        } else if (index === appState.userAnswers[appState.currentQuestionIndex] && !isCorrect) {
            option.classList.add('incorrect'); // الإجابة الخاطئة للمستخدم
        }
        
        // منع اختيار أي خيار أثناء عرض الشرح
        option.style.pointerEvents = 'none';
    });

    // عرض الشرح
    const explanationBox = document.getElementById('explanation-box');
    const explanationText = document.getElementById('explanation-text');
    
    explanationText.textContent = explanation;
    explanationBox.classList.remove('hidden');

    // تعطيل الأزرار مؤقتًا
    document.getElementById('prev-btn').disabled = true;
    document.getElementById('next-btn').disabled = true;
    document.getElementById('submit-btn').disabled = true;
}

// المؤقت
function startTimer() {
    updateTimerDisplay();
    
    appState.timerInterval = setInterval(() => {
        appState.timeLeft--;
        updateTimerDisplay();
        
        if (appState.timeLeft <= 0) {
            // ===================================
            // انتهاء الوقت (الخطوة 5) ⏰
            // ===================================
            clearInterval(appState.timerInterval);
            playTimeout(); // تشغيل صوت انتهاء الوقت
            // ===================================

            // إذا انتهى الوقت ولم يجب المستخدم، يعتبر السؤال خاطئًا
            appState.currentStreak = 0;
            document.getElementById('streak-counter').textContent = `${appState.currentStreak} تتابع`;
            
            // تحديث الإجابة على أنها غير موجودة لعرض التغذية الراجعة
            const currentQuestion = appState.currentQuestions[appState.currentQuestionIndex];
            
            // عرض التغذية الراجعة (للتأكد من رؤية الإجابة الصحيحة)
            showTimeoutFeedback(currentQuestion.explanation);


            // الانتقال التلقائي للسؤال التالي بعد مهلة 3 ثواني
            setTimeout(() => {
                if (appState.currentQuestionIndex < appState.currentQuestions.length - 1) {
                    appState.currentQuestionIndex++;
                    loadQuestion();
                } else {
                    finishQuiz();
                }
            }, 3000);
        }
    }, 1000);
}

// وظيفة لإظهار تغذية راجعة لانتهاء الوقت
function showTimeoutFeedback(explanation) {
    const options = document.querySelectorAll('.option');
    const currentQuestion = appState.currentQuestions[appState.currentQuestionIndex];
    
    options.forEach(option => {
        option.classList.remove('selected'); 
        option.style.pointerEvents = 'none';
        
        // تمييز الإجابة الصحيحة
        const optionText = option.querySelector('.option-text').textContent;
        if (optionText === currentQuestion.answer) {
            option.classList.add('correct'); 
        } else {
             // إظهار الخيار الذي اختاره المستخدم باللون الأحمر إن وجد
             const userSelectedIndex = appState.userAnswers[appState.currentQuestionIndex];
             if (userSelectedIndex !== undefined && options[userSelectedIndex] === option) {
                 option.classList.add('incorrect');
             }
        }
    });

    const explanationBox = document.getElementById('explanation-box');
    const explanationText = document.getElementById('explanation-text');
    
    explanationText.textContent = `انتهى الوقت! الإجابة الصحيحة هي: ${currentQuestion.answer}. ${explanation}`;
    explanationBox.classList.remove('hidden');
    
    // تعطيل الأزرار مؤقتًا
    document.getElementById('prev-btn').disabled = true;
    document.getElementById('next-btn').disabled = true;
    document.getElementById('submit-btn').disabled = true;
}

function updateTimerDisplay() {
    const timerElement = document.getElementById('timer');
    timerElement.textContent = appState.timeLeft;
    
    // تغيير اللون عند اقتراب انتهاء الوقت
    if (appState.timeLeft <= 5) {
        timerElement.classList.add('danger');
        timerElement.classList.remove('warning');
    } else if (appState.timeLeft <= 10) {
        timerElement.classList.add('warning');
        timerElement.classList.remove('danger');
    } else {
        timerElement.classList.remove('warning', 'danger');
    }
}

// إنهاء الاختبار
function finishQuiz() {
    clearInterval(appState.timerInterval);
    appState.quizCompleted = true;

    // تحديث التقدم
    const scorePercentage = (appState.score / appState.currentQuestions.length) * 100;
    appState.progress[appState.currentSubject] = Math.max(
        appState.progress[appState.currentSubject],
        scorePercentage
    );

    // حفظ التقدم
    saveUserProgress();

    // عرض النتائج
    showResults();
}

// عرض النتائج
function showResults() {
    elements.quizSection.classList.add('hidden');
    elements.resultsSection.classList.remove('hidden');

    const scorePercentage = Math.round((appState.score / appState.currentQuestions.length) * 100);

    // تحديث النتائج
    document.getElementById('results-subject').textContent = 
        document.getElementById('current-subject').textContent;
    
    document.getElementById('score-percentage').textContent = `${scorePercentage}%`;
    document.getElementById('correct-answers').textContent = appState.score;
    document.getElementById('total-questions').textContent = appState.currentQuestions.length;
    document.getElementById('best-streak').textContent = appState.bestStreak;

    // تحديث دائرة النتيجة
    const scoreCircle = document.querySelector('.score-circle');
    scoreCircle.style.setProperty('--p', `${scorePercentage}%`);

    // تحديث الإنجازات
    updateAchievements(scorePercentage);
}

// تحديث الإنجازات
function updateAchievements(scorePercentage) {
    const achievementsContainer = document.getElementById('achievements-container');
    achievementsContainer.innerHTML = '';

    const achievements = [];

    if (scorePercentage >= 90) {
        achievements.push({
            icon: 'fas fa-crown',
            title: 'خبير الجيولوجيا',
            description: 'تفوق متميز!'
        });
    }

    if (scorePercentage >= 80) {
        achievements.push({
            icon: 'fas fa-medal',
            title: 'متفوق',
            description: 'أداء رائع!'
        });
    }

    if (scorePercentage >= 70) {
        achievements.push({
            icon: 'fas fa-award',
            title: 'متميز',
            description: 'أداء جيد جدًا'
        });
    }

    if (appState.currentStreak >= 5) {
        achievements.push({
            icon: 'fas fa-bolt',
            title: 'متسلسل',
            description: `${appState.currentStreak} إجابات صحيحة متتالية`
        });
    }

    if (scorePercentage === 100) {
        achievements.push({
            icon: 'fas fa-star',
            title: 'مثالي',
            description: 'إجابات صحيحة كاملة!'
        });
    }

    // إذا لم تكن هناك إنجازات، إضافة إنجاز تشجيعي
    if (achievements.length === 0) {
        achievements.push({
            icon: 'fas fa-seedling',
            title: 'مبتدئ واعد',
            description: 'استمر في التعلم!'
        });
    }

    achievements.forEach(achievement => {
        const achievementElement = document.createElement('div');
        achievementElement.className = 'achievement unlocked';
        achievementElement.innerHTML = `
            <i class="${achievement.icon}"></i>
            <h4>${achievement.title}</h4>
            <p>${achievement.description}</p>
        `;
        achievementsContainer.appendChild(achievementElement);
    });
}

// النافذة المنبثقة للخروج
function showExitConfirmation() {
    clearInterval(appState.timerInterval); // إيقاف المؤقت عند ظهور النافذة
    elements.confirmationModal.classList.remove('hidden');
}

function hideModal() {
    elements.confirmationModal.classList.add('hidden');
    // استئناف المؤقت بعد إغلاق النافذة
    if (appState.quizStarted && !appState.quizCompleted) {
        startTimer();
    }
}

function exitQuiz() {
    clearInterval(appState.timerInterval);
    hideModal();
    
    elements.quizSection.classList.add('hidden');
    elements.subjectSelection.classList.remove('hidden');
    
    appState.quizStarted = false;
    updateUI();
}

// وظائف النتائج
function reviewAnswers() {
    appState.currentQuestionIndex = 0;
    elements.resultsSection.classList.add('hidden');
    elements.quizSection.classList.remove('hidden');
    
    clearInterval(appState.timerInterval);
    
    loadQuestion();
    
    // عرض التغذية الراجعة للإجابة المختارة في السؤال الأول
    const currentAnswerIndex = appState.userAnswers[0];
    const isCorrect = currentAnswerIndex !== undefined && appState.currentQuestions[0].options[currentAnswerIndex] === appState.currentQuestions[0].answer;
    showAnswerFeedback(isCorrect, appState.currentQuestions[0].explanation);
    
    document.getElementById('submit-btn').classList.add('hidden');
    document.getElementById('next-btn').classList.remove('hidden');
}

function newQuiz() {
    elements.resultsSection.classList.add('hidden');
    elements.subjectSelection.classList.remove('hidden');
    updateUI();
}

// بدء التطبيق
document.addEventListener('DOMContentLoaded', initApp);
